import{_ as G}from"./CXAJefOs.js";import{h as w,_ as M,u as H}from"./BQaFixBN.js";import{_ as O}from"./DcLHZll-.js";import{_ as W}from"./C2vHB1V7.js";import{f as D,q as T,r as $,i as K,o as f,j as C,w as c,k as v,c as S,b as i,a as n,d as g,t as E,m as I,W as Y,$ as V,T as J,F as Q,A as X,C as Z,g as q,h as ee,z as te,M as oe,ae as se,O as ne}from"./Dfk_Fzw6.js";import{s as l,o as ae,d as ie,a as B}from"./BHA4Nd6Z.js";import{_ as F}from"./BRMwARTk.js";import{_ as ce}from"./B_hX8Ya9.js";import{_ as re}from"./CvmE4Bnd.js";import{a as U}from"./R5p0mRuj.js";import{u as _e}from"./7UWFdEo2.js";import{u as le}from"./ew24QEYm.js";import{u as ue}from"./Dwwx9l0Y.js";import"./BMjfXaaq.js";import"./BxBPJGBn.js";import"./DQzVWw1H.js";const de={key:0,class:"update-message"},pe={class:"update-message__title"},fe=n("div",{class:"update-message__body"}," Что бы изменения вступили в силу, необходимо обновить страницу. ",-1),me={class:"update-message__control"},ge=D({__name:"UpdateMessage",setup(N){T(()=>{d()});const u=$(!1),r=$(null),s=V(),h=K(()=>{const m=s.public.clientVersion;return!r.value||!m||u.value?!1:r.value!==m});function d(){const m=l.firebase.db();ae(ie(m,"app","info"),_=>{const p=_.data();r.value=(p==null?void 0:p.version)??null},_=>{w(_,{title:"Получение данных версии из Firebase"})})}function o(){location.reload()}function a(){u.value=!0}return(m,_)=>{const p=M,y=O,R=W;return f(),C(Y,{name:"update-message-"},{default:c(()=>[v(h)?(f(),S("div",de,[i(R,{class:"update-message__inner"},{default:c(()=>[n("div",pe,[i(p,{class:"update-message__icon",name:"new-releases"}),g(" Обновление v"+E(v(r)),1)]),fe,n("div",me,[i(y,{class:"update-message__btn",onClick:o},{default:c(()=>[g(" Обновить ")]),_:1}),i(y,{class:"update-message__btn",onClick:a},{default:c(()=>[g(" Скрыть ")]),_:1})])]),_:1})])):I("",!0)]),_:1})}}}),he={class:"update-db-dialog__header"},ye=n("b",null,"База данных обновлена",-1),ke=n("br",null,null,-1),ve=n("br",null,null,-1),xe=n("br",null,null,-1),be=n("br",null,null,-1),Ue={style:{display:"flex","justify-content":"flex-end"}},we=D({__name:"UpdateDBDialog",emits:["confirm"],setup(N,{expose:u,emit:r}){const s=$(null),h=r;function d(){var a;(a=s.value)==null||a.doClose(),h("confirm")}function o(){var a;(a=s.value)==null||a.doOpen()}return u({open:o}),(a,m)=>{const _=M,p=O,y=F;return f(),C(y,{ref_key:"dialogRef",ref:s,class:"update-db-dialog","modal-enabled":"",width:"480px"},{title:c(()=>[n("div",he,[i(_,{class:"update-db-dialog__icon",name:"database-alert"}),ye])]),footer:c(()=>[n("div",Ue,[i(p,{onClick:d},{default:c(()=>[g(" Так точно ")]),_:1})])]),default:c(()=>[g(" Для продолжения использования необходимо: "),ke,g(" 1. Закрыть все вкладки ресурса, кроме активной."),ve,g(" 2. Обновить текущую страницу."),xe,g(" 3. Готово."),be]),_:1},512)}}}),Se={class:"ui-notification"},$e={key:0,class:"ui-notification__item-title"},Be={class:"ui-notification__item-body"},De=["onClick"],Ce=D({__name:"UiNotification",props:{appendToBody:{type:Boolean,default:!1}},setup(N){const u=H(),r=s=>{if(s.title)return s.title;switch(s.type){case"success":return"Успешно";case"error":return"Ошибка";case"info":return"Информация";case"warning":return"Внимание";default:return s.title}};return(s,h)=>{const d=re;return f(),C(d,null,{default:c(()=>[n("div",Se,[i(J,{tag:"ul",class:"ui-notification__list",name:"ui-notification__item-"},{default:c(()=>[(f(!0),S(Q,null,X(v(u).items,o=>(f(),S("li",{key:o.id,class:Z(["ui-notification__item",[o.type?"ui-notification__item--"+o.type:""]])},[o.title||o.type?(f(),S("div",$e,E(r(o)),1)):I("",!0),n("div",Be,E(o.message),1),n("button",{class:"ui-notification__item-close",onClick:a=>v(u).remove(o)},null,8,De)],2))),128))]),_:1})])]),_:1})}}}),Ne={class:"layout"},Ye=D({__name:"default",setup(N){const u=q(),r=ee(),s=ue(),h=_e(),d=le(),o=$(null),a=$(null);R(),L(),te(()=>u.fullPath,async(e,t)=>{e!==t&&(await P(),d.toggleMainSearch(!1))}),oe(()=>{var e,t;d.mainSearchOpened?(e=o.value)==null||e.doOpen():(t=o.value)==null||t.doClose()}),T(()=>{s.init();const e=l.storage.getUser();e&&h.setUser({accountId:Number(e.account_id),name:e.nickname})});function m(){U.auth.logout(),h.resetUser(),l.storage.removeUser(),location.assign("/")}B.request.onError=({error:e})=>{(e==null?void 0:e.message)==="INVALID_ACCESS_TOKEN"&&m()};let _=!1;async function p(){if(_)return;const e=l.storage.getUser();if(!e||Number.isNaN(+e.expires_at))return;const t=+e.expires_at*1e3,x=Date.now();if(!(t<=x)&&!(t-x>se)){_=!0;try{const k=x+ne*13,{data:b}=await B.auth.prolongate({expires_at:Math.round(k/1e3),access_token:e.access_token});l.storage.setUser({...e,access_token:b.access_token,expires_at:String(b.expires_at)}),U.auth.prolongate({id:e.account_id,expiresAt:new Date(k).toISOString(),token:b.access_token}).catch(A=>{w(A,{title:"Продление сессии авторизации"})})}catch(k){w(k,{title:"Продление сессии авторизации"})}_=!1}}B.request.beforeRequest=async e=>{e.method==="get"&&(e.params=e.params??{},e.params.access_token=l.storage.getAccessToken(),e.params.application_id=V().public.appId),e.url.includes("prolongate")||await p()};async function y(e){try{await U.auth.login({id:e.account_id,token:e.access_token,expiresAt:new Date(+e.expires_at*1e3).toISOString()}),await U.user.set({id:e.account_id,name:e.nickname})}catch(t){console.error(t),w(t,{title:"Авторизация"}),await B.auth.logout()}}function R(){const e=l.url.getUser();e&&(l.storage.setUser(e),r.replace("/"),y(e))}async function P(){const e=l.storage.getUser();if(e)try{await U.user.action({id:e.account_id})}catch(t){w(t,{title:"Действие пользователя",message:"[SELF API] "+(t instanceof Error?t.message:"Неизвестная ошибка")})}}async function L(){const e=await l.indexedDB.getInstance();e.onBlocked=()=>{var t;return(t=a.value)==null?void 0:t.open()}}return(e,t)=>{const x=G,k=ge,b=we,A=ce,j=F,z=Ce;return f(),S("div",Ne,[i(x),i(k),i(b,{ref_key:"updateDBRef",ref:a},null,512),v(s).isTablet?(f(),C(j,{key:0,ref_key:"searchDialogRef",ref:o,title:"Поиск аккаунтов и кланов",width:"480px",position:"top",onClose:t[0]||(t[0]=Re=>v(d).toggleMainSearch(!1))},{default:c(()=>[i(A,{style:{height:"270px"}})]),_:1},512)):I("",!0),i(z)])}}});export{Ye as default};
