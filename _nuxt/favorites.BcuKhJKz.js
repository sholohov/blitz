import{_ as V}from"./nuxt-link.CEOfUkt0.js";import{_ as q}from"./WinRate.vue.DiFcwfq2.js";import{_ as M}from"./RatingIcon.vue.EjjZvg7-.js";import{u as W,_ as G,a as H}from"./disableScroll.BUC5HZdp.js";import{_ as J}from"./TablePagination.vue.bq_TiTlK.js";import{_ as K}from"./CTable.vue.Cu8sf2MZ.js";import{_ as Q}from"./ContentLoader.vue.kCcbdDCf.js";import{n as b}from"./notEmpty.BxBPJGBn.js";import{f as U,n as C,q as X,i as Y,c as g,b as p,w as o,k as B,a as x,s as Z,o as l,j as v,d as m,t as y,F as I}from"./entry.FvyONZHj.js";import{s as T,a as A}from"./request.CuV_NRrd.js";import{s as F}from"./index.CPrYhzBm.js";const tt={class:"account-favorites"},at=x("div",{class:"account-favorites__description content-area",style:{"max-width":"800px"}},[x("p",null,' Список игроков добавленных в "Избранные". Данные хранится в браузере. '),x("p",null,'Добавить в избранное, можно нажав "Звёздочку" превью на странице аккаунта.')],-1),et={key:1},gt=U({__name:"favorites",setup(nt){const R=W(),i=C({loading:0,items:[],favoritesIds:null}),d=C({total:0,page:1,pageSize:100}),S=[{key:"nickname",label:"Ник"},{key:"clan",label:"Клан"},{key:"battles",label:"Боёв"},{key:"winRate",label:"Побед"},{key:"damagePerBattle",label:"Урон"},{key:"rating",label:"Рейтинг"},{key:"lastBattleTime",width:160,label:"Последний бой",formatter:t=>typeof t=="number"?Z.date.toRelativeTime(t*1e3):"---"},{key:"actions",width:60}];X(()=>{h()});const k=Y(()=>{const t=d.page*d.pageSize,n=t-d.pageSize;return(i.favoritesIds??[]).filter(b).slice(n,t)});async function $(){i.loading++;const t=await T.indexedDB.accountsFavorites.getAll();i.favoritesIds=(t??[]).filter(n=>n.isFavorite).map(n=>n.id),d.total=i.favoritesIds.length,i.loading--}async function P(t){i.loading++;let n=[];try{const{data:e}=await A.account.getInfo({extra:"statistics.rating",account_id:t.join(",")});n=Object.values(e).filter(b)}catch(e){R.add({type:"error",title:"Ошибка поучения списка аккаунтов",message:e instanceof Error?e.message:"Неизвестная ошибка"}),console.error(e)}return i.loading--,n}async function j(t){i.loading++;let n=[];try{const{data:e}=await A.clan.getAccountInfo({extra:"clan",account_id:t.join(",")});n=Object.values(e).filter(b)}catch(e){this.notify.add({type:"error",title:"Ошибка поучения списка клановых аккаунтов",message:e instanceof Error?e.message:"Неизвестная ошибка"}),console.error(e)}return i.loading--,n}function D(t,n){const e=k.value.map(_=>{const s=t.find(r=>r.account_id===_);if(!s)return{id:0,nickname:"Deleted",lastBattleTime:0,statistic:{all:null,rating:null},clan:null};const u=s.statistics,f=n.find(r=>(r==null?void 0:r.account_id)===(s==null?void 0:s.account_id));return{id:_,nickname:s.nickname,lastBattleTime:s.last_battle_time,statistic:{all:F.accountAll(u.all),rating:u.rating?F.accountRating(u.rating):null},clan:(f==null?void 0:f.clan)??null}});i.items=e.sort((_,s)=>s.lastBattleTime-_.lastBattleTime)}async function h(){var e;if(i.favoritesIds||await $(),!((e=i.favoritesIds)!=null&&e.length))return;const[t,n]=await Promise.all([P(k.value),j(k.value)]);D(t,n)}async function E(t){await T.indexedDB.accountsFavorites.remove(t)}async function z(t){await E(t),i.items.length<d.pageSize?i.items=i.items.filter(n=>n.id!==t):await h()}async function N(){await h()}return(t,n)=>{const e=V,_=q,s=M,u=G,f=H,r=J,L=K,O=Q;return l(),g("div",tt,[at,p(L,{"no-wrap":"","scroll-auto-disabling":"",headers:S,data:B(i).items,height:"calc(100vh - 112px)"},{nickname:o(({row:a})=>[a.id?(l(),v(e,{key:0,class:"account-favorites__link link",to:{name:"account-id",params:{id:a.id}}},{default:o(()=>[m(y(a.nickname),1)]),_:2},1032,["to"])):(l(),g(I,{key:1},[m(" Deleted ")],64))]),battles:o(({row:a})=>{var c;return[m(y(((c=a.statistic.all)==null?void 0:c.battles)??"---"),1)]}),winRate:o(({row:a})=>[a.statistic.all?(l(),v(_,{key:0,"model-value":a.statistic.all.winRate,class:"account-favorites__win-rate"},null,8,["model-value"])):(l(),g(I,{key:1},[m(" --- ")],64))]),rating:o(({row:a})=>{var c,w;return[(c=a.statistic)!=null&&c.rating?(l(),v(s,{key:0,rating:(w=a.statistic)==null?void 0:w.rating},null,8,["rating"])):(l(),g(I,{key:1},[m(" --- ")],64))]}),damagePerBattle:o(({row:a})=>{var c;return[m(y(((c=a.statistic.all)==null?void 0:c.damagePerBattle)??"---"),1)]}),clan:o(({row:a})=>[a.clan?(l(),v(e,{key:0,title:a.clan.name,class:"account-favorites__link link",to:{name:"clan-id",params:{id:a.clan.clan_id}}},{default:o(()=>[m(y(a.clan.tag),1)]),_:2},1032,["title","to"])):(l(),g("span",et,"---"))]),actions:o(({row:a})=>[p(f,{title:"Удалить","is-text":"","is-square":"",onClick:c=>z(a.id)},{default:o(()=>[p(u,{name:"delete"})]),_:2},1032,["onClick"])]),footer:o(()=>[p(r,{pagination:B(d),onChange:N},null,8,["pagination"])]),_:1},8,["data"]),p(O,{loading:B(i).loading>0},null,8,["loading"])])}}});export{gt as default};
