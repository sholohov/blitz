import{_ as O}from"./BnYJ5puK.js";import{_ as U}from"./B4NeK8UY.js";import{_ as G}from"./oNXKW4Md.js";import{d as M,u as b,a as W,b as F,l as S,m as J,p as v,e as K,n as T,o as c,q as m,s as x,j as p,w as s,g as B,_ as Q,y as X,f as g,t as D,v as f,x as Y}from"./Divx9Nzj.js";import{_ as Z}from"./Bb1A4uhg.js";import{_ as tt}from"./DX4LQXT-.js";import{_ as at}from"./34P0Lxgg.js";import{c as nt}from"./B4FMxlHh.js";import{n as A}from"./BxBPJGBn.js";import{s as C}from"./C77m5c5_.js";import"./DD4asW33.js";const et={class:"account-tracked"},ct={key:1},it={key:0},ot={key:1},st={key:1},lt={key:1},rt={key:0},mt={key:1},ut={key:1},At=M({__name:"tracked",setup(_t){const{$formatter:I}=b(),L=W();F({title:()=>I.route.getTitle(nt.toString(L.name)??"")});const e=S({loading:0,items:[],accountsLocal:null}),_=S({total:0,page:1,pageSize:100}),P=[{key:"nickname",label:"Ник"},{key:"clan",label:"Клан"},{key:"battles",label:"Боёв"},{key:"winRate",label:"Побед"},{key:"damagePerBattle",label:"Урон"},{key:"rating",label:"Рейтинг"},{key:"lastBattleTime",width:160,label:"Последний бой",formatter:t=>typeof t=="number"?Y.date.toRelativeTime(t*1e3):"---"},{key:"actions",width:60}];J(()=>{$()});const w=K(()=>{const t=_.page*_.pageSize,a=t-_.pageSize;return(e.accountsLocal??[]).filter(A).slice(a,t)});async function N(){e.loading++;try{const{$indexedDB:t}=b(),a=await t.accountsInfo.getAll();e.accountsLocal=(a??[]).map(l=>l.data).sort((l,o)=>o.last_battle_time-l.last_battle_time),_.total=(a==null?void 0:a.length)??0}catch(t){v(t,{title:"Ошибка поучения локального списка аккаунтов"})}e.loading--}async function j(t){e.loading++;try{const a=await T.account.getInfo({extra:"statistics.rating",account_id:t.join(",")});return Object.values(a.data).filter(A)}catch(a){return v(a,{title:"Ошибка поучения списка аккаунтов"}),[]}finally{e.loading--}}async function E(t){e.loading++;try{const{data:a}=await T.clan.getAccountInfo({extra:"clan",account_id:t.join(",")});return Object.values(a).filter(A)}catch(a){return v(a,{title:"Ошибка поучения списка клановых аккаунтов"}),[]}finally{e.loading--}}async function $(){var t;e.accountsLocal||await N(),(t=e.accountsLocal)!=null&&t.length&&await R()}function z(t,a){const l=w.value.map(o=>{const r=t.find(u=>u.account_id===o.account_id);if(!r)return{id:o.account_id,nickname:o.nickname,lastBattleTime:NaN,isDeleted:!0,statistic:null,clan:null};const d=r.statistics,k=C.accountAll(d.all),y=d.rating?C.accountRating(d.rating):null,{clan:h}=a.find(u=>(u==null?void 0:u.account_id)===r.account_id)??{};return{id:r.account_id,nickname:r.nickname,lastBattleTime:r.last_battle_time,statistic:{all:k,rating:y},clan:h??null}});e.items=l.sort((o,r)=>r.lastBattleTime-o.lastBattleTime)}async function R(){const t=w.value.map(o=>o.account_id);if(!t.length)return;const[a,l]=await Promise.all([j(t),E(t)]);z(a,l)}async function V(t){const{$indexedDB:a}=b();await Promise.all([a.accountsInfo.remove(t),a.accountsAchievements.remove(t),a.tanksStat.remove(t)])}async function q(t){await V(t),e.items.length<_.total?e.items=e.items.filter(a=>a.id!==t):await $()}async function H(){await R()}return(t,a)=>{const l=O,o=U,r=G,d=X,k=Q,y=Z,h=tt,u=at;return c(),m("div",et,[a[0]||(a[0]=x("div",{class:"account-tracked__description content-area",style:{"max-width":"800px"}},[x("p",null,"Список игроков, статистика которых отслеживается. Данные хранятся в браузере."),x("p",null," Отслеживание начинается с момента просмотра аккаунта на данном ресурсе. После удаления из списка - отслеживание прекращается. ")],-1)),p(h,{"no-wrap":"","scroll-to-top":"","scroll-auto-disabling":"",headers:P,data:B(e).items,height:"calc(100vh - 112px)"},{nickname:s(({row:n})=>[n.isDeleted?(c(),m("span",ct,f(n.nickname),1)):(c(),g(l,{key:0,class:"account-tracked__link link",to:{name:"account-id",params:{id:n.id}}},{default:s(()=>[D(f(n.nickname),1)]),_:2},1032,["to"]))]),battles:s(({row:n})=>{var i;return[n.isDeleted?(c(),m("span",ot,"---")):(c(),m("span",it,f((i=n.statistic)==null?void 0:i.all.battles),1))]}),winRate:s(({row:n})=>{var i;return[n.isDeleted?(c(),m("span",st,"---")):(c(),g(o,{key:0,"win-rate":(i=n.statistic)==null?void 0:i.all.winRate,class:"account-tracked__win-rate"},null,8,["win-rate"]))]}),rating:s(({row:n})=>{var i;return[n.isDeleted?(c(),m("span",lt,"---")):(c(),g(r,{key:0,rating:(i=n.statistic)==null?void 0:i.rating},null,8,["rating"]))]}),damagePerBattle:s(({row:n})=>{var i;return[n.isDeleted?(c(),m("span",mt,"---")):(c(),m("span",rt,f((i=n.statistic)==null?void 0:i.all.damagePerBattle),1))]}),clan:s(({row:n})=>[n.clan?(c(),g(l,{key:0,title:n.clan.name,class:"account-tracked__link link",to:{name:"clan-id",params:{id:n.clan.clan_id}}},{default:s(()=>[D(f(n.clan.tag),1)]),_:2},1032,["title","to"])):(c(),m("span",ut,"---"))]),actions:s(({row:n})=>[p(k,{title:"Удалить","is-text":"","is-square":"",onClick:i=>q(n.id)},{default:s(()=>[p(d,{name:"delete"})]),_:2},1032,["onClick"])]),footer:s(()=>[p(y,{pagination:B(_),onChange:H},null,8,["pagination"])]),_:1},8,["data"]),p(u,{loading:B(e).loading>0},null,8,["loading"])])}}});export{At as default};
