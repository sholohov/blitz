import{_ as G}from"./Cmn0f48e.js";import{_ as I}from"./DP7BBWgZ.js";import{_ as M}from"./BdFzBH2T.js";import{_ as H}from"./B7Mce4cO.js";import{f as N,q as T,r as $,i as K,o as f,j as C,w as _,k as v,c as B,b as r,a as i,d as g,t as O,m as A,X as W,a0 as P,T as X,F as Y,A as J,C as Q,g as Z,h as q,z as ee,N as te,af as oe,O as se}from"./BM_c6A7U.js";import{s as p,o as ne,d as ae,h as S,u as ie,a as D,b as w}from"./D_RpC5tF.js";import{_ as V}from"./Ct4DMbE-.js";import{_ as ce}from"./D4aUj366.js";import{_ as re}from"./DKx20K7W.js";import{u as _e}from"./tz8OXiQC.js";import{u as le}from"./BL2Wcl4w.js";import{u as ue}from"./DgZNgcpm.js";import"./DB4JgT8g.js";import"./BxBPJGBn.js";import"./DDxGNb5w.js";const de={key:0,class:"update-message"},pe={class:"update-message__title"},fe=i("div",{class:"update-message__body"}," Что бы изменения вступили в силу, необходимо обновить страницу. ",-1),me={class:"update-message__control"},ge=N({__name:"UpdateMessage",setup(b){T(()=>{u()});const n=$(!1),a=$(null),o=P(),h=K(()=>{const m=o.public.clientVersion;return!a.value||!m||n.value?!1:a.value!==m});function u(){const m=p.firebase.db();ne(ae(m,"app","info"),l=>{const d=l.data();a.value=(d==null?void 0:d.version)??null},l=>{S(l,{title:"Получение данных версии из Firebase"})})}function s(){location.reload()}function c(){n.value=!0}return(m,l)=>{const d=I,k=M,R=H;return f(),C(W,{name:"update-message-"},{default:_(()=>[v(h)?(f(),B("div",de,[r(R,{class:"update-message__inner"},{default:_(()=>[i("div",pe,[r(d,{class:"update-message__icon",name:"new-releases"}),g(" Обновление v"+O(v(a)),1)]),fe,i("div",me,[r(k,{class:"update-message__btn",onClick:s},{default:_(()=>[g(" Обновить ")]),_:1}),r(k,{class:"update-message__btn",onClick:c},{default:_(()=>[g(" Скрыть ")]),_:1})])]),_:1})])):A("",!0)]),_:1})}}}),he={class:"update-db-dialog__header"},ke=i("b",null,"База данных обновлена",-1),ye=i("br",null,null,-1),ve=i("br",null,null,-1),be=i("br",null,null,-1),xe=i("br",null,null,-1),Ue={style:{display:"flex","justify-content":"flex-end"}},we=N({__name:"UpdateDBDialog",emits:["confirm"],setup(b,{expose:n,emit:a}){const o=$(null),h=a;function u(){var c;(c=o.value)==null||c.doClose(),h("confirm")}function s(){var c;(c=o.value)==null||c.doOpen()}return n({open:s}),(c,m)=>{const l=I,d=M,k=V;return f(),C(k,{ref_key:"dialogRef",ref:o,class:"update-db-dialog","modal-enabled":"",width:"480px"},{title:_(()=>[i("div",he,[r(l,{class:"update-db-dialog__icon",name:"database-alert"}),ke])]),footer:_(()=>[i("div",Ue,[r(d,{onClick:u},{default:_(()=>[g(" Так точно ")]),_:1})])]),default:_(()=>[g(" Для продолжения использования необходимо: "),ye,g(" 1. Закрыть все вкладки ресурса, кроме активной."),ve,g(" 2. Обновить текущую страницу."),be,g(" 3. Готово."),xe]),_:1},512)}}}),Se={class:"ui-notification"},Be={key:0,class:"ui-notification__item-title"},$e={class:"ui-notification__item-body"},De=["onClick"],Ne=N({__name:"UiNotification",props:{appendToBody:{type:Boolean,default:!1}},setup(b){const n=ie(),a=o=>{if(o.title)return o.title;switch(o.type){case"success":return"Успешно";case"error":return"Ошибка";case"info":return"Информация";case"warning":return"Внимание";default:return o.title}};return(o,h)=>{const u=re;return f(),C(u,null,{default:_(()=>[i("div",Se,[r(X,{tag:"ul",class:"ui-notification__list",name:"ui-notification__item-"},{default:_(()=>[(f(!0),B(Y,null,J(v(n).items,s=>(f(),B("li",{key:s.id,class:Q(["ui-notification__item",[s.type?"ui-notification__item--"+s.type:""]])},[s.title||s.type?(f(),B("div",Be,O(a(s)),1)):A("",!0),i("div",$e,O(s.message),1),i("button",{class:"ui-notification__item-close",onClick:c=>v(n).remove(s)},null,8,De)],2))),128))]),_:1})])]),_:1})}}}),Ce=()=>{const b=new URL(location.href),n=Object.fromEntries(b.searchParams.entries()),a={access_token:n.access_token,expires_at:n.expires_at,account_id:n.account_id,nickname:n.nickname};return Object.values(a).every(o=>o)?a:null},Re={getUser:Ce},Ee={class:"layout"},Ye=N({__name:"default",setup(b){const n=Z(),a=q(),o=ue(),h=_e(),u=le(),s=$(null),c=$(null);R(),L(),ee(()=>n.fullPath,async(e,t)=>{e!==t&&(await F(),u.toggleMainSearch(!1))}),te(()=>{var e,t;u.mainSearchOpened?(e=s.value)==null||e.doOpen():(t=s.value)==null||t.doClose()}),T(()=>{o.init();const e=p.storage.getUser();e&&h.setUser({accountId:Number(e.account_id),name:e.nickname})});function m(){w.auth.logout(),h.resetUser(),p.storage.removeUser(),location.assign("/")}D.request.onError=({error:e})=>{(e==null?void 0:e.message)==="INVALID_ACCESS_TOKEN"&&m()};let l=!1;async function d(){if(l)return;const e=p.storage.getUser();if(!e||Number.isNaN(+e.expires_at))return;const t=+e.expires_at*1e3,x=Date.now();if(!(t<=x)&&!(t-x>oe)){l=!0;try{const y=x+se*13,{data:U}=await D.auth.prolongate({expires_at:Math.round(y/1e3),access_token:e.access_token});p.storage.setUser({...e,access_token:U.access_token,expires_at:String(U.expires_at)}),w.auth.prolongate({id:e.account_id,expiresAt:new Date(y).toISOString(),token:U.access_token}).catch(E=>{S(E,{title:"Продление сессии авторизации"})})}catch(y){S(y,{title:"Продление сессии авторизации"})}l=!1}}D.request.beforeRequest=async e=>{e.method==="get"&&(e.params=e.params??{},e.params.access_token=p.storage.getAccessToken(),e.params.application_id=P().public.appId),e.url.includes("prolongate")||await d()};async function k(e){try{await w.auth.login({id:e.account_id,token:e.access_token,expiresAt:new Date(+e.expires_at*1e3).toISOString()}),await w.user.set({id:e.account_id,name:e.nickname})}catch(t){console.error(t),S(t,{title:"Авторизация"}),await D.auth.logout()}}function R(){const e=Re.getUser();e&&(p.storage.setUser(e),a.replace("/"),k(e))}async function F(){const e=p.storage.getUser();if(e)try{await w.user.action({id:e.account_id})}catch(t){S(t,{title:"Действие пользователя",message:"[SELF API] "+(t instanceof Error?t.message:"Неизвестная ошибка")})}}async function L(){const e=await p.indexedDB.getInstance();e.onBlocked=()=>{var t;return(t=c.value)==null?void 0:t.open()}}return(e,t)=>{const x=G,y=ge,U=we,E=ce,j=V,z=Ne;return f(),B("div",Ee,[r(x),r(y),r(U,{ref_key:"updateDBRef",ref:c},null,512),v(o).isTablet?(f(),C(j,{key:0,ref_key:"searchDialogRef",ref:s,title:"Поиск аккаунтов и кланов",width:"480px",position:"top",onClose:t[0]||(t[0]=Oe=>v(u).toggleMainSearch(!1))},{default:_(()=>[r(E,{style:{height:"270px"}})]),_:1},512)):A("",!0),r(z)])}}});export{Ye as default};
