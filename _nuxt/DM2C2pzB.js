import{d as z,u as _,a as j,b as A,l as p,e as L,m as R,p as f,n as V,o as u,q as k,s as i,j as c,w as r,g as m,_ as q,y as F,f as H,J as P,I as U,v as y,F as G,t as J,x as b}from"./Divx9Nzj.js";import{_ as M}from"./Bb1A4uhg.js";import{_ as O}from"./DX4LQXT-.js";import{_ as K}from"./34P0Lxgg.js";import{c as Q}from"./B4FMxlHh.js";import{n as W}from"./BxBPJGBn.js";import{_ as X}from"./BnYJ5puK.js";import{_ as Y}from"./CuWEET8W.js";import"./DD4asW33.js";import"./B6ZSgAcB.js";import"./O7DRg4lh.js";import"./AomIj8wQ.js";import"./DlAUqK2U.js";const Z={class:"clan-tracked-page"},w={class:"clan-tracked-page__inner"},aa={class:"clan-tracked-page__name"},fa=z({__name:"tracked",setup(ta){const{$formatter:h}=_(),C=j();A({title:()=>h.route.getTitle(Q.toString(C.name)??"")});const e=p({items:[],clans:[],localClans:null,loading:0}),l=p({total:0,page:1,pageSize:100}),x=p({order:"desc",prop:"updated_at"}),v=[{key:"tag",label:"Название"},{key:"members_count",align:"center",label:"Уч-ков"},{key:"updated_at",label:"Обновлён",formatter:a=>a&&typeof a=="number"?b.date.toRelativeTime(a*1e3):"---"},{key:"created_at",label:"Создан",formatter:a=>a?b.date.toDate(Number(a)*1e3):"---"},{key:"actions",width:60}],g=L(()=>{const a=l.page*l.pageSize,t=a-l.pageSize;return(e.localClans??[]).slice(t,a)});R(()=>{d()});async function $(a){e.loading++;let t=[];try{const{data:s}=await V.clan.getInfo({clan_id:a.join(",")});t=Object.values(s).filter(W)??[]}catch(s){f(s,{title:"Получение данных клана"})}return e.loading--,t}async function B(){e.loading++;try{const{$indexedDB:a}=_(),t=await a.clansInfo.getAll();e.localClans=(t??[]).map(s=>s.data),l.total=e.localClans.length}catch(a){f(a,{title:"Получение локальных данных клана"})}e.loading--}function E(a){e.items=g.value.map(t=>a.find(o=>(o==null?void 0:o.clan_id)===t.clan_id)??{...t,updated_at:0,created_at:0,members_count:0,notExists:!0})}async function d(){var s;if(e.localClans||await B(),!((s=e.localClans)!=null&&s.length))return;const a=g.value.map(o=>o.clan_id),t=await $(a);E(t)}async function I(a){const{$indexedDB:t}=_();await t.clansInfo.remove(a),e.items.length<l.total?e.items=e.items.filter(s=>s.clan_id!==a):await d()}async function S(){await d()}return(a,t)=>{const s=F,o=q,D=M,N=O,T=K;return u(),k("div",Z,[t[0]||(t[0]=i("div",{class:"clan-tracked__description content-area",style:{"max-width":"800px"}},[i("p",null,"Список кланов, отслеживаемых в конкретном браузере."),i("p",null," Отслеживание начинается с момента просмотра клана на данном ресурсе. После удаления из списка - отслеживание прекращается. ")],-1)),i("div",w,[c(N,{"no-wrap":"","scroll-to-top":"","scroll-auto-disabling":"",headers:v,data:m(e).items,"default-sort":m(x),height:"calc(100vh - 112px)"},{tag:r(({row:n})=>[n!=null&&n.tag&&(n!=null&&n.name)?(u(),H(P(n.notExists?"span":m(X)),{key:0,class:U([[n.notExists?"":"link"],"clan-tracked-page__details"]),to:{name:"clan-id",params:{id:n.clan_id}}},{default:r(()=>[c(Y,{class:"clan-tracked-page__emblem",alt:n.tag,emblem:n.emblem_set_id},null,8,["alt","emblem"]),i("span",aa," ["+y(n.tag)+"] "+y(n.name),1)]),_:2},1032,["class","to"])):(u(),k(G,{key:1},[J(" Удалён ")],64))]),actions:r(({row:n})=>[c(o,{title:"Удалить","is-text":"","is-square":"",onClick:ea=>I(n.clan_id)},{default:r(()=>[c(s,{name:"delete"})]),_:2},1032,["onClick"])]),footer:r(()=>[c(D,{pagination:m(l),onChange:S},null,8,["pagination"])]),_:1},8,["data","default-sort"]),c(T,{loading:m(e).loading>0},null,8,["loading"])])])}}});export{fa as default};
