import{h as g,_ as N,a as z}from"./disableScroll.DsAaY2lW.js";import{_ as T}from"./TablePagination.vue.DBV-wSMV.js";import{_ as j}from"./UiTable.vue.DurFHiUj.js";import{a as L,s as u,_ as V}from"./request.BaBM-RDs.js";import{f as q,u as A,n as _,i as F,q as O,c as h,a as d,b as c,w as i,k as r,s as k,o as p,j as P,t as y,C as R,D as U,F as H,d as M}from"./entry.D9s_uxMW.js";import{n as W}from"./notEmpty.BxBPJGBn.js";import{_ as G}from"./nuxt-link.BZuFVyid.js";import{_ as J}from"./ClanEmblem.vue.Bjsl2nsK.js";import"./UiImage.vue.BJHbq71s.js";import"./image-broken.CaOqgTym.js";import"./nuxt-icon.C5s37704.js";import"./_plugin-vue_export-helper.DlAUqK2U.js";const K={class:"clan-tracked-page"},Q=d("div",{class:"clan-tracked__description content-area",style:{"max-width":"800px"}},[d("p",null,"Список кланов, отслеживаемых в конкретном браузере."),d("p",null," Отслеживание начинается с момента просмотра клана на данном ресурсе. После удаления из списка - отслеживание прекращается. ")],-1),X={class:"clan-tracked-page__inner"},Y={class:"clan-tracked-page__name"},_a=q({__name:"tracked",setup(Z){A({title:"Отслеживаемые / Кланы"});const t=_({items:[],clans:[],localClans:null,loading:0}),o=_({total:0,page:1,pageSize:100}),b=_({order:"desc",prop:"updated_at"}),C=[{key:"tag",label:"Название"},{key:"members_count",align:"center",label:"Уч-ков"},{key:"updated_at",label:"Обновлён",formatter:a=>a&&typeof a=="number"?k.date.toRelativeTime(a*1e3):"---"},{key:"created_at",label:"Создан",formatter:a=>a?k.date.toDate(Number(a)*1e3):"---"},{key:"actions",width:60}],f=F(()=>{const a=o.page*o.pageSize,n=a-o.pageSize;return(t.localClans??[]).slice(n,a)});O(()=>{m()});async function x(a){t.loading++;let n=[];try{const{data:s}=await L.clan.getInfo({clan_id:a.join(",")});n=Object.values(s).filter(W)??[]}catch(s){g(s,{title:"Получение данных клана"})}return t.loading--,n}async function v(){t.loading++;try{const a=await u.indexedDB.clansInfo.getAll();t.localClans=(a??[]).map(n=>n.data),o.total=t.localClans.length}catch(a){g(a,{title:"Получение локальных данных клана"})}t.loading--}function B(a){t.items=f.value.map(n=>a.find(l=>(l==null?void 0:l.clan_id)===n.clan_id)??{...n,updated_at:0,created_at:0,members_count:0,notExists:!0})}async function m(){var s;if(t.localClans||await v(),!((s=t.localClans)!=null&&s.length))return;const a=f.value.map(l=>l.clan_id),n=await x(a);B(n)}async function E(a){await u.indexedDB.clansInfo.remove(a),t.items.length<o.total?t.items=t.items.filter(n=>n.clan_id!==a):await m()}async function $(){await m()}return(a,n)=>{const s=N,l=z,D=T,I=j,S=V;return p(),h("div",K,[Q,d("div",X,[c(I,{"no-wrap":"","scroll-to-top":"","scroll-auto-disabling":"",headers:C,data:r(t).items,"default-sort":r(b),height:"calc(100vh - 112px)"},{tag:i(({row:e})=>[e!=null&&e.tag&&(e!=null&&e.name)?(p(),P(U(e.notExists?"span":r(G)),{key:0,class:R([[e.notExists?"":"link"],"clan-tracked-page__details"]),to:{name:"clan-id",params:{id:e.clan_id}}},{default:i(()=>[c(J,{class:"clan-tracked-page__emblem",alt:e.tag,emblem:e.emblem_set_id},null,8,["alt","emblem"]),d("span",Y," ["+y(e.tag)+"] "+y(e.name),1)]),_:2},1032,["class","to"])):(p(),h(H,{key:1},[M(" Удалён ")],64))]),actions:i(({row:e})=>[c(l,{title:"Удалить","is-text":"","is-square":"",onClick:w=>E(e.clan_id)},{default:i(()=>[c(s,{name:"delete"})]),_:2},1032,["onClick"])]),footer:i(()=>[c(D,{pagination:r(o),onChange:$},null,8,["pagination"])]),_:1},8,["data","default-sort"]),c(S,{loading:r(t).loading>0},null,8,["loading"])])])}}});export{_a as default};
