import{_ as z}from"./DZDyBeSB.js";import{_ as G}from"./CFptAKa4.js";import{d as H,b as O,r as c,c as A,k as P,z as q,a8 as J,o as r,l as u,m as I,h as x,f as w,i as Q,w as W,F as K,B as T,t as U,C as X,g as Y,ak as Z,U as ee,p as k}from"./CKv8GwDH.js";import{u as C}from"./CI5TTA92.js";import{n as te}from"./BxBPJGBn.js";import{d as ae}from"./CA4v15a9.js";const ne={class:"main-search__inner"},oe={class:"main-search__input"},se={key:0,class:"main-search__dropdown"},le={key:0,class:"main-search__item-title"},ce=["onKeydown","onClick","textContent"],_e=H({__name:"MainSearch",props:{context:{type:String,default:"account"}},setup(ie){const V=O(),L=c(null),_=c(null),o=c(""),h=c([]),p=c([]),g=c([]),E=c([]),f=c([]),i=c(0),v=c(-1),D=A(()=>[h.value,p.value,g.value]),N=A(()=>[h.value,p.value,g.value].some(e=>e.length>0));P(()=>{window.addEventListener("click",R)}),q(()=>{window.removeEventListener("click",R)});function y(){h.value=[],p.value=[],g.value=[]}function R(e){var t;(t=L.value)!=null&&t.contains(e.target)||(y(),o.value="")}async function $(e){var t;y(),await V.push({name:e.context+"-id",params:{id:String(e.id)}}),(t=_.value)==null||t.focus()}async function S(e){i.value++;try{const n=((await k.account.getList({search:e,limit:5})).data||[]).map(a=>({name:a.nickname,id:a.account_id,context:"account"}));if(n.length){const a=await k.clan.getAccountInfo({extra:"clan",account_id:n.map(s=>s.id).join(",")}).then(s=>s).catch(()=>null);a!=null&&a.data&&n.forEach(s=>{var l,m;const d=(m=(l=a.data[s.id])==null?void 0:l.clan)==null?void 0:m.tag;s.name+=d?` [${d}]`:""}),h.value=[{id:1,name:"Аккаунты",context:"title"},...n]}}catch(t){C(t,{title:"Поиск аккаунта"})}i.value--}async function B(e){i.value++;try{const{data:t}=await k.clan.getList({search:e,limit:5}),n=(t.filter(te)??[]).map(a=>({name:`[${a.tag}] ${a.name}`,id:a.clan_id,context:"clan"}));n.length&&(p.value=[{id:2,name:"Кланы",context:"title"},...n])}catch(t){C(t,{title:"Поиск клана"})}i.value--}async function F(e){i.value++;try{const n=((await k.tournaments.getList({search:e,limit:5})).data||[]).map(a=>({name:a.title,id:a.tournament_id,context:"tournaments"}));n.length&&(g.value=[{id:3,name:"Турниры",context:"title"},...n])}catch(t){C(t,{title:"Поиск турнира"})}i.value--}async function M(){var e,t;((e=o.value)==null?void 0:e.length)>=3&&/[^а-яё]+/gi.test(o.value)&&await S(o.value.trim()),((t=o.value)==null?void 0:t.length)>=2&&(await B(o.value.trim()),await F(o.value.trim())),await ee(),f.value=E.value}const j=ae(M,1e3,{leading:!0});J(async()=>{o.value=o.value.replace(/\/\d+$/,"").trim(),o.value.length<2&&y(),await j()});function b(e){var n,a,s,d,l,m;const t=e.target;i.value>0||(e.key==="Escape"&&(y(),o.value="",v.value=-1,(n=_.value)==null||n.focus()),t.tagName==="INPUT"&&(v.value=-1),e.key==="ArrowUp"&&(e.preventDefault(),(a=f.value)!=null&&a.length&&v.value>0?(s=f.value[--v.value])==null||s.focus():(d=_.value)==null||d.focus()),e.key==="ArrowDown"&&(e.preventDefault(),(l=f.value)!=null&&l.length&&v.value<f.value.length-1&&((m=f.value[++v.value])==null||m.focus())))}return(e,t)=>{const n=z,a=G;return r(),u("div",{ref_key:"rootRef",ref:L,class:"main-search"},[I("div",ne,[I("div",oe,[x(n,{ref_key:"inputRef",ref:_,modelValue:w(o),"onUpdate:modelValue":t[0]||(t[0]=s=>Q(o)?o.value=s:null),placeholder:"Поиск игрока, клана или турнира",type:"search",onKeydown:b},null,8,["modelValue"])]),x(Z,null,{default:W(()=>[w(N)?(r(),u("div",se,[(r(!0),u(K,null,T(w(D),(s,d)=>(r(),u("ul",{key:d,class:"main-search__list",onKeydown:b},[(r(!0),u(K,null,T(s,l=>(r(),u("li",{key:l.context+l.id,class:"main-search__item"},[l.context==="title"?(r(),u("div",le,U(l.name),1)):(r(),u("button",{key:1,ref_for:!0,ref_key:"btnRefs",ref:E,class:"main-search__item-btn",onKeydown:X(m=>$(l),["enter"]),onClick:m=>$(l),textContent:U(l.name)},null,40,ce))]))),128))],32))),128)),x(a,{loading:w(i)>0},null,8,["loading"])])):Y("",!0)]),_:1})])],512)}}});export{_e as _};
