import{_ as U}from"./EAeUkgBq.js";import{_ as D}from"./z8RK9n7K.js";import{_ as F}from"./Dy7JMDz2.js";import{_ as H}from"./BvAUi8YU.js";import{_ as O}from"./DQ9jL8Ly.js";import{_ as q}from"./BhaqhKhb.js";import{_ as G}from"./W1n9aEx_.js";import{d as M,u as W,a as J,b as K,k as Q,l as T,e as X,m as Y,n as g,p as S,g as f,f as u,w as l,j as R,q as Z,s as v,t as B,o as i,v as r,x as k,F as y}from"./BzQ49_ll.js";import{c as tt}from"./B4FMxlHh.js";import{n as p}from"./BxBPJGBn.js";import{s as C}from"./DhcCwqhx.js";import"./DD4asW33.js";import"./D18XexEg.js";import"./BDnRw2QZ.js";import"./AxE_3BVK.js";import"./DlAUqK2U.js";import"./CEk9wgDu.js";const at={class:"account-contacts"},ht=M({__name:"contacts",setup(nt){const{$formatter:P}=W(),$=J();K({title:()=>P.route.getTitle(tt.toString($.name)??"")});const w=Q(),c=T({loading:0,items:[],account:null,contactsIds:[]}),m=T({total:0,page:1,pageSize:100}),j=[{key:"nickname",label:"Ник"},{key:"clan",label:"Клан"},{key:"battles",label:"Боёв"},{key:"winRate",label:"Побед"},{key:"damagePerBattle",label:"Урон"},{key:"rating",label:"Рейтинг"},{key:"lastBattleTime",width:160,label:"Последний бой",formatter:a=>typeof a=="number"?Z.date.toRelativeTime(a*1e3):"---"}],b=X(()=>{const a=m.page*m.pageSize,n=a-m.pageSize;return c.contactsIds.filter(p).slice(n,a)});Y(()=>{A()});async function E(a){var n,e;c.loading++;try{const{data:o}=await v.account.getInfo({account_id:a,extra:"private.grouped_contacts"});return c.account=o[a]??null,c.contactsIds=((e=(n=o[a])==null?void 0:n.private)==null?void 0:e.grouped_contacts.ungrouped)??[],m.total=c.contactsIds.length,o[a]??null}catch(o){return B(o,{title:"Ошибка получения данных аккаунта"}),null}finally{c.loading--}}async function N(a){c.loading++;let n=[];try{const{data:e}=await v.clan.getAccountInfo({extra:"clan",account_id:a.join(",")});n=Object.values(e).filter(p)}catch(e){B(e,{title:"Ошибка поучения списка клановых аккаунтов"})}return c.loading--,n}function V(a,n){const e=b.value.map(o=>{const s=a.find(t=>t.account_id===o);if(!s)return{id:0,nickname:"",lastBattleTime:0,statistic:{all:null,rating:null},clan:null};const d=s.statistics,h=C.accountAll(d.all),I=d.rating?C.accountRating(d.rating):null,{clan:x}=n.find(t=>(t==null?void 0:t.account_id)===s.account_id)??{};return{id:s.account_id,nickname:s.nickname,lastBattleTime:s.last_battle_time,statistic:{all:h,rating:I},clan:x??null}});c.items=e.sort((o,s)=>s.lastBattleTime-o.lastBattleTime)}async function z(a){c.loading++;let n=[];try{const{data:e}=await v.account.getInfo({extra:"statistics.rating",account_id:a.join(",")});n=Object.values(e).filter(p)}catch(e){B(e,{title:"Ошибка поучения списка аккаунтов"})}return c.loading--,n}async function A(){const a=w.accountId;if(!a||(c.account||await E(a),!c.contactsIds.length))return;const[n,e]=await Promise.all([z(b.value),N(b.value)]);V(n.filter(p),e.filter(p))}async function L(){await A()}return(a,n)=>{const e=U,o=D,s=F,d=H,h=O,I=q,x=G;return i(),g("div",at,[n[1]||(n[1]=S("div",{class:"account-contacts__description content-area",style:{"max-width":"800px"}},[S("p",null,'Список "Контактов". Данные из игры.')],-1)),f(w).accountId?(i(),u(h,{key:0,"no-wrap":"","scroll-auto-disabling":"",headers:j,data:f(c).items,height:"calc(100vh - 112px)"},{nickname:l(({row:t})=>[t.id?(i(),u(e,{key:0,class:"account-contacts__link link",to:{name:"account-id",params:{id:t.id}}},{default:l(()=>[r(k(t.nickname),1)]),_:2},1032,["to"])):(i(),g(y,{key:1},[r(" Deleted ")],64))]),battles:l(({row:t})=>{var _;return[r(k(((_=t.statistic.all)==null?void 0:_.battles)??"---"),1)]}),winRate:l(({row:t})=>[t.statistic.all?(i(),u(o,{key:0,"win-rate":t.statistic.all.winRate,class:"account-contacts__win-rate"},null,8,["win-rate"])):(i(),g(y,{key:1},[r(" --- ")],64))]),rating:l(({row:t})=>[t.statistic.rating?(i(),u(s,{key:0,rating:t.statistic.rating},null,8,["rating"])):(i(),g(y,{key:1},[r(" --- ")],64))]),damagePerBattle:l(({row:t})=>{var _;return[r(k(((_=t.statistic.all)==null?void 0:_.damagePerBattle)??"---"),1)]}),clan:l(({row:t})=>[t.clan?(i(),u(e,{key:0,title:t.clan.name,class:"account-contacts__link link",to:{name:"clan-id",params:{id:t.clan.clan_id}}},{default:l(()=>[r(k(t.clan.tag),1)]),_:2},1032,["title","to"])):(i(),g(y,{key:1},[r(" --- ")],64))]),footer:l(()=>[R(d,{pagination:f(m),onChange:L},null,8,["pagination"])]),_:1},8,["data"])):(i(),u(I,{key:1,height:"calc(100vh - 180px)"},{default:l(()=>n[0]||(n[0]=[r(" Отобразится список контактов вашего аккаунта ")])),_:1})),R(x,{loading:f(c).loading>0},null,8,["loading"])])}}});export{ht as default};
