import{_ as P}from"./page.BTpJsxSd.js";import{h as U,_ as N,a as R,u as j}from"./disableScroll.DbQbNoWW.js";import{_ as q,a as z}from"./ContentBox.vue.1EWrA6dy.js";import{f as S,q as T,r as k,i as I,o as d,j as x,w as r,k as y,c as b,b as i,a as s,d as m,t as B,m as w,$ as G,a0 as H,T as K,F as W,A as J,C as Q,g as X,z as Y,R as Z}from"./entry.DnyhrCzd.js";import{s as h,o as ee,d as te,a as D}from"./request.D7J0I_-4.js";import{_ as M}from"./CDialog.vue.CQlkuHhL.js";import{_ as oe}from"./client-only.BwacdUep.js";import{a as ne,u as se,b as ae}from"./index.D7cX-f-u.js";import{a as C}from"./index.BRuhnkRA.js";import{u as ie}from"./user.CdOYHEHf.js";import"./CInput.vue.BvL80IAb.js";import"./notEmpty.BxBPJGBn.js";import"./debounce.DaU679KR.js";const ce={key:0,class:"update-message"},re={class:"update-message__title"},le=s("div",{class:"update-message__body"}," Что бы изменения вступили в силу, необходимо обновить страницу. ",-1),_e={class:"update-message__control"},ue=S({__name:"UpdateMessage",setup($){T(()=>{_()});const l=k(!1),c=k(null),n=H(),g=I(()=>{const p=n.public.clientVersion;return!c.value||!p||l.value?!1:c.value!==p});function _(){const p=h.firebase.db();ee(te(p,"app","info"),f=>{const u=f.data();c.value=(u==null?void 0:u.version)??null},f=>{U(f,{title:"Получение данных версии из Firebase"})})}function t(){location.reload()}function a(){l.value=!0}return(p,f)=>{const u=N,v=R,e=q;return d(),x(G,{name:"update-message-"},{default:r(()=>[y(g)?(d(),b("div",ce,[i(e,{class:"update-message__inner"},{default:r(()=>[s("div",re,[i(u,{class:"update-message__icon",name:"new-releases"}),m(" Обновление v"+B(y(c)),1)]),le,s("div",_e,[i(v,{class:"update-message__btn",onClick:t},{default:r(()=>[m(" Обновить ")]),_:1}),i(v,{class:"update-message__btn",onClick:a},{default:r(()=>[m(" Скрыть ")]),_:1})])]),_:1})])):w("",!0)]),_:1})}}}),de={class:"update-db-dialog__header"},pe=s("b",null,"База данных обновлена",-1),fe=s("br",null,null,-1),me=s("br",null,null,-1),ge=s("br",null,null,-1),he=s("br",null,null,-1),ve={style:{display:"flex","justify-content":"flex-end"}},ye=S({__name:"UpdateDBDialog",emits:["confirm"],setup($,{expose:l,emit:c}){const n=k(null),g=c;function _(){var a;(a=n.value)==null||a.doClose(),g("confirm")}function t(){var a;(a=n.value)==null||a.doOpen()}return l({open:t}),(a,p)=>{const f=N,u=R,v=M;return d(),x(v,{ref_key:"dialogRef",ref:n,class:"update-db-dialog","modal-enabled":"",width:"480px"},{title:r(()=>[s("div",de,[i(f,{class:"update-db-dialog__icon",name:"database-alert"}),pe])]),footer:r(()=>[s("div",ve,[i(u,{onClick:_},{default:r(()=>[m(" Так точно ")]),_:1})])]),default:r(()=>[m(" Для продолжения использования необходимо: "),fe,m(" 1. Закрыть все вкладки ресурса, кроме активной."),me,m(" 2. Обновить текущую страницу."),ge,m(" 3. Готово."),he]),_:1},512)}}}),be={class:"c-notification"},ke={key:0,class:"c-notification__item-title"},Ce={class:"c-notification__item-body"},Se=["onClick"],xe=S({__name:"CNotification",props:{appendToBody:Boolean},setup($){const l=j(),c=n=>{if(n.title)return n.title;switch(n.type){case"success":return"Успешно";case"error":return"Ошибка";case"info":return"Информация";case"warning":return"Внимание";default:return n.title}};return(n,g)=>{const _=oe;return d(),x(_,null,{default:r(()=>[s("div",be,[i(K,{tag:"ul",class:"c-notification__list",name:"c-notification__item-"},{default:r(()=>[(d(!0),b(W,null,J(y(l).items,t=>(d(),b("li",{key:t.id,class:Q(["c-notification__item",[t.type?"c-notification__item--"+t.type:""]])},[t.title||t.type?(d(),b("div",ke,B(c(t)),1)):w("",!0),s("div",Ce,B(t.message),1),s("button",{class:"c-notification__item-close",onClick:a=>y(l).remove(t)},null,8,Se)],2))),128))]),_:1})])]),_:1})}}}),$e={class:"layout"},Le=S({__name:"default",setup($){const l=X(),c=ne(),n=se(),g=ie(),_=ae(),t=k(null),a=k(null),p=I(()=>n.isTablet||c.isTablet||c.isMobile);{const e=h.url.getUser();e&&(h.storage.setUser(e),history.replaceState(null,document.title,location.pathname),f(e))}Y(()=>l.fullPath,async(e,o)=>{e!==o&&(await u(),_.toggleMainSearch(!1))}),Z(()=>{var e,o;_.mainSearchOpened?(e=t.value)==null||e.doOpen():(o=t.value)==null||o.doClose()}),T(()=>{n.init(),v();const e=h.storage.getUser();e&&g.setUser({accountId:Number(e.account_id),name:e.nickname})}),D.request.onError=({error:e})=>{(e==null?void 0:e.message)==="INVALID_ACCESS_TOKEN"&&(C.auth.logout(),g.resetUser(),h.storage.removeUser(),location.assign("/"))};async function f(e){try{await C.auth.login({id:e.account_id,token:e.access_token,expiresAt:new Date(+e.expires_at*1e3).toISOString()}),await C.user.set({id:e.account_id,name:e.nickname})}catch(o){console.error(o),await D.auth.logout()}}async function u(){const e=h.storage.getUser();if(e)try{await C.user.action({id:e.account_id})}catch(o){U(o,{title:"Действие пользователя",message:"[SELF API] "+(o instanceof Error?o.message:"Неизвестная ошибка")})}}async function v(){const e=await h.indexedDB.getInstance();e.onBlocked=()=>{var o;return(o=a.value)==null?void 0:o.open()}}return(e,o)=>{const E=P,V=ue,A=ye,O=z,F=M,L=xe;return d(),b("div",$e,[i(E),i(V),i(A,{ref_key:"updateDBRef",ref:a},null,512),y(p)?(d(),x(F,{key:0,ref_key:"searchDialogRef",ref:t,title:"Поиск аккаунтов и кланов",width:"480px",position:"top",onClose:o[0]||(o[0]=Be=>y(_).toggleMainSearch(!1))},{default:r(()=>[i(O,{style:{height:"270px"}})]),_:1},512)):w("",!0),i(L)])}}});export{Le as default};
