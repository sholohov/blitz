import{_ as q}from"./BYjQXuNZ.js";import{_ as H}from"./Bm14zLTW.js";import{_ as O}from"./25F-AMWF.js";import{d as U,u as G,j as $,k as M,c as W,l as p,m as b,h as g,w as o,f as B,n as J,s as A,p as T,o as c,e as k,q as m,t as v,F as x,_ as K,v as Q}from"./CKv8GwDH.js";import{_ as X}from"./DWhwL8Z4.js";import{_ as Y}from"./CKJ7yeoF.js";import{_ as Z}from"./CFptAKa4.js";import{n as w}from"./BxBPJGBn.js";import{u as C}from"./CI5TTA92.js";import{s as F}from"./C4oTPxE3.js";import"./DD4asW33.js";import"./di2ZG6aq.js";import"./RPJY7rI9.js";const tt={class:"account-favorites"},at={key:1},gt=U({__name:"favorites",setup(nt){G({title:"Избранное / Аккаунты"});const i=$({loading:0,items:[],favoritesIds:null}),d=$({total:0,page:1,pageSize:100}),R=[{key:"nickname",label:"Ник"},{key:"clan",label:"Клан"},{key:"battles",label:"Боёв"},{key:"winRate",label:"Побед"},{key:"damagePerBattle",label:"Урон"},{key:"rating",label:"Рейтинг"},{key:"lastBattleTime",width:160,label:"Последний бой",formatter:t=>typeof t=="number"?J.date.toRelativeTime(t*1e3):"---"},{key:"actions",width:60}];M(()=>{h()});const y=W(()=>{const t=d.page*d.pageSize,a=t-d.pageSize;return(i.favoritesIds??[]).filter(w).slice(a,t)});async function S(){i.loading++;const{$indexedDB:t}=A(),a=await t.accountsFavorites.getAll();i.favoritesIds=(a??[]).filter(e=>e.isFavorite).map(e=>e.id),d.total=i.favoritesIds.length,i.loading--}async function P(t){i.loading++;let a=[];try{const{data:e}=await T.account.getInfo({extra:"statistics.rating",account_id:t.join(",")});a=Object.values(e).filter(w)}catch(e){C(e,{title:"Ошибка поучения списка аккаунтов"})}return i.loading--,a}async function j(t){i.loading++;let a=[];try{const{data:e}=await T.clan.getAccountInfo({extra:"clan",account_id:t.join(",")});a=Object.values(e).filter(w)}catch(e){C(e,{title:"Ошибка поучения списка клановых аккаунтов"})}return i.loading--,a}function D(t,a){const e=y.value.map(u=>{const s=t.find(r=>r.account_id===u);if(!s)return{id:0,nickname:"Deleted",lastBattleTime:0,statistic:{all:null,rating:null},clan:null};const _=s.statistics,f=a.find(r=>(r==null?void 0:r.account_id)===(s==null?void 0:s.account_id));return{id:u,nickname:s.nickname,lastBattleTime:s.last_battle_time,statistic:{all:F.accountAll(_.all),rating:_.rating?F.accountRating(_.rating):null},clan:(f==null?void 0:f.clan)??null}});i.items=e.sort((u,s)=>s.lastBattleTime-u.lastBattleTime)}async function h(){var e;if(i.favoritesIds||await S(),!((e=i.favoritesIds)!=null&&e.length))return;const[t,a]=await Promise.all([P(y.value),j(y.value)]);D(t,a)}async function z(t){const{$indexedDB:a}=A();await a.accountsFavorites.remove(t)}async function E(t){await z(t),i.items.length<d.pageSize?i.items=i.items.filter(a=>a.id!==t):await h()}async function N(){await h()}return(t,a)=>{const e=q,u=H,s=O,_=K,f=Q,r=X,L=Y,V=Z;return c(),p("div",tt,[a[0]||(a[0]=b("div",{class:"account-favorites__description content-area",style:{"max-width":"800px"}},[b("p",null,' Список игроков добавленных в "Избранные". Данные хранится в браузере. '),b("p",null,'Добавить в избранное, можно нажав "Звёздочку" превью на странице аккаунта.')],-1)),g(L,{"no-wrap":"","scroll-auto-disabling":"",headers:R,data:B(i).items,height:"calc(100vh - 112px)"},{nickname:o(({row:n})=>[n.id?(c(),k(e,{key:0,class:"account-favorites__link link",to:{name:"account-id",params:{id:n.id}}},{default:o(()=>[m(v(n.nickname),1)]),_:2},1032,["to"])):(c(),p(x,{key:1},[m(" Deleted ")],64))]),battles:o(({row:n})=>{var l;return[m(v(((l=n.statistic.all)==null?void 0:l.battles)??"---"),1)]}),winRate:o(({row:n})=>[n.statistic.all?(c(),k(u,{key:0,"win-rate":n.statistic.all.winRate,class:"account-favorites__win-rate"},null,8,["win-rate"])):(c(),p(x,{key:1},[m(" --- ")],64))]),rating:o(({row:n})=>{var l,I;return[(l=n.statistic)!=null&&l.rating?(c(),k(s,{key:0,rating:(I=n.statistic)==null?void 0:I.rating},null,8,["rating"])):(c(),p(x,{key:1},[m(" --- ")],64))]}),damagePerBattle:o(({row:n})=>{var l;return[m(v(((l=n.statistic.all)==null?void 0:l.damagePerBattle)??"---"),1)]}),clan:o(({row:n})=>[n.clan?(c(),k(e,{key:0,title:n.clan.name,class:"account-favorites__link link",to:{name:"clan-id",params:{id:n.clan.clan_id}}},{default:o(()=>[m(v(n.clan.tag),1)]),_:2},1032,["title","to"])):(c(),p("span",at,"---"))]),actions:o(({row:n})=>[g(f,{title:"Удалить","is-text":"","is-square":"",onClick:l=>E(n.id)},{default:o(()=>[g(_,{name:"delete"})]),_:2},1032,["onClick"])]),footer:o(()=>[g(r,{pagination:B(d),onChange:N},null,8,["pagination"])]),_:1},8,["data"]),g(V,{loading:B(i).loading>0},null,8,["loading"])])}}});export{gt as default};
