import{a as f,_ as N}from"./DfPHqO9p.js";import{f as B,U as T,n as V,r as W,q,s,o as r,c as p,a as _,F as O,A as j,t as S,b as G,k as l,C as L,u as M,g as U,i as $,j as w,w as k,m as z}from"./Bsdcsqyr.js";import{f as y}from"./CSXUzGEl.js";import{a as P}from"./2izKRhkt.js";import{s as i}from"./DCoJ0Rnq.js";import{_ as E}from"./Db8l1Yae.js";const H={class:"widget-account-session__list"},J={class:"widget-account-session__label"},K={class:"widget-account-session__value"},Q=B({__name:"WidgetAccountSession",props:{params:{type:Object,default:()=>y.makeAccountSessionWidgetFilters,required:!0}},setup(m){T(a=>({"4e90af88":o.params.bgColorOpacity,"2264f1fa":o.params.bgColor,"0885f9db":o.params.textColor}));const o=m,e=V({loading:0,accountSession:null,account:null,achievementsInfo:null,accountAchievements:null,accountAchievementsSession:null,tanksStat:null,tanksStatSession:null,updateTimerDuration:3e4}),u=W([]);q(()=>{R()});async function v(){e.loading++;try{const{data:a}=await f.encyclopedia.getAchievements();e.achievementsInfo=a??null}catch(a){console.error(a)}e.loading--}async function d(a){e.loading++;try{const{data:t}=await f.account.getInfo({account_id:a,extra:"statistics.rating"});e.account=(t==null?void 0:t[a])??null}catch(t){console.error(t)}e.loading--}async function g(a){e.loading++;try{const{data:t}=await P.session.account.get(a);e.accountSession=t.raw}catch(t){console.error(t)}e.loading--}async function I(a){e.loading++;try{const{data:t}=await f.account.getAchievements({account_id:a});e.accountAchievements=(t==null?void 0:t[a])??null}catch(t){console.error(t)}e.loading--}async function x(a){e.loading++;try{const{data:t}=await P.session.accountAchievements.get(a);e.accountAchievementsSession=t.raw}catch(t){console.error(t)}e.loading--}function C(a,t){switch(a){case"battles":return s.number.toInteger(t.battles);case"winRate":return s.number.toFloatPercent(t.winRate);case"damagePerBattle":return s.number.toInteger(t.damagePerBattle);case"fragPerBattle":return s.number.toFloatNumber(t.fragPerBattle);case"surviveRate":return s.number.toFloatPercent(t.spottedPerBattle);case"hitRate":return s.number.toFloatPercent(t.hitRate);case"spottedPerBattle":return s.number.toFloatNumber(t.spottedPerBattle);case"xpPerBattle":return"xpPerBattle"in t?s.number.toInteger(t.xpPerBattle):"---";default:return"---"}}function h(){if(!e.account||!e.accountSession)return;const a=i.diffFull(e.account.statistics,e.accountSession.statistics);let t;e.achievementsInfo&&e.accountAchievements&&e.accountAchievementsSession&&(t=i.accountAchievementsDiff(e.accountAchievements,e.accountAchievementsSession,e.achievementsInfo)),u.value=o.params.attributes.map(n=>{var b,A;if(n==="teamGamePoints"&&t)return{key:n,label:s.stat.accountProp(n),value:String(i.teamPoints(a,t))};const c=(b=e.achievementsInfo)==null?void 0:b[n];if(c&&t)return{key:n,label:String(c.name).replace(/\([^)]+\)/gi,"")??n,value:String(((A=t.achievements)==null?void 0:A[n])??0)};const D=o.params.battleMode==="rating"&&a.rating?i.accountRating(a.rating):i.accountAll(a.all);return{key:n,label:s.stat.accountProp(n),value:C(n,D)}})}function F(a){h();let t;const n=async()=>{e.loading++,clearTimeout(t),await Promise.all([d(a),I(a)]),h(),t=setTimeout(n,e.updateTimerDuration),e.loading--};n()}async function R(){u.value=o.params.attributes.map(t=>({key:t,label:s.stat.accountProp(t),value:"---"}));const a=o.params.accountId;a&&(await Promise.all([v(),g(a),x(a)]),e.accountSession&&F(a))}return(a,t)=>{const n=N;return r(),p("div",{class:L(["widget-account-session",["widget-account-session--"+m.params.style]])},[_("div",H,[(r(!0),p(O,null,j(l(u),c=>(r(),p("div",{key:c.key,class:"widget-account-session__item"},[_("div",J,S(c.label),1),_("div",K,S(c.value),1),G(n,{loading:l(e).loading>0},null,8,["loading"])]))),128))])],2)}}}),nt=B({__name:"account-session",setup(m){M({title:"Виджет Сессии Аккаунта"});const o=U(),e=$(()=>y.makeAccountSessionWidgetFilters(o.query));return(u,v)=>{const d=Q,g=E;return r(),w(g,null,{default:k(()=>[l(e)?(r(),w(d,{key:0,class:"widgets-account-session-page",params:l(e)},null,8,["params"])):z("",!0)]),_:1})}}});export{nt as default};
