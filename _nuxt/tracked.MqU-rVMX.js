import{_ as V}from"./nuxt-link.L0yXcBJ9.js";import{_ as W}from"./WinRate.vue.CRSh5IUU.js";import{_ as q}from"./RatingIcon.vue.4uO5v5Kn.js";import{h as v,_ as M,a as F}from"./disableScroll.C0aRP9sA.js";import{_ as G}from"./TablePagination.vue.YWKQ08UD.js";import{_ as H}from"./CTable.vue.Nq0ui9O0.js";import{_ as J}from"./ContentLoader.vue.CZ7Avnj8.js";import{n as B}from"./notEmpty.BxBPJGBn.js";import{s as g,a as R}from"./request.2vtDDBdm.js";import{s as S}from"./index.DVI7ejDe.js";import{n as K,A as T,B as Q,s as U,c as r,b as p,w as o,x,a as A,C as X,o as c,v as k,d as I,t as f}from"./entry.C7rsCkde.js";const Y={class:"account-tracked"},Z=A("div",{class:"account-tracked__description content-area",style:{"max-width":"800px"}},[A("p",null,"Список игроков, статистика которых отслеживается. Данные хранятся в браузере."),A("p",null," Отслеживание начинается с момента просмотра аккаунта на данном ресурсе. После удаления из списка - отслеживание прекращается. ")],-1),tt={key:1},at={key:0},nt={key:1},et={key:1},ct={key:1},it={key:0},ot={key:1},st={key:1},bt=K({__name:"tracked",setup(lt){const e=T({loading:0,items:[],accountsLocal:null}),m=T({total:0,page:1,pageSize:100}),$=[{key:"nickname",label:"Ник"},{key:"clan",label:"Клан"},{key:"battles",label:"Боёв"},{key:"winRate",label:"Побед"},{key:"damagePerBattle",label:"Урон"},{key:"rating",label:"Рейтинг"},{key:"lastBattleTime",width:160,label:"Последний бой",formatter:t=>typeof t=="number"?X.date.toRelativeTime(t*1e3):"---"},{key:"actions",width:60}];Q(()=>{D()});const C=U(()=>{const t=m.page*m.pageSize,n=t-m.pageSize;return(e.accountsLocal??[]).filter(B).slice(n,t)});async function L(){e.loading++;try{const t=await g.indexedDB.accountsInfo.getAll();e.accountsLocal=(t??[]).map(n=>n.data).sort((n,d)=>d.last_battle_time-n.last_battle_time),m.total=(t==null?void 0:t.length)??0}catch(t){v(t,{title:"Ошибка поучения локального списка аккаунтов"})}e.loading--}async function P(t){e.loading++;try{const n=await R.account.getInfo({extra:"statistics.rating",account_id:t.join(",")});return Object.values(n.data).filter(B)}catch(n){return v(n,{title:"Ошибка поучения списка аккаунтов"}),[]}finally{e.loading--}}async function N(t){e.loading++;try{const{data:n}=await R.clan.getAccountInfo({extra:"clan",account_id:t.join(",")});return Object.values(n).filter(B)}catch(n){return v(n,{title:"Ошибка поучения списка клановых аккаунтов"}),[]}finally{e.loading--}}async function D(){var t;e.accountsLocal||await L(),(t=e.accountsLocal)!=null&&t.length&&await w()}function j(t,n){const d=C.value.map(l=>{const s=t.find(_=>_.account_id===l.account_id);if(!s)return{id:l.account_id,nickname:l.nickname,lastBattleTime:NaN,isDeleted:!0,statistic:null,clan:null};const u=s.statistics,y=S.accountAll(u.all),h=u.rating?S.accountRating(u.rating):null,{clan:b}=n.find(_=>(_==null?void 0:_.account_id)===s.account_id)??{};return{id:s.account_id,nickname:s.nickname,lastBattleTime:s.last_battle_time,statistic:{all:y,rating:h},clan:b??null}});e.items=d.sort((l,s)=>s.lastBattleTime-l.lastBattleTime)}async function w(){const t=C.value.map(l=>l.account_id);if(!t.length)return;const[n,d]=await Promise.all([P(t),N(t)]);j(n,d)}async function E(t){await Promise.all([g.indexedDB.accountsInfo.remove(t),g.indexedDB.accountsAchievements.remove(t),g.indexedDB.tanksStat.remove(t)])}async function z(t){await E(t),e.items.length<m.total?e.items=e.items.filter(n=>n.id!==t):await D()}async function O(){await w()}return(t,n)=>{const d=V,l=W,s=q,u=M,y=F,h=G,b=H,_=J;return c(),r("div",Y,[Z,p(b,{"no-wrap":"","scroll-to-top":"","scroll-auto-disabling":"",headers:$,data:x(e).items,height:"calc(100vh - 112px)"},{nickname:o(({row:a})=>[a.isDeleted?(c(),r("span",tt,f(a.nickname),1)):(c(),k(d,{key:0,class:"account-tracked__link link",to:{name:"account-id",params:{id:a.id}}},{default:o(()=>[I(f(a.nickname),1)]),_:2},1032,["to"]))]),battles:o(({row:a})=>{var i;return[a.isDeleted?(c(),r("span",nt,"---")):(c(),r("span",at,f((i=a.statistic)==null?void 0:i.all.battles),1))]}),winRate:o(({row:a})=>{var i;return[a.isDeleted?(c(),r("span",et,"---")):(c(),k(l,{key:0,"model-value":(i=a.statistic)==null?void 0:i.all.winRate,class:"account-tracked__win-rate"},null,8,["model-value"]))]}),rating:o(({row:a})=>{var i;return[a.isDeleted?(c(),r("span",ct,"---")):(c(),k(s,{key:0,rating:(i=a.statistic)==null?void 0:i.rating},null,8,["rating"]))]}),damagePerBattle:o(({row:a})=>{var i;return[a.isDeleted?(c(),r("span",ot,"---")):(c(),r("span",it,f((i=a.statistic)==null?void 0:i.all.damagePerBattle),1))]}),clan:o(({row:a})=>[a.clan?(c(),k(d,{key:0,title:a.clan.name,class:"account-tracked__link link",to:{name:"clan-id",params:{id:a.clan.clan_id}}},{default:o(()=>[I(f(a.clan.tag),1)]),_:2},1032,["title","to"])):(c(),r("span",st,"---"))]),actions:o(({row:a})=>[p(y,{title:"Удалить","is-text":"","is-square":"",onClick:i=>z(a.id)},{default:o(()=>[p(u,{name:"delete"})]),_:2},1032,["onClick"])]),footer:o(()=>[p(h,{pagination:x(m),onChange:O},null,8,["pagination"])]),_:1},8,["data"]),p(_,{loading:x(e).loading>0},null,8,["loading"])])}}});export{bt as default};
