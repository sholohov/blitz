import{_ as q}from"./BWArym7p.js";import{_ as O}from"./B5RtmFoY.js";import{_ as U}from"./DK6Y3mmo.js";import{d as G,j as D,k as H,v as R,m as b,c as M,l as S,o as c,n as _,p as v,g as p,w as o,e as x,_ as W,x as F,b as g,q as T,t as f,s as J}from"./CbpaTVLF.js";import{_ as K}from"./Bgrq7DBB.js";import{_ as Q}from"./BYsS9vqb.js";import{_ as X}from"./BufGgsVL.js";import{n as B}from"./BxBPJGBn.js";import{s as C}from"./C04RlcEn.js";import"./DD4asW33.js";const Y={class:"account-tracked"},Z={key:1},tt={key:0},at={key:1},nt={key:1},et={key:1},ct={key:0},it={key:1},st={key:1},yt=G({__name:"tracked",setup(ot){const e=D({loading:0,items:[],accountsLocal:null}),m=D({total:0,page:1,pageSize:100}),I=[{key:"nickname",label:"Ник"},{key:"clan",label:"Клан"},{key:"battles",label:"Боёв"},{key:"winRate",label:"Побед"},{key:"damagePerBattle",label:"Урон"},{key:"rating",label:"Рейтинг"},{key:"lastBattleTime",width:160,label:"Последний бой",formatter:t=>typeof t=="number"?J.date.toRelativeTime(t*1e3):"---"},{key:"actions",width:60}];H(()=>{w()});const A=M(()=>{const t=m.page*m.pageSize,a=t-m.pageSize;return(e.accountsLocal??[]).filter(B).slice(a,t)});async function L(){e.loading++;try{const{$indexedDB:t}=R(),a=await t.accountsInfo.getAll();e.accountsLocal=(a??[]).map(l=>l.data).sort((l,s)=>s.last_battle_time-l.last_battle_time),m.total=(a==null?void 0:a.length)??0}catch(t){b(t,{title:"Ошибка поучения локального списка аккаунтов"})}e.loading--}async function P(t){e.loading++;try{const a=await S.account.getInfo({extra:"statistics.rating",account_id:t.join(",")});return Object.values(a.data).filter(B)}catch(a){return b(a,{title:"Ошибка поучения списка аккаунтов"}),[]}finally{e.loading--}}async function N(t){e.loading++;try{const{data:a}=await S.clan.getAccountInfo({extra:"clan",account_id:t.join(",")});return Object.values(a).filter(B)}catch(a){return b(a,{title:"Ошибка поучения списка клановых аккаунтов"}),[]}finally{e.loading--}}async function w(){var t;e.accountsLocal||await L(),(t=e.accountsLocal)!=null&&t.length&&await $()}function j(t,a){const l=A.value.map(s=>{const r=t.find(d=>d.account_id===s.account_id);if(!r)return{id:s.account_id,nickname:s.nickname,lastBattleTime:NaN,isDeleted:!0,statistic:null,clan:null};const u=r.statistics,k=C.accountAll(u.all),y=u.rating?C.accountRating(u.rating):null,{clan:h}=a.find(d=>(d==null?void 0:d.account_id)===r.account_id)??{};return{id:r.account_id,nickname:r.nickname,lastBattleTime:r.last_battle_time,statistic:{all:k,rating:y},clan:h??null}});e.items=l.sort((s,r)=>r.lastBattleTime-s.lastBattleTime)}async function $(){const t=A.value.map(s=>s.account_id);if(!t.length)return;const[a,l]=await Promise.all([P(t),N(t)]);j(a,l)}async function E(t){const{$indexedDB:a}=R();await Promise.all([a.accountsInfo.remove(t),a.accountsAchievements.remove(t),a.tanksStat.remove(t)])}async function z(t){await E(t),e.items.length<m.total?e.items=e.items.filter(a=>a.id!==t):await w()}async function V(){await $()}return(t,a)=>{const l=q,s=O,r=U,u=F,k=W,y=K,h=Q,d=X;return c(),_("div",Y,[a[0]||(a[0]=v("div",{class:"account-tracked__description content-area",style:{"max-width":"800px"}},[v("p",null,"Список игроков, статистика которых отслеживается. Данные хранятся в браузере."),v("p",null," Отслеживание начинается с момента просмотра аккаунта на данном ресурсе. После удаления из списка - отслеживание прекращается. ")],-1)),p(h,{"no-wrap":"","scroll-to-top":"","scroll-auto-disabling":"",headers:I,data:x(e).items,height:"calc(100vh - 112px)"},{nickname:o(({row:n})=>[n.isDeleted?(c(),_("span",Z,f(n.nickname),1)):(c(),g(l,{key:0,class:"account-tracked__link link",to:{name:"account-id",params:{id:n.id}}},{default:o(()=>[T(f(n.nickname),1)]),_:2},1032,["to"]))]),battles:o(({row:n})=>{var i;return[n.isDeleted?(c(),_("span",at,"---")):(c(),_("span",tt,f((i=n.statistic)==null?void 0:i.all.battles),1))]}),winRate:o(({row:n})=>{var i;return[n.isDeleted?(c(),_("span",nt,"---")):(c(),g(s,{key:0,"win-rate":(i=n.statistic)==null?void 0:i.all.winRate,class:"account-tracked__win-rate"},null,8,["win-rate"]))]}),rating:o(({row:n})=>{var i;return[n.isDeleted?(c(),_("span",et,"---")):(c(),g(r,{key:0,rating:(i=n.statistic)==null?void 0:i.rating},null,8,["rating"]))]}),damagePerBattle:o(({row:n})=>{var i;return[n.isDeleted?(c(),_("span",it,"---")):(c(),_("span",ct,f((i=n.statistic)==null?void 0:i.all.damagePerBattle),1))]}),clan:o(({row:n})=>[n.clan?(c(),g(l,{key:0,title:n.clan.name,class:"account-tracked__link link",to:{name:"clan-id",params:{id:n.clan.clan_id}}},{default:o(()=>[T(f(n.clan.tag),1)]),_:2},1032,["title","to"])):(c(),_("span",st,"---"))]),actions:o(({row:n})=>[p(k,{title:"Удалить","is-text":"","is-square":"",onClick:i=>z(n.id)},{default:o(()=>[p(u,{name:"delete"})]),_:2},1032,["onClick"])]),footer:o(()=>[p(y,{pagination:x(m),onChange:V},null,8,["pagination"])]),_:1},8,["data"]),p(d,{loading:x(e).loading>0},null,8,["loading"])])}}});export{yt as default};
