import{_ as L}from"./BFjkyBEs.js";import{h as U,_ as D,u as O}from"./C2BuzcM2.js";import{_ as N}from"./BfF4LBiS.js";import{_ as P}from"./DIC5o3iZ.js";import{f as x,q as I,r as b,i as j,o as d,j as S,w as r,k as y,c as v,b as a,a as s,d as g,t as B,m as w,W as q,$ as z,T as G,F as W,A as H,C as K,g as J,z as Q,L as X}from"./C1pZ3Ysy.js";import{s as h,o as Y,d as Z,a as C}from"./DIwkXMey.js";import{_ as R}from"./DYVPuHM_.js";import{_ as ee}from"./Bgql84gp.js";import{_ as te}from"./CT3UIwUl.js";import{a as k}from"./CEfgnHem.js";import{u as oe}from"./YOq-_6aY.js";import{u as ne}from"./BR5uHrNA.js";import{u as se}from"./Ba3yjCYF.js";import"./BrX1J4SK.js";import"./BxBPJGBn.js";import"./VCkIz5Ac.js";const ae={key:0,class:"update-message"},ie={class:"update-message__title"},ce=s("div",{class:"update-message__body"}," Что бы изменения вступили в силу, необходимо обновить страницу. ",-1),re={class:"update-message__control"},_e=x({__name:"UpdateMessage",setup($){I(()=>{l()});const _=b(!1),i=b(null),n=z(),p=j(()=>{const f=n.public.clientVersion;return!i.value||!f||_.value?!1:i.value!==f});function l(){const f=h.firebase.db();Y(Z(f,"app","info"),m=>{const u=m.data();i.value=(u==null?void 0:u.version)??null},m=>{U(m,{title:"Получение данных версии из Firebase"})})}function o(){location.reload()}function c(){_.value=!0}return(f,m)=>{const u=D,e=N,t=P;return d(),S(q,{name:"update-message-"},{default:r(()=>[y(p)?(d(),v("div",ae,[a(t,{class:"update-message__inner"},{default:r(()=>[s("div",ie,[a(u,{class:"update-message__icon",name:"new-releases"}),g(" Обновление v"+B(y(i)),1)]),ce,s("div",re,[a(e,{class:"update-message__btn",onClick:o},{default:r(()=>[g(" Обновить ")]),_:1}),a(e,{class:"update-message__btn",onClick:c},{default:r(()=>[g(" Скрыть ")]),_:1})])]),_:1})])):w("",!0)]),_:1})}}}),le={class:"update-db-dialog__header"},ue=s("b",null,"База данных обновлена",-1),de=s("br",null,null,-1),pe=s("br",null,null,-1),fe=s("br",null,null,-1),me=s("br",null,null,-1),ge={style:{display:"flex","justify-content":"flex-end"}},he=x({__name:"UpdateDBDialog",emits:["confirm"],setup($,{expose:_,emit:i}){const n=b(null),p=i;function l(){var c;(c=n.value)==null||c.doClose(),p("confirm")}function o(){var c;(c=n.value)==null||c.doOpen()}return _({open:o}),(c,f)=>{const m=D,u=N,e=R;return d(),S(e,{ref_key:"dialogRef",ref:n,class:"update-db-dialog","modal-enabled":"",width:"480px"},{title:r(()=>[s("div",le,[a(m,{class:"update-db-dialog__icon",name:"database-alert"}),ue])]),footer:r(()=>[s("div",ge,[a(u,{onClick:l},{default:r(()=>[g(" Так точно ")]),_:1})])]),default:r(()=>[g(" Для продолжения использования необходимо: "),de,g(" 1. Закрыть все вкладки ресурса, кроме активной."),pe,g(" 2. Обновить текущую страницу."),fe,g(" 3. Готово."),me]),_:1},512)}}}),ye={class:"ui-notification"},ve={key:0,class:"ui-notification__item-title"},be={class:"ui-notification__item-body"},ke=["onClick"],Ue=x({__name:"UiNotification",props:{appendToBody:Boolean},setup($){const _=O(),i=n=>{if(n.title)return n.title;switch(n.type){case"success":return"Успешно";case"error":return"Ошибка";case"info":return"Информация";case"warning":return"Внимание";default:return n.title}};return(n,p)=>{const l=te;return d(),S(l,null,{default:r(()=>[s("div",ye,[a(G,{tag:"ul",class:"ui-notification__list",name:"ui-notification__item-"},{default:r(()=>[(d(!0),v(W,null,H(y(_).items,o=>(d(),v("li",{key:o.id,class:K(["ui-notification__item",[o.type?"ui-notification__item--"+o.type:""]])},[o.title||o.type?(d(),v("div",ve,B(i(o)),1)):w("",!0),s("div",be,B(o.message),1),s("button",{class:"ui-notification__item-close",onClick:c=>y(_).remove(o)},null,8,ke)],2))),128))]),_:1})])]),_:1})}}}),xe={class:"layout"},Pe=x({__name:"default",setup($){const _=J(),i=se(),n=oe(),p=ne(),l=b(null),o=b(null);f(),u(),Q(()=>_.fullPath,async(e,t)=>{e!==t&&(await m(),p.toggleMainSearch(!1))}),X(()=>{var e,t;p.mainSearchOpened?(e=l.value)==null||e.doOpen():(t=l.value)==null||t.doClose()}),I(()=>{try{const e=h.storage.getUser();e&&n.setUser({accountId:Number(e.account_id),name:e.nickname}),i.init()}catch(e){U(e,{title:"Инициализация"})}}),C.request.onError=({error:e})=>{(e==null?void 0:e.message)==="INVALID_ACCESS_TOKEN"&&(k.auth.logout(),n.resetUser(),h.storage.removeUser(),location.assign("/"))};async function c(e){try{await k.auth.login({id:e.account_id,token:e.access_token,expiresAt:new Date(+e.expires_at*1e3).toISOString()}),await k.user.set({id:e.account_id,name:e.nickname})}catch(t){console.error(t),U(t,{title:"Авторизация"}),await C.auth.logout()}}function f(){const e=h.url.getUser();e&&(h.storage.setUser(e),history.replaceState(null,document.title,location.pathname),c(e))}async function m(){const e=h.storage.getUser();if(e)try{await k.user.action({id:e.account_id})}catch(t){U(t,{title:"Действие пользователя",message:"[SELF API] "+(t instanceof Error?t.message:"Неизвестная ошибка")})}}async function u(){const e=await h.indexedDB.getInstance();e.onBlocked=()=>{var t;return(t=o.value)==null?void 0:t.open()}}return(e,t)=>{const E=L,M=_e,T=he,V=ee,A=R,F=Ue;return d(),v("div",xe,[a(E),a(M),a(T,{ref_key:"updateDBRef",ref:o},null,512),y(i).isTablet?(d(),S(A,{key:0,ref_key:"searchDialogRef",ref:l,title:"Поиск аккаунтов и кланов",width:"480px",position:"top",onClose:t[0]||(t[0]=Se=>y(p).toggleMainSearch(!1))},{default:r(()=>[a(V,{style:{height:"270px"}})]),_:1},512)):w("",!0),a(F)])}}});export{Pe as default};
