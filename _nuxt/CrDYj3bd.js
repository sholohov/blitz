import{_ as mt}from"./BYjQXuNZ.js";import{d as X,x as Z,y as ft,r as W,j as T,k as nt,z as _t,A as st,o as R,l as B,m as r,h as l,f as C,F as at,B as pt,C as gt,t as _,g as ht,D as J,p as q,u as yt,b as vt,a as bt,c as tt,q as m,w as i,v as kt,e as At,_ as St}from"./CKv8GwDH.js";import{_ as wt}from"./Bm14zLTW.js";import{_ as $t}from"./25F-AMWF.js";import{_ as It}from"./DWhwL8Z4.js";import{_ as Rt}from"./CKJ7yeoF.js";import{_ as ot}from"./CFptAKa4.js";import{_ as Ct}from"./DZDyBeSB.js";import{u as x}from"./CI5TTA92.js";import{d as Et}from"./CA4v15a9.js";import{_ as Lt}from"./C3Jxsgfw.js";import{n as et}from"./BxBPJGBn.js";import{c as Bt}from"./DSHhIHB-.js";import{f as V}from"./BzMHqnrr.js";import{s as P}from"./C4oTPxE3.js";import"./DD4asW33.js";import"./di2ZG6aq.js";import"./RPJY7rI9.js";const Pt={class:"ui-search__inner"},xt={class:"ui-search__input"},Ot={key:0,class:"ui-search__dropdown"},Dt=["onKeydown","onClick"],Tt=X({__name:"UiSearch",props:Z({items:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1},placeholder:{type:String,default:void 0}},{modelValue:{required:!0,default:""},modelModifiers:{}}),emits:Z(["reset","input","select"],["update:modelValue"]),setup(p,{emit:g}){const t=ft(p,"modelValue"),h=p,y=W(),u=W(null),a=T({isOpen:!1,btnList:[],focusedElemIndex:-1});nt(()=>{window.addEventListener("click",o)}),_t(()=>{window.removeEventListener("click",o)});const E=g;st(()=>h.items,()=>{a.isOpen=h.items.length>0,S()});function k(){E("reset"),a.focusedElemIndex=-1,a.isOpen=!1}function o(c){var d;(d=y.value)!=null&&d.contains(c.target)||(a.isOpen=!1)}function A(c){E("select",c),a.isOpen=!1,setTimeout(()=>{var d;return(d=u.value)==null?void 0:d.focus},300)}function S(){var c;(c=y.value)==null||c.querySelectorAll(".ui-search__item-btn").forEach(d=>{a.btnList.push(d)})}function f(c){var L,O,w,D,N,U;const d=c.target;h.loading||(c.key==="Escape"&&(k(),a.focusedElemIndex=-1,(L=u.value)==null||L.focus()),d.tagName==="INPUT"&&(a.focusedElemIndex=-1),c.key==="ArrowUp"&&(c.preventDefault(),(O=a.btnList)!=null&&O.length&&a.focusedElemIndex>0?(w=a.btnList[--a.focusedElemIndex])==null||w.focus():(D=u.value)==null||D.focus()),c.key==="ArrowDown"&&(c.preventDefault(),(N=a.btnList)!=null&&N.length&&a.focusedElemIndex<a.btnList.length-1&&((U=a.btnList[++a.focusedElemIndex])==null||U.focus())))}return(c,d)=>{const L=Ct,O=ot;return R(),B("div",{ref_key:"rootRef",ref:y,class:"ui-search"},[r("div",Pt,[r("div",xt,[l(L,{ref_key:"inputRef",ref:u,modelValue:t.value,"onUpdate:modelValue":d[0]||(d[0]=w=>t.value=w),modelModifiers:{trim:!0},placeholder:p.placeholder,type:"search",onKeydown:f},null,8,["modelValue","placeholder"])]),C(a).isOpen?(R(),B("div",Ot,[r("ul",{class:"ui-search__list",onKeydown:f},[(R(!0),B(at,null,pt(p.items,w=>(R(),B("li",{key:String(w.value),class:"ui-search__item"},[r("button",{class:"ui-search__item-btn",onKeydown:gt(D=>A(w),["enter"]),onClick:D=>A(w)},_(w.label),41,Dt)]))),128))],32),l(O,{loading:p.loading},null,8,["loading"])])):ht("",!0)])],512)}}}),jt={class:"account-sessions-search"},Vt=X({__name:"AccountSessionsSearch",emits:["select"],setup(p,{emit:g}){const t=T({items:[],loading:0,search:""}),h=g;async function y(k=""){t.loading++;try{const A=((await J.session.account.getList({query:k})).data||[]).map(S=>({label:S.raw.nickname,value:S.raw.account_id}));if(A.length){const S=await q.clan.getAccountInfo({extra:"clan",account_id:A.map(f=>f.value).join(",")}).catch(()=>({data:null}));S.data&&A.forEach(f=>{var d,L;const c=(L=(d=S.data[String(f.value)])==null?void 0:d.clan)==null?void 0:L.tag;f.label+=c?` [${c}]`:""})}t.items=A}catch(o){x(o,{title:"Поиск аккаунта"})}t.loading--}const u=Et(y,1e3,{leading:!0});st(()=>t.search,async()=>{if(t.search.length<=2){t.items=[];return}await u(t.search)});function a(k){t.items=[],t.search="",h("select",k)}function E(){t.search="",t.items=[]}return(k,o)=>{const A=Tt;return R(),B("div",jt,[l(A,{modelValue:C(t).search,"onUpdate:modelValue":o[0]||(o[0]=S=>C(t).search=S),placeholder:"Введите ник игрока",items:C(t).items,loading:C(t).loading>0,onSelect:a,onReset:E},null,8,["modelValue","items","loading"])])}}}),it=(p,g)=>{if(p===g)return!0;if(p===null||g===null||typeof p!="object"||typeof g!="object")return!1;const t=Object.keys(p),h=Object.keys(g);if(t.length!==h.length)return!1;for(let y=0;y<t.length;y+=1){const u=t[y];if(!h.includes(u)||!it(p[u],g[u]))return!1}return!0},qt={class:"account-sessions"},Nt={class:"account-sessions__description content-area",style:{"max-width":"800px"}},Ut={class:"account-sessions__filters"},Ft={class:"account-sessions__filters-item"},Kt={class:"account-sessions__filters-item"},zt={class:"account-sessions__table"},Mt={class:"account-sessions__sub"},Qt={class:"account-sessions__sub"},Ht={key:1},Gt={class:"account-sessions__win-rate--sub"},Wt={class:"account-sessions__sub"},Jt={key:1},Xt={class:"account-sessions__sub"},Yt={class:"account-sessions__sub"},he=X({__name:"sessions",setup(p){yt({title:"Сессии / Аккаунты"});const g=W(null),t=T({loading:0,items:[],achievementsInfo:null,achievementsSessions:[],achievements:null,clanAccounts:null,accounts:[],accountsSessions:[]}),h=vt(),y=bt(),u=T({total:0,page:1,pageSize:100}),a={order:"desc",prop:"updateAt"},E=T(a),k=V.makeAccountSessionsFilters(),o=T(Bt(k)),A=tt(()=>{const e=[{key:"nickname",label:"Ник",sortable:"custom"},{key:"clan",label:"Клан"},{key:"battles",label:"Боёв"},{key:"winRate",label:"Побед"},{key:"damagePerBattle",label:"Урон"},{key:"teamPoints",label:"КМД *"},{key:"updateAt",width:180,label:"Дата начала",sortable:"custom"},{key:"last_battle_time",width:180,label:"Последний бой"}];return o.ids.length&&e.push({key:"actions"}),e}),S=tt(()=>!it(o,k));nt(()=>{Object.assign(o,V.makeAccountSessionsFilters({...k,...y.query})),f()});async function f(){t.loading++,await d(o.ids);const e=t.accountsSessions.map(n=>n.id);e.length&&(await Promise.all([O(),L(e),w(e),D(e),N(e)]),c()),t.loading--}function c(){t.items=t.accountsSessions.map(({raw:e,updateAt:n,id:$})=>{var s,b,Y;const I=t.accounts.find(G=>G.account_id===$);if(!I)return null;const v={...e,statistics:P.diffFull(I.statistics,e.statistics),updateAt:new Date(n).valueOf()},j=v.statistics,M=P.accountAll(j.all),Q=j.rating?P.accountRating(j.rating):null,H=(b=(s=t.clanAccounts)==null?void 0:s[v.account_id])==null?void 0:b.clan,F=t.achievementsSessions.find(G=>G.id===v.account_id);let K=NaN;const z=(Y=t.achievements)==null?void 0:Y[v.account_id];return z&&F&&t.achievementsInfo&&(K=P.teamPoints(v.statistics,P.accountAchievementsDiff(z,F.raw,t.achievementsInfo))),{updateAt:v.updateAt,id:v.account_id,nickname:v.nickname,lastBattleTime:I.last_battle_time,teamPoints:K,currentStatistic:{all:P.accountAll(I.statistics.all),rating:I.statistics.rating?P.accountRating(I.statistics.rating):null},statistic:{all:M,rating:Q},clan:H??null}}).filter(et)}async function d(e){t.loading++;try{const{data:n,meta:$}=await J.session.account.getList({ids:e,pageSize:u.pageSize,page:u.page,sort:`${E.prop}:${E.order}`});u.total=($==null?void 0:$.total)??0,t.accountsSessions=n}catch(n){x(n,{title:"Ошибка поучения сессий аккаунтов"})}t.loading--}async function L(e){t.loading++;try{const{data:n}=await J.session.accountAchievements.getList({ids:e,pageSize:u.pageSize});t.achievementsSessions=n}catch(n){x(n,{title:"Ошибка поучения сессий достижений"})}t.loading--}async function O(){if(!t.achievementsInfo){t.loading++;try{const{data:e}=await q.encyclopedia.getAchievements();t.achievementsInfo=e??null}catch(e){x(e,{title:"Ошибка поучения описания достижений"})}t.loading--}}async function w(e){t.loading++;try{const n=await q.account.getInfo({extra:"statistics.rating",account_id:e.join(",")});t.accounts=Object.values(n.data).filter(et)??null}catch(n){x(n,{title:"Ошибка поучения списка аккаунтов"})}t.loading--}async function D(e){t.loading++;try{const{data:n}=await q.account.getAchievements({account_id:e.join(",")});t.achievements=n??null}catch(n){x(n,{title:"Ошибка поучения списка достижений аккаунтов"})}t.loading--}async function N(e){t.loading++;try{const{data:n}=await q.clan.getAccountInfo({extra:"clan",account_id:e.join(",")});t.clanAccounts=n??null}catch(n){x(n,{title:"Ошибка поучения списка клановых аккаунтов"})}t.loading--}function U(e){E.order=e.order,E.prop=e.prop,f()}async function ct({value:e}){var n;await((n=g.value)==null?void 0:n.doClose()),o.ids.includes(e)||(o.ids=[...o.ids,e]),await h.push({query:{...y.query,...V.toRouteQuery(o)}}),await f()}function lt(){var e;(e=g.value)==null||e.doOpen()}function rt(e){t.items=t.items.filter(n=>n.id!==e.id),o.ids=t.items.map(n=>n.id),h.push({query:V.toRouteQuery(o)}),f()}async function ut(){Object.assign(o,k),await h.push({query:V.toRouteQuery(o)}),f()}async function dt(e){Object.assign(u,e),await f()}return(e,n)=>{const $=mt,I=St,v=kt,j=wt,M=$t,Q=It,H=Rt,F=ot,K=Vt,z=Lt;return R(),B("div",qt,[r("div",Nt,[r("p",null,[n[1]||(n[1]=m(' "Сессии" - статистика пользователей за определённый период. Активировать сбор статистики можно через ')),l($,{to:{name:"widgets"}},{default:i(()=>n[0]||(n[0]=[m(" виджет сессии ")])),_:1}),n[2]||(n[2]=m(" . Данные хранятся на сервере ресурса. "))]),r("ul",null,[r("li",null,[n[4]||(n[4]=r("b",null,"Командная игра (КМД)",-1)),n[5]||(n[5]=m(" - сумма нескольких показателей, основной смысл - оценка игры взводом. Подробнее на ")),l($,{to:{name:"widgets"}},{default:i(()=>n[3]||(n[3]=[m(" Странице Виджета ")])),_:1})])])]),n[8]||(n[8]=m(" Фильтры ")),r("div",Ut,[r("div",Ft,[l(v,{onClick:lt},{after:i(()=>[l(I,{name:"add"})]),default:i(()=>[n[6]||(n[6]=m(" По игроку "))]),_:1})]),r("div",Kt,[l(v,{disabled:!C(S),onClick:ut},{after:i(()=>[l(I,{name:"close"})]),default:i(()=>[n[7]||(n[7]=m(" Очистить "))]),_:1},8,["disabled"])])]),r("div",zt,[l(H,{"no-wrap":"","scroll-to-top":"","scroll-auto-disabling":"","default-sort":a,headers:C(A),data:C(t).items,height:"calc(100vh - 112px)",onSort:U},{nickname:i(({row:s})=>[l($,{class:"account-sessions__nickname link",to:{name:"account-id",params:{id:s.id}}},{default:i(()=>[m(_(s.nickname),1)]),_:2},1032,["to"])]),battles:i(({row:s})=>{var b;return[m(_(e.$formatter.number.toInteger(s.statistic.all.battles))+" ",1),r("div",Mt,_(e.$formatter.number.toInteger((b=s.currentStatistic)==null?void 0:b.all.battles)||"---"),1)]}),teamPoints:i(({row:s})=>[Number.isNaN(s.teamPoints)?(R(),B("span",Ht," --- ")):(R(),B(at,{key:0},[m(_(e.$formatter.number.toInteger(s.teamPoints/s.statistic.all.battles)||0)+" ",1),r("span",Qt,_(e.$formatter.number.toInteger(s.teamPoints)||0),1)],64))]),winRate:i(({row:s})=>{var b;return[l(j,{"win-rate":s.statistic.all.winRate,class:"account-sessions__win-rate"},null,8,["win-rate"]),r("div",Gt,_(e.$formatter.number.toFloatPercent((b=s.currentStatistic)==null?void 0:b.all.winRate)||"---"),1)]}),rating:i(({row:s})=>[l(M,{rating:s.statistic.rating},null,8,["rating"])]),damagePerBattle:i(({row:s})=>{var b;return[m(_(e.$formatter.number.toInteger(s.statistic.all.damagePerBattle))+" ",1),r("div",Wt,_(e.$formatter.number.toInteger((b=s.currentStatistic)==null?void 0:b.all.damagePerBattle)||"---"),1)]}),clan:i(({row:s})=>[s.clan?(R(),At($,{key:0,title:s.clan.name,class:"account-sessions__clan link",to:{name:"clan-id",params:{id:s.clan.clan_id}}},{default:i(()=>[m(_(s.clan.tag),1)]),_:2},1032,["title","to"])):(R(),B("span",Jt,"---"))]),last_battle_time:i(({row:s})=>[m(_(e.$formatter.date.toRelativeTime(s.lastBattleTime*1e3))+" ",1),r("span",Xt,_(e.$formatter.date.toDateTime(s.lastBattleTime*1e3)),1)]),updateAt:i(({row:s})=>[m(_(e.$formatter.date.toRelativeTime(s.updateAt))+" ",1),r("span",Yt,_(e.$formatter.date.toDateTime(s.updateAt)),1)]),actions:i(({row:s})=>[l(v,{"is-text":"","is-square":"",onClick:b=>rt(s)},{default:i(()=>[l(I,{name:"delete"})]),_:2},1032,["onClick"])]),footer:i(()=>[l(Q,{pagination:C(u),onChange:dt},null,8,["pagination"])]),_:1},8,["headers","data"]),l(F,{loading:C(t).loading>0},null,8,["loading"])]),l(z,{ref_key:"addAccountDialogRef",ref:g,width:"400px",position:"top",title:"Поиск игрока"},{default:i(()=>[l(K,{style:{height:"270px"},onSelect:ct})]),_:1},512)])}}});export{he as default};
