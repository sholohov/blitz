import{_ as O}from"./BnYJ5puK.js";import{_ as U}from"./B4NeK8UY.js";import{_ as G}from"./oNXKW4Md.js";import{d as M,u as h,a as W,b as J,l as T,m as K,n as A,p as R,e as Q,o as l,q as g,s as x,j as p,w as o,g as B,_ as X,y as Y,f as v,t as m,v as k,F as w,x as Z}from"./Divx9Nzj.js";import{_ as tt}from"./Bb1A4uhg.js";import{_ as at}from"./DX4LQXT-.js";import{_ as et}from"./34P0Lxgg.js";import{c as nt}from"./B4FMxlHh.js";import{n as I}from"./BxBPJGBn.js";import{s as C}from"./C77m5c5_.js";import"./DD4asW33.js";const it={class:"account-favorites"},st={key:1},kt=M({__name:"favorites",setup(ot){const{$formatter:F}=h(),S=W();J({title:()=>F.route.getTitle(nt.toString(S.name)??"")});const i=T({loading:0,items:[],favoritesIds:null}),u=T({total:0,page:1,pageSize:100}),P=[{key:"nickname",label:"Ник"},{key:"clan",label:"Клан"},{key:"battles",label:"Боёв"},{key:"winRate",label:"Побед"},{key:"damagePerBattle",label:"Урон"},{key:"rating",label:"Рейтинг"},{key:"lastBattleTime",width:160,label:"Последний бой",formatter:t=>typeof t=="number"?Z.date.toRelativeTime(t*1e3):"---"},{key:"actions",width:60}];K(()=>{b()});const y=Q(()=>{const t=u.page*u.pageSize,a=t-u.pageSize;return(i.favoritesIds??[]).filter(I).slice(a,t)});async function j(){i.loading++;const{$indexedDB:t}=h(),a=await t.accountsFavorites.getAll();i.favoritesIds=(a??[]).filter(n=>n.isFavorite).map(n=>n.id),u.total=i.favoritesIds.length,i.loading--}async function D(t){i.loading++;let a=[];try{const{data:n}=await A.account.getInfo({extra:"statistics.rating",account_id:t.join(",")});a=Object.values(n).filter(I)}catch(n){R(n,{title:"Ошибка поучения списка аккаунтов"})}return i.loading--,a}async function z(t){i.loading++;let a=[];try{const{data:n}=await A.clan.getAccountInfo({extra:"clan",account_id:t.join(",")});a=Object.values(n).filter(I)}catch(n){R(n,{title:"Ошибка поучения списка клановых аккаунтов"})}return i.loading--,a}function E(t,a){const n=y.value.map(d=>{const s=t.find(r=>r.account_id===d);if(!s)return{id:0,nickname:"Deleted",lastBattleTime:0,statistic:{all:null,rating:null},clan:null};const _=s.statistics,f=a.find(r=>(r==null?void 0:r.account_id)===(s==null?void 0:s.account_id));return{id:d,nickname:s.nickname,lastBattleTime:s.last_battle_time,statistic:{all:C.accountAll(_.all),rating:_.rating?C.accountRating(_.rating):null},clan:(f==null?void 0:f.clan)??null}});i.items=n.sort((d,s)=>s.lastBattleTime-d.lastBattleTime)}async function b(){var n;if(i.favoritesIds||await j(),!((n=i.favoritesIds)!=null&&n.length))return;const[t,a]=await Promise.all([D(y.value),z(y.value)]);E(t,a)}async function N(t){const{$indexedDB:a}=h();await a.accountsFavorites.remove(t)}async function L(t){await N(t),i.items.length<u.pageSize?i.items=i.items.filter(a=>a.id!==t):await b()}async function V(){await b()}return(t,a)=>{const n=O,d=U,s=G,_=Y,f=X,r=tt,q=at,H=et;return l(),g("div",it,[a[0]||(a[0]=x("div",{class:"account-favorites__description content-area",style:{"max-width":"800px"}},[x("p",null,' Список игроков добавленных в "Избранные". Данные хранится в браузере. '),x("p",null,'Добавить в избранное, можно нажав "Звёздочку" превью на странице аккаунта.')],-1)),p(q,{"no-wrap":"","scroll-auto-disabling":"",headers:P,data:B(i).items,height:"calc(100vh - 112px)"},{nickname:o(({row:e})=>[e.id?(l(),v(n,{key:0,class:"account-favorites__link link",to:{name:"account-id",params:{id:e.id}}},{default:o(()=>[m(k(e.nickname),1)]),_:2},1032,["to"])):(l(),g(w,{key:1},[m(" Deleted ")],64))]),battles:o(({row:e})=>{var c;return[m(k(((c=e.statistic.all)==null?void 0:c.battles)??"---"),1)]}),winRate:o(({row:e})=>[e.statistic.all?(l(),v(d,{key:0,"win-rate":e.statistic.all.winRate,class:"account-favorites__win-rate"},null,8,["win-rate"])):(l(),g(w,{key:1},[m(" --- ")],64))]),rating:o(({row:e})=>{var c,$;return[(c=e.statistic)!=null&&c.rating?(l(),v(s,{key:0,rating:($=e.statistic)==null?void 0:$.rating},null,8,["rating"])):(l(),g(w,{key:1},[m(" --- ")],64))]}),damagePerBattle:o(({row:e})=>{var c;return[m(k(((c=e.statistic.all)==null?void 0:c.damagePerBattle)??"---"),1)]}),clan:o(({row:e})=>[e.clan?(l(),v(n,{key:0,title:e.clan.name,class:"account-favorites__link link",to:{name:"clan-id",params:{id:e.clan.clan_id}}},{default:o(()=>[m(k(e.clan.tag),1)]),_:2},1032,["title","to"])):(l(),g("span",st,"---"))]),actions:o(({row:e})=>[p(f,{title:"Удалить","is-text":"","is-square":"",onClick:c=>L(e.id)},{default:o(()=>[p(_,{name:"delete"})]),_:2},1032,["onClick"])]),footer:o(()=>[p(r,{pagination:B(u),onChange:V},null,8,["pagination"])]),_:1},8,["data"]),p(H,{loading:B(i).loading>0},null,8,["loading"])])}}});export{kt as default};
