const __vite__fileDeps=["./DNxM2oRs.js","./zpIRGTA2.js","./DlAUqK2U.js","./m8Dh55rh.js","./nuxt-icon.MfBulapQ.css","./DQQc-sXz.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{_ as N,u as _e,h as R}from"./DzvMpuXI.js";import{_ as Y}from"./D_oZ8rmV.js";import{_ as Z}from"./DNOQeB8h.js";import{_ as le}from"./D-nwXDDn.js";import{f as M,r as z,i as F,o as m,c as b,a as t,b as d,w as h,k as r,C as J,t as i,d as p,F as T,A as W,m as B,j as P,D as de,E as K,_ as Q,n as L,q as ie,G as ue,s as X,u as me,g as pe,H as ve,I as fe,O as ee}from"./m8Dh55rh.js";import{s as U,_ as oe,a as H}from"./CpOjFHmQ.js";import{c as he}from"./ZnSD-95i.js";import{_ as be}from"./DSYKTjyk.js";import{_ as we}from"./DFOZicL4.js";import{m as te,_ as ge}from"./CbGrR_Yb.js";import{_ as ye}from"./De0zOVkY.js";import{_ as $e}from"./DDSeaVdk.js";import{f as E}from"./BUlr6pIV.js";import{_ as ke}from"./CeynmSM-.js";import{_ as Ce}from"./DzUtBfm0.js";import{_ as De,m as ae}from"./DNzYZc3o.js";import{_ as Ie}from"./W7mLp8Lh.js";import{s as V}from"./C6Vqeku2.js";import{n as Ae}from"./BxBPJGBn.js";import{c as ne}from"./BJmrtSDD.js";import{a as xe}from"./CnOVbCi4.js";import"./D4D5RG4Q.js";import"./DzWLHGoT.js";import"./zpIRGTA2.js";import"./DlAUqK2U.js";import"./VeiB49Ql.js";import"./DOQ9TOl4.js";const Be={class:"clan-events"},je={class:"clan-events__inner"},Pe={class:"clan-events__count"},Se={class:"clan-events__prop"},Re=t("span",{class:"clan-events__prop-title"}," События от ",-1),Fe={key:0,class:"clan-events__prop"},Me={class:"clan-events__prop-title"},Ee={key:1,class:"clan-events__prop"},Oe={class:"clan-events__prop-title"},qe={key:2},Ue={style:{display:"flex","justify-content":"space-between"}},Te=t("div",null,null,-1),Ve=M({__name:"ClanEvents",props:{savedAt:{type:Number,default:0,required:!0},clan:{type:Object,default:()=>({}),required:!0},savedClan:{type:Object,default:()=>({}),required:!0}},emits:["reset"],setup(a,{emit:v}){const e=a,u=z(null),f=F(()=>{const s=e.clan.members_ids??[],y=e.savedClan.members??[];return Object.values(y).filter($=>!s.includes($.account_id))}),g=F(()=>{var $,C;const s=(($=e.clan)==null?void 0:$.members)??[],y=((C=e.savedClan)==null?void 0:C.members_ids)??[];return Object.values(s).filter(x=>!y.includes(x.account_id))}),w=F(()=>g.value.length+f.value.length),A=v;function k(){var s;A("reset"),(s=u.value)==null||s.doClose()}function n(){var s;(s=u.value)==null||s.doOpen()}function o(){var s;(s=u.value)==null||s.doClose()}return(s,y)=>{const $=N,C=Y,x=Z,O=le;return m(),b("div",Be,[t("div",je,[d(C,{disabled:!r(w),class:J(["clan-events__btn",[r(w)?"clan-events__btn--has-unread":""]]),"is-text":"","is-square":"",title:"События клана",onClick:n},{default:h(()=>[d($,{name:"mail"})]),_:1},8,["disabled","class"]),t("div",Pe,i(r(w)>99?"99+":r(w)),1)]),d(O,{ref_key:"dialogRef",ref:u,width:"640px",title:"События клана"},{title:h(()=>[t("div",Se,[Re,p(" "+i(s.$formatter.date.toDateTime(a.savedAt))+" ("+i(s.$formatter.date.toDaysPassed(a.savedAt,Date.now()))+") ",1)])]),footer:h(()=>[t("div",Ue,[Te,t("div",null,[d(C,{onClick:k},{default:h(()=>[p(" Прочитано ")]),_:1}),d(C,{onClick:o},{default:h(()=>[p(" Закрыть ")]),_:1})])])]),default:h(()=>[r(f).length?(m(),b("div",Fe,[t("span",Me," Покинули ("+i(r(f).length)+") ",1),(m(!0),b(T,null,W(r(f),(l,q)=>(m(),b("span",{key:l.account_id,class:"clan-events__prop-value"},[d(x,{to:{name:"account-id",params:{id:l.account_id}},class:"link"},{default:h(()=>[p(i(l.account_name),1)]),_:2},1032,["to"]),p(i(q+1!==r(f).length?", ":""),1)]))),128))])):B("",!0),r(g).length?(m(),b("div",Ee,[t("span",Oe," Вступили ("+i(r(g).length)+") ",1),(m(!0),b(T,null,W(r(g),(l,q)=>(m(),b("span",{key:l.account_id,class:"clan-events__prop-value"},[d(x,{to:{name:"account-id",params:{id:l.account_id}},class:"link"},{default:h(()=>[p(i(l.account_name),1)]),_:2},1032,["to"]),p(i(q+1!==r(g).length?", ":""),1)]))),128))])):B("",!0),r(w)?B("",!0):(m(),b("span",qe," Пока всё тихо ... "))]),_:1},512)])}}}),Le={class:"social-links"},Ne={class:"social-links__links"},ze=["href","title"],Ge=M({__name:"SocialLinks",props:{links:{type:Array,default:()=>[],required:!0}},setup(a){return(v,e)=>(m(),b("div",Le,[t("div",Ne,[(m(!0),b(T,null,W(a.links,u=>(m(),b("a",{key:u.link,class:"link social-links__links-item",href:u.link,target:"_blank",title:u.title},[(m(),P(de(u.icon)))],8,ze))),128))])]))}}),He=/(https?:\/\/)?(www\.)?(discord\.(gg|io|me|li)|discordapp\.com\/invite)\/.+[a-z|0-9]/gi,We=/(https?:\/\/)?(www\.)?((t|telegram)\.me)\/\+?[a-zA-Z0-9_]{5,32}/gi,Ye=a=>{const v=[],e=a.match(He),u=a.match(We);return e!=null&&e.length&&v.push({title:"Discord",icon:K(()=>Q(()=>import("./DNxM2oRs.js"),__vite__mapDeps([0,1,2,3,4]),import.meta.url)),link:e[0]}),u!=null&&u.length&&v.push({title:"Telegram",icon:K(()=>Q(()=>import("./DQQc-sXz.js"),__vite__mapDeps([5,1,2,3,4]),import.meta.url)),link:u[0]}),v},Ze={class:"clan-preview-details__body"},Je={key:0,class:"clan-preview-details__section"},Ke={class:"clan-preview-details__props-title"},Qe={class:"clan-preview-details__section"},Xe={class:"clan-preview-details__props-title"},et=["textContent"],tt={key:1,class:"clan-preview-details__section"},at={class:"clan-preview-details__props-title"},nt={class:"clan-preview-details__props"},st={class:"clan-preview-details__prop"},lt=t("span",{class:"clan-preview-details__prop-title"}," Создатель ",-1),it={class:"clan-preview-details__prop"},ot=t("span",{class:"clan-preview-details__prop-title"}," Дата создания ",-1),ct={class:"clan-preview-details__prop"},rt=t("span",{class:"clan-preview-details__prop-title"}," Дата обновления ",-1),_t={class:"clan-preview-details__prop"},dt=t("span",{class:"clan-preview-details__prop-title"}," Участников ",-1),ut={key:0,class:"clan-preview-details__prop"},mt=t("span",{class:"clan-preview-details__prop-title"}," Старое название ",-1),pt={class:"clan-preview-details__section"},vt={class:"clan-preview-details__props-title"},ft={class:"clan-preview-details__props"},ht={class:"clan-preview-details__prop"},bt=t("span",{class:"clan-preview-details__prop-title"}," Политика приёма. ",-1),wt=t("div",{class:"clan-preview-details__props-subtitle"}," Пороги статистики для вступления: ",-1),gt={class:"clan-preview-details__prop"},yt=t("span",{class:"clan-preview-details__prop-title"}," Боёв в день ",-1),$t={class:"clan-preview-details__prop"},kt=t("span",{class:"clan-preview-details__prop-title"}," Боёв всего ",-1),Ct={class:"clan-preview-details__prop"},Dt=t("span",{class:"clan-preview-details__prop-title"}," Урон ср. ",-1),It={class:"clan-preview-details__prop"},At=t("span",{class:"clan-preview-details__prop-title"}," Уровень ",-1),xt={class:"clan-preview-details__prop"},Bt=t("span",{class:"clan-preview-details__prop-title"}," Побед ",-1),jt={style:{display:"flex","justify-content":"space-between"}},Pt=M({__name:"ClanPreviewDetails",props:{clan:{type:Object,default:()=>({}),required:!0}},setup(a,{expose:v}){const e=a,u=z(null),f=L({descExpended:!1}),g=F(()=>Ye(e.clan.description??""));function w(){var n;(n=u.value)==null||n.doOpen()}function A(){var n;(n=u.value)==null||n.doClose()}function k(){f.descExpended=!f.descExpended}return v({open:w,close:A}),(n,o)=>{const s=N,y=Y,$=Z,C=Ge,x=le;return m(),P(x,{ref_key:"clanDetailsRef",ref:u,class:"clan-preview-details",title:`[${a.clan.tag}] ${a.clan.name}`,width:"640px"},{footer:h(()=>[t("div",jt,[r(g).length?(m(),P(C,{key:0,class:"clan-preview-details__links",links:r(g)},null,8,["links"])):B("",!0),d(y,{onClick:A},{default:h(()=>[p(" Закрыть ")]),_:1})])]),default:h(()=>[t("div",Ze,[a.clan.motto?(m(),b("div",Je,[t("h5",Ke,[d(s,{class:"clan-preview-details__prop-title-icon",name:"format-quote"}),p(" Девиз ")]),t("i",null,i(a.clan.motto),1)])):B("",!0),t("div",Qe,[t("h5",Xe,[d(s,{class:"clan-preview-details__prop-title-icon",name:"description"}),p(" Описание ")]),a.clan.description?(m(),b("div",{key:0,class:J(["content-area clan-preview-details__desc",r(f).descExpended?"clan-preview-details__desc--expended":""]),textContent:i(a.clan.description)},null,10,et)):B("",!0),d(y,{"is-text":"",class:"clan-preview-details__desc-expend-btn",onClick:k},{default:h(()=>[p(i(r(f).descExpended?"Свернуть":"Развернуть"),1)]),_:1})]),a.clan.motto?(m(),b("div",tt,[t("h5",at,[d(s,{class:"clan-preview-details__prop-title-icon",name:"info"}),p(" Информация ")]),t("div",nt,[t("div",st,[lt,a.clan.creator_id?(m(),P($,{key:0,class:"link",to:a.clan.creator_id?{name:"account-id",params:{id:a.clan.creator_id}}:{}},{default:h(()=>[p(i(a.clan.creator_name),1)]),_:1},8,["to"])):(m(),b(T,{key:1},[p(" Не известен ")],64))]),t("div",it,[ot,p(" "+i(n.$formatter.date.toDate(a.clan.created_at*1e3)),1)]),t("div",ct,[rt,p(" "+i(n.$formatter.date.toDate(a.clan.updated_at*1e3)),1)]),t("div",_t,[dt,p(" "+i(n.$formatter.number.toInteger(a.clan.members_count)),1)]),a.clan.old_tag?(m(),b("div",ut,[mt,p(" ["+i(a.clan.old_tag)+"] "+i(a.clan.old_name),1)])):B("",!0)])])):B("",!0),t("div",pt,[t("h5",vt,[d(s,{class:"clan-preview-details__prop-title-icon",name:"person-search"}),p(" Рекрутинг ")]),t("div",ft,[t("div",ht,[bt,p(" "+i(n.$formatter.clan.recruitingPolicy(a.clan.recruiting_policy))+". ",1)]),a.clan.recruiting_policy==="open"&&a.clan.recruiting_options?(m(),b(T,{key:0},[wt,t("div",gt,[yt,p(" "+i(n.$formatter.number.toInteger(a.clan.recruiting_options.average_battles_per_day)),1)]),t("div",$t,[kt,p(" "+i(n.$formatter.number.toInteger(a.clan.recruiting_options.battles)),1)]),t("div",Ct,[Dt,p(" "+i(n.$formatter.number.toInteger(a.clan.recruiting_options.average_damage)),1)]),t("div",It,[At,p(" "+i(n.$formatter.number.toInteger(a.clan.recruiting_options.vehicles_level)),1)]),t("div",xt,[Bt,p(" "+i(n.$formatter.number.toInteger(a.clan.recruiting_options.wins_ratio))+"% ",1)])],64)):B("",!0)])])])]),_:1},8,["title"])}}}),St={class:"clan-preview"},Rt={class:"clan-preview__inner"},Ft={class:"clan-preview__emblem"},Mt={class:"clan-preview__info"},Et={class:"clan-preview__title"},Ot={class:"clan-preview__tag"},qt={class:"clan-preview__name"},Ut={class:"clan-preview__props"},Tt={class:"clan-preview__prop"},Vt=t("span",{class:"clan-preview__prop-title"}," Участников ",-1),Lt={class:"clan-preview__prop-value"},Nt={class:"clan-preview__prop"},zt=t("span",{class:"clan-preview__prop-title"}," События ",-1),Gt={class:"clan-preview__prop-value"},Ht={class:"clan-preview__actions"},Wt=M({__name:"ClanPreview",props:{clan:{type:Object,default:()=>({}),required:!0},hideDescription:{type:Boolean,default:!1},loading:{type:Boolean,default:!1}},setup(a){const v=a,e=z(null),u=_e(),f=L({isFavorite:!1});ie(()=>{g()});async function g(){const o=await U.indexedDB.clansFavorites.get(v.clan.clan_id);f.isFavorite=o?o==null?void 0:o.isFavorite:!1}async function w(){v.clan&&(f.isFavorite=!f.isFavorite,await U.indexedDB.clansFavorites.set(v.clan.clan_id,{id:v.clan.clan_id,isFavorite:f.isFavorite}))}async function A(){await he(`${v.clan.tag}/${v.clan.clan_id}`)?u.add({type:"success",title:"Скопировано",message:`${v.clan.tag}/${v.clan.clan_id}`,duration:3e3}):u.add({type:"error",message:"Клан копировании что-то пошло не так",duration:3e3})}function k(){var o;(o=e.value)==null||o.open()}function n(){w()}return(o,s)=>{const y=N,$=Y,C=oe,x=Pt;return m(),b("div",St,[t("div",Rt,[t("div",Ft,[d(be,{class:"clan-preview__emblem-img",alt:a.clan.name,emblem:a.clan.emblem_set_id},null,8,["alt","emblem"])]),t("div",Mt,[t("div",Et,[t("span",Ot,"["+i(a.clan.tag??"...")+"]",1),t("span",qt,i(a.clan.name??"..."),1)]),t("div",Ut,[t("div",Tt,[Vt,t("span",Lt,i(a.clan.members_count??"---"),1)]),t("div",Nt,[zt,t("span",Gt,[ue(o.$slots,"events")])])])]),t("div",Ht,[d($,{"is-text":"",class:"clan-preview__actions-btn",title:"Копировать (nickname/ID)",onClick:A},{default:h(()=>[d(y,{name:"content-copy"})]),_:1}),d($,{"is-text":"",class:"clan-preview__actions-btn",title:"Добавить в избранные",onClick:n},{default:h(()=>[r(f).isFavorite?(m(),P(y,{key:0,name:"star"})):(m(),P(y,{key:1,name:"star-border"}))]),_:1}),d($,{"is-text":"",class:"clan-preview__actions-btn",title:"Полная информация",onClick:k},{default:h(()=>[d(y,{name:"info"})]),_:1})])]),d(C,{loading:a.loading},null,8,["loading"]),d(x,{ref_key:"previewDetailsRef",ref:e,clan:a.clan},null,8,["clan"])])}}}),Yt={class:"clan-view-filters"},Zt={class:"clan-view-filters__list"},Jt={class:"clan-view-filters__item clan-view-filters__item--search"},Kt=t("div",{class:"clan-view-filters__item-title"}," Поиск в клане ",-1),Qt={class:"clan-view-filters__item"},Xt=t("div",{class:"clan-view-filters__item-title"}," Дней в клане ",-1),ea={class:"clan-view-filters__item"},ta=t("div",{class:"clan-view-filters__item-title"}," Дней отсутствовал ",-1),aa=M({__name:"ClanViewFilter",props:{filters:{type:Object,required:!0,default:E.makeClanFilters}},emits:["filters-change"],setup(a,{emit:v}){const e=a,u=[{value:null,label:"Не выбрано"},{value:"<3",label:"Меньше чем 3"},{value:"<5",label:"Меньше чем 5"},{value:"<7",label:"Меньше чем 7"},{value:">3",label:"Больше чем 3"},{value:">5",label:"Больше чем 5"},{value:">7",label:"Больше чем 7"}],f=[{value:null,label:"Не выбрано"},{value:"<1",label:"Меньше чем 1"},{value:"<3",label:"Меньше чем 3"},{value:">3",label:"Больше чем 3"},{value:">5",label:"Больше чем 5"},{value:">7",label:"Больше чем 7"}],g=v;function w(A,k){g("filters-change",{...e.filters,[A]:k})}return(A,k)=>{const n=ye,o=$e;return m(),b("div",Yt,[t("div",Zt,[t("div",Jt,[Kt,d(n,{"model-value":a.filters.search,style:{width:"100%"},placeholder:"Введите ник",type:"search","onUpdate:modelValue":k[0]||(k[0]=s=>w("search",s))},null,8,["model-value"])]),t("div",Qt,[Xt,d(o,{"model-value":a.filters.joinedAtDays,style:{width:"150px"},options:u,onChange:k[1]||(k[1]=s=>w("joinedAtDays",s))},null,8,["model-value"])]),t("div",ea,[ta,d(o,{"model-value":a.filters.lastBattleDays,style:{width:"150px"},options:f,onChange:k[2]||(k[2]=s=>w("lastBattleDays",s))},null,8,["model-value"])])])])}}}),na={class:"clan-view-table"},sa={class:"clan-view-table__total"},la={class:"clan-view-table__total-value"},ia={class:"clan-view-table__member"},oa=["title"],ca={key:0,class:"clan-view-table__name clan-view-table__name--deleted"},ra={class:"clan-view-table__sub"},_a={class:"clan-view-table__sub"},da={class:"clan-view-table__sub"},ua={class:"clan-view-table__sub"},ma={class:"clan-view-table__sub"},pa={class:"clan-view-table__sub"},va=M({__name:"ClanViewMembersTable",props:{members:{type:Array,default:()=>[],required:!0},savedMembers:{type:Array,default:()=>[],required:!0},users:{type:Array,default:()=>[],required:!0},sort:{type:Object,default:()=>({}),required:!0}},emits:["sort"],setup(a,{emit:v}){const e=a,u=v,f=[{key:"account_name",label:"Ник",sortable:!0},{key:"battles",label:"Боёв",sortable:!0,sortMethod(n,o){return n.statistic.all.battles-o.statistic.all.battles}},{key:"winRate",label:"Побед",sortable:!0,sortMethod(n,o){return n.statistic.all.winRate-o.statistic.all.winRate}},{key:"damagePerBattle",label:"Урон",sortable:!0,sortMethod(n,o){return n.statistic.all.damagePerBattle-o.statistic.all.damagePerBattle}},{key:"rating",label:"Рейтинг",sortable:!0,sortMethod(n,o){var $,C;const s=(($=n.statistic.rating)==null?void 0:$.rating)??0,y=((C=o.statistic.rating)==null?void 0:C.rating)??0;return s-y}},{key:"battlesPerDay",label:"Боёв в день",sortable:!0},{key:"last_battle_time",label:"Последний бой",sortable:!0},{key:"joined_at",label:"В клане",sortable:!0}],g=F(()=>e.members.map(n=>{const o=e.savedMembers.find(C=>C.account_id===n.account_id),s=o?V.diff(n.statistic.all,o.statistic.all):null,y=V.battlesPerDay({createAt:n.create_at*1e3,battles:n.statistic.all.battles}),$=s?V.battlesPerDay({battles:n.statistic.all.battles-s.battles,createAt:n.create_at*1e3})-y:null;return{...n,battlesPerDay:y,battlesPerDayDiff:$,diff:s}}));function w(n){const o=e.users.find(s=>s.id===n.account_id);return o?{found:!0,online:Date.now()-new Date(o.visitedAt).valueOf()<1e3*60*5}:{found:!1,online:!1}}function A(n){const o=n;return/^del_\d+$/.test(o.account_name)||!o.last_battle_time}function k(n,o){const s=o;return s.diff?n==="winRate"?X.number.toFloatNumber(s.diff[n],!0):X.number.toInteger(s.diff[n],!0):"---"}return(n,o)=>{const s=ke,y=N,$=Z,C=Ce,x=De,O=Ie;return m(),b("div",na,[t("div",sa,[p(" Кол-во: "),t("span",la,i(r(g).length||0),1)]),r(g)?(m(),P(O,{key:0,data:r(g),"default-sort":a.sort,headers:f,"no-wrap":"","scroll-auto-disabling":"","row-key":"account_id",height:"calc(100vh - 112px)",class:"clan-view-table__table",onSort:o[0]||(o[0]=l=>u("sort",l))},{account_name:h(({row:l})=>[t("span",ia,[t("span",{class:J(["clan-view-table__role",["clan-view-table__role--"+l.role,w(l).found?"clan-view-table__role--is-user":"",w(l).online?"clan-view-table__role--is-online":""]]),title:n.$formatter.clan.role(l.role)??"Не известна"},[l.role?(m(),P(s,{key:0,width:"18",height:"18",class:"clan-view-table__role-icon",role:l.role},null,8,["role"])):(m(),P(y,{key:1,style:{width:"16px",color:"var(--color-text-light)"},name:"close"}))],10,oa),A(l)?(m(),b("span",ca,i(l.account_name),1)):(m(),P($,{key:1,class:"link clan-view-table__name",to:{name:"account-id",params:{id:l.account_id}}},{default:h(()=>[p(i(l.account_name),1)]),_:2},1032,["to"]))])]),battles:h(({row:l})=>[p(i(l.statistic.all.battles||"---")+" ",1),t("span",ra,i(k("battles",l)||"---"),1)]),winRate:h(({row:l})=>[d(C,{"win-rate":l.statistic.all.winRate,class:"clan-view-table__win-rate"},null,8,["win-rate"]),t("span",_a,i(k("winRate",l)||"---"),1)]),rating:h(({row:l})=>[d(x,{rating:l.statistic.rating},null,8,["rating"])]),damagePerBattle:h(({row:l})=>[p(i(l.statistic.all.damagePerBattle||"---")+" ",1),t("span",da,i(k("damagePerBattle",l)),1)]),battlesPerDay:h(({row:l})=>[p(i(l.battlesPerDay||"---")+" ",1),t("span",ua,i(n.$formatter.number.toInteger(l.battlesPerDayDiff,!0)||"---"),1)]),last_battle_time:h(({row:l})=>[p(i(n.$formatter.date.toRelativeTime(l.last_battle_time*1e3)||"---")+" ",1),t("span",ma,i(n.$formatter.date.toDateTime(l.last_battle_time*1e3)||"---"),1)]),joined_at:h(({row:l})=>[p(i(n.$formatter.date.toDaysPassed(l.joined_at*1e3)||"---")+" ",1),t("span",pa,i(n.$formatter.date.toDate(l.joined_at*1e3)||"---"),1)]),_:1},8,["data","default-sort"])):B("",!0)])}}}),fa=(a,v)=>{const{prop:e,order:u}=v;return u?a.toSorted((f,g)=>{const w=(u==="desc"?g:f)[e],A=(u==="desc"?f:g)[e];return String(w).localeCompare(String(A),void 0,{numeric:!0,sensitivity:"base"})}):a},ha=a=>{a.sort((v,e)=>v.joined_at-e.joined_at)},ba=a=>{a.sort((v,e)=>{const u={recruit:0,private:1,executive_officer:2,commander:3};return u[e.role]-u[v.role]})},wa=a=>{ha(a),ba(a)},se={smart:fa,clanMembersDefault:wa},ga={key:0,class:"clan-page"},ya={key:1,class:"clan-page--no-data"},$a={key:0,class:"content-area"},ka=t("p",null,"Нет данных.",-1),Ca=t("p",null,"Возможно клан удалён.",-1),Da=[ka,Ca],Xa=M({__name:"[id]",setup(a){me({title:"Инфо / Кланы"});const v=pe(),e=L({loading:0,users:[],clanInfo:null,clan:null,filters:E.makeClanFilters(),statisticsSum:null,savedMembers:[],savedClan:null,metricsItems:te.clan(),clanSavedAt:0,sessionUpdateAt:0,sessionActive:!1}),u=L({order:"desc",prop:""}),f=F(()=>{var _;return((_=e.clan)==null?void 0:_.members)||[]}),g=F(()=>{let _=f.value.filter(I=>{const D=I.account_name.toLowerCase(),j=e.filters.search.toLowerCase();return D.includes(j)});const c=Date.now();if(e.filters.joinedAtDays){const I=E.parseParameter(e.filters.joinedAtDays);_=f.value.filter(D=>E.executeExpression(c-Number(I.value)*ee,D.joined_at*1e3,I.operator))}if(e.filters.lastBattleDays){const I=E.parseParameter(e.filters.lastBattleDays);_=f.value.filter(D=>E.executeExpression(c-Number(I.value)*ee,D.last_battle_time*1e3,I.operator))}return _}),w=z(!1);ie(async()=>{await y(),w.value=!0});async function A(_){e.loading++;try{const{data:c}=await H.clan.getAccountInfo({account_id:_.join(",")});return c}catch(c){return R(c,{title:"Получение данных участников клана"}),null}finally{e.loading--}}async function k(_){e.loading++;try{const{data:c}=await H.clan.getInfo({clan_id:_});e.clanInfo=c[_]??null}catch(c){R(c,{title:"Получение данных клана"})}e.loading--}async function n(_){e.loading++;try{const{data:c}=await xe.user.getList({id:_});e.users=c}catch(c){R(c,{title:"Получение данных аккаунта"})}e.loading--}async function o(_){e.loading++;try{const{data:c}=await H.account.getInfo({extra:"statistics.rating",account_id:_.join(",")});return c}catch(c){return R(c,{title:"Получение данных аккаунта"}),null}finally{e.loading--}}async function s(_){await Promise.all([$(_),x(_)])}async function y(){const _=+v.params.id;if(!_||(await k(_),!e.clanInfo))return;const c=await A(e.clanInfo.members_ids);e.clanInfo.members||(e.clanInfo.members={});for(const j in c){const S=c[j];S&&(e.clanInfo.members[j]={account_id:S.account_id,account_name:S.account_name,joined_at:S.joined_at,role:S.role})}await Promise.all([n(e.clanInfo.members_ids),s(e.clanInfo)]),e.savedClan||await C(e.clanInfo);const I=await o(e.clanInfo.members_ids);if(!I)return;e.clan=ae.clan(e.clanInfo,I);const D=Object.values(I).filter(Ae);e.statisticsSum=D.reduce((j,S,G)=>G===0?D[0].statistics:V.sumFull(j,S.statistics),{}),e.metricsItems=te.clan(D,e.statisticsSum),se.clanMembersDefault(f.value)}async function $(_){e.loading++;try{const c=[];for(const I in _.members){const D=await U.indexedDB.accountsInfo.get(I);D&&(D.data.created_at=D.timestamp,D.timestamp>e.sessionUpdateAt&&(e.sessionUpdateAt=D.timestamp),c.push(ae.clanMember(_.members[I],D.data)))}e.savedMembers=c}catch(c){R(c,{title:"Загрузка локальных данных аккаунтов"})}e.loading--}async function C(_){e.loading++;try{await U.indexedDB.clansInfo.set(_.clan_id,ve(_)),e.savedClan=ne(_),e.clanSavedAt=Date.now()}catch(c){R(c,{title:"Локальное сохранение данных аккаунтов"})}e.loading--}async function x(_){e.loading++;try{const c=await U.indexedDB.clansInfo.get(_.clan_id);e.savedClan=(c==null?void 0:c.data)??null,e.clanSavedAt=(c==null?void 0:c.timestamp)??0}catch(c){R(c,{title:"Загрузка локальных данных клана"})}e.loading--}function O(_){_.order||se.clanMembersDefault(f.value)}async function l(){e.clanInfo&&await C(e.clanInfo)}function q(_){e.filters=ne(_)}return(_,c)=>{const I=Ve,D=Wt,j=we,S=ge,G=aa,ce=va,re=oe;return r(e).clanInfo?(m(),b("div",ga,[d(j,{identity:"preview"},{default:h(()=>[d(D,{class:"clan-page__preview","hide-description":!0,clan:r(e).clanInfo,loading:r(e).loading>0},fe({_:2},[r(e).clanInfo&&r(e).savedClan?{name:"events",fn:h(()=>[d(I,{clan:r(e).clanInfo,"saved-clan":r(e).savedClan,"saved-at":r(e).clanSavedAt,onReset:l},null,8,["clan","saved-clan","saved-at"])]),key:"0"}:void 0]),1032,["clan","loading"])]),_:1}),d(j,{title:"Статистика",identity:"statistic"},{default:h(()=>[d(S,{loading:r(e).loading>0,items:r(e).metricsItems},null,8,["loading","items"])]),_:1}),d(j,{title:"Участники",identity:"members"},{default:h(()=>[d(G,{class:"clan-page__filters",filters:r(e).filters,onFiltersChange:q},null,8,["filters"]),d(ce,{sort:r(u),users:r(e).users,"saved-members":r(e).savedMembers,members:r(g),onSort:O},null,8,["sort","users","saved-members","members"])]),_:1})])):(m(),b("div",ya,[r(w)?(m(),b("div",$a,Da)):B("",!0),d(re,{loading:!r(w)},null,8,["loading"])]))}}});export{Xa as default};
