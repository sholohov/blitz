import{_ as z}from"./nuxt-link.BmjxKRKG.js";import{_ as L}from"./WinRate.vue.8iAWDvYD.js";import{_ as O}from"./RatingIcon.vue.eDdsd4Jb.js";import{_ as V}from"./TablePagination.vue.BZ-wrSe6.js";import{_ as D}from"./CTable.vue.DunflFFB.js";import{_ as F}from"./ContentLoader.vue.5R4WWV0u.js";import{n as _}from"./notEmpty.BxBPJGBn.js";import{u as q}from"./disableScroll.DYMxvxot.js";import{u as M}from"./user.BLX4PKls.js";import{f as U,n as S,i as W,q as G,c as g,b as v,w as l,k as x,a as T,s as H,o as r,j as f,d as u,t as p,F as y}from"./entry.C5iIeEMf.js";import{a as B}from"./request.CetvaxyE.js";import{s as w}from"./index.1j3v_9h4.js";const J={class:"account-contacts"},K=T("div",{class:"account-contacts__description content-area",style:{"max-width":"800px"}},[T("p",null,'Список "Контактов". Данные из игры.')],-1),rt=U({__name:"contacts",setup(Q){const k=q(),C=M(),e=S({loading:0,items:[],account:null,contactsIds:[]}),m=S({total:0,page:1,pageSize:100}),P=[{key:"nickname",label:"Ник"},{key:"clan",label:"Клан"},{key:"battles",label:"Боёв"},{key:"winRate",label:"Побед"},{key:"damagePerBattle",label:"Урон"},{key:"rating",label:"Рейтинг"},{key:"lastBattleTime",width:160,label:"Последний бой",formatter:t=>typeof t=="number"?H.date.toRelativeTime(t*1e3):"---"}],b=W(()=>{const t=m.page*m.pageSize,c=t-m.pageSize;return e.contactsIds.filter(_).slice(c,t)});G(()=>{A()});async function R(t){var c,a;e.loading++;try{const{data:o}=await B.account.getInfo({account_id:t,extra:"private.grouped_contacts"});return e.account=o[t]??null,e.contactsIds=((a=(c=o[t])==null?void 0:c.private)==null?void 0:a.grouped_contacts.ungrouped)??[],m.total=e.contactsIds.length,o[t]??null}catch(o){return k.add({type:"error",title:"Ошибка получения данных аккаунта",message:o instanceof Error?o.message:"Неизвестная ошибка"}),console.error(o),null}finally{e.loading--}}async function E(t){e.loading++;let c=[];try{const{data:a}=await B.clan.getAccountInfo({extra:"clan",account_id:t.join(",")});c=Object.values(a).filter(_)}catch(a){k.add({type:"error",title:"Ошибка поучения списка клановых аккаунтов",message:a instanceof Error?a.message:"Неизвестная ошибка"}),console.error(a)}return e.loading--,c}function j(t,c){const a=b.value.map(o=>{const i=t.find(s=>s.account_id===o);if(!i)return{id:0,nickname:"",lastBattleTime:0,statistic:{all:null,rating:null},clan:null};const d=i.statistics,h=w.accountAll(d.all),I=d.rating?w.accountRating(d.rating):null,{clan:n}=c.find(s=>(s==null?void 0:s.account_id)===i.account_id)??{};return{id:i.account_id,nickname:i.nickname,lastBattleTime:i.last_battle_time,statistic:{all:h,rating:I},clan:n??null}});e.items=a.sort((o,i)=>i.lastBattleTime-o.lastBattleTime)}async function $(t){e.loading++;let c=[];try{const{data:a}=await B.account.getInfo({extra:"statistics.rating",account_id:t.join(",")});c=Object.values(a).filter(_)}catch(a){k.add({type:"error",title:"Ошибка поучения списка аккаунтов",message:a instanceof Error?a.message:"Неизвестная ошибка"})}return e.loading--,c}async function A(){const t=C.accountId;if(!t||(e.account||await R(t),!e.contactsIds.length))return;const[c,a]=await Promise.all([$(b.value),E(b.value)]);j(c.filter(_),a.filter(_))}async function N(){await A()}return(t,c)=>{const a=z,o=L,i=O,d=V,h=D,I=F;return r(),g("div",J,[K,v(h,{"no-wrap":"","scroll-auto-disabling":"",headers:P,data:x(e).items,height:"calc(100vh - 112px)"},{nickname:l(({row:n})=>[n.id?(r(),f(a,{key:0,class:"account-contacts__link link",to:{name:"account-id",params:{id:n.id}}},{default:l(()=>[u(p(n.nickname),1)]),_:2},1032,["to"])):(r(),g(y,{key:1},[u(" Deleted ")],64))]),battles:l(({row:n})=>{var s;return[u(p(((s=n.statistic.all)==null?void 0:s.battles)??"---"),1)]}),winRate:l(({row:n})=>[n.statistic.all?(r(),f(o,{key:0,"model-value":n.statistic.all.winRate,class:"account-contacts__win-rate"},null,8,["model-value"])):(r(),g(y,{key:1},[u(" --- ")],64))]),rating:l(({row:n})=>[n.statistic.rating?(r(),f(i,{key:0,rating:n.statistic.rating},null,8,["rating"])):(r(),g(y,{key:1},[u(" --- ")],64))]),damagePerBattle:l(({row:n})=>{var s;return[u(p(((s=n.statistic.all)==null?void 0:s.damagePerBattle)??"---"),1)]}),clan:l(({row:n})=>[n.clan?(r(),f(a,{key:0,title:n.clan.name,class:"account-contacts__link link",to:{name:"clan-id",params:{id:n.clan.clan_id}}},{default:l(()=>[u(p(n.clan.tag),1)]),_:2},1032,["title","to"])):(r(),g(y,{key:1},[u(" --- ")],64))]),footer:l(()=>[v(d,{pagination:x(m),onChange:N},null,8,["pagination"])]),_:1},8,["data"]),v(I,{loading:x(e).loading>0},null,8,["loading"])])}}});export{rt as default};
