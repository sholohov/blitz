import{_ as E}from"./CUPIIRYo.js";import{_ as K}from"./DEiyTEmL.js";import{_ as T}from"./DbzEeCrI.js";import{_ as X}from"./Dunmg1Rb.js";import{f as D,q as M,r as x,i as Y,o as l,j as C,w as u,k,c as y,b as r,a as s,d as g,t as A,m as O,X as Z,a0 as P,T as J,F as V,A as Q,C as q,g as ee,h as te,z as se,N as oe,af as ne,O as ae}from"./C0--9zv3.js";import{s as p,o as ie,d as ce,h as B,u as re,a as N,b as S}from"./Dv9xmF1z.js";import{_ as L}from"./D3u7jnuq.js";import{_ as _e}from"./CV8R3jyv.js";import{_ as le}from"./BvnDnyXj.js";import{u as ue}from"./DFS5mj4W.js";import{u as de}from"./BS9eCQy9.js";import{u as pe}from"./5N8_4_r3.js";import"./ptBwo37s.js";import"./BxBPJGBn.js";import"./DVDNe1ib.js";const fe={key:0,class:"update-message"},me={class:"update-message__title"},ge=s("div",{class:"update-message__body"}," Что бы изменения вступили в силу, необходимо обновить страницу. ",-1),he={class:"update-message__control"},ke=D({__name:"UpdateMessage",setup(U){M(()=>{f()});const a=x(!1),i=x(null),n=P(),h=Y(()=>{const d=n.public.clientVersion;return!i.value||!d||a.value?!1:i.value!==d});function f(){const d=p.firebase.db();ie(ce(d,"app","info"),m=>{const _=m.data();i.value=(_==null?void 0:_.version)??null},m=>{B(m,{title:"Получение данных версии из Firebase"})})}function o(){location.reload()}function c(){a.value=!0}return(d,m)=>{const _=E,v=T,I=X;return l(),C(Z,{name:"update-message-"},{default:u(()=>[k(h)?(l(),y("div",fe,[r(I,{class:"update-message__inner"},{default:u(()=>[s("div",me,[r(_,{class:"update-message__icon",name:"new-releases"}),g(" Обновление v"+A(k(i)),1)]),ge,s("div",he,[r(v,{class:"update-message__btn",onClick:o},{default:u(()=>[g(" Обновить ")]),_:1}),r(v,{class:"update-message__btn",onClick:c},{default:u(()=>[g(" Скрыть ")]),_:1})])]),_:1})])):O("",!0)]),_:1})}}}),ye={class:"update-db-dialog__header"},ve=s("b",null,"База данных обновлена",-1),be=s("br",null,null,-1),xe=s("br",null,null,-1),Ue=s("br",null,null,-1),we=s("br",null,null,-1),$e={style:{display:"flex","justify-content":"flex-end"}},Se=D({__name:"UpdateDBDialog",emits:["confirm"],setup(U,{expose:a,emit:i}){const n=x(null),h=i;function f(){var c;(c=n.value)==null||c.doClose(),h("confirm")}function o(){var c;(c=n.value)==null||c.doOpen()}return a({open:o}),(c,d)=>{const m=E,_=T,v=L;return l(),C(v,{ref_key:"dialogRef",ref:n,class:"update-db-dialog","modal-enabled":"",width:"480px"},{title:u(()=>[s("div",ye,[r(m,{class:"update-db-dialog__icon",name:"database-alert"}),ve])]),footer:u(()=>[s("div",$e,[r(_,{onClick:f},{default:u(()=>[g(" Так точно ")]),_:1})])]),default:u(()=>[g(" Для продолжения использования необходимо: "),be,g(" 1. Закрыть все вкладки ресурса, кроме активной."),xe,g(" 2. Обновить текущую страницу."),Ue,g(" 3. Готово."),we]),_:1},512)}}}),Be={class:"ui-notification"},Ne={key:0,class:"ui-notification__item-title"},De={class:"ui-notification__item-body"},Ce=["onClick"],Ie=D({__name:"UiNotification",props:{appendToBody:{type:Boolean,default:!1}},setup(U){const a=re(),i=n=>{if(n.title)return n.title;switch(n.type){case"success":return"Успешно";case"error":return"Ошибка";case"info":return"Информация";case"warning":return"Внимание";default:return n.title}};return(n,h)=>{const f=le;return l(),C(f,null,{default:u(()=>[s("div",Be,[r(J,{tag:"ul",class:"ui-notification__list",name:"ui-notification__item-"},{default:u(()=>[(l(!0),y(V,null,Q(k(a).items,o=>(l(),y("li",{key:o.id,class:q(["ui-notification__item",[o.type?"ui-notification__item--"+o.type:""]])},[o.title||o.type?(l(),y("div",Ne,A(i(o)),1)):O("",!0),s("div",De,A(o.message),1),s("button",{class:"ui-notification__item-close",onClick:c=>k(a).remove(o)},null,8,Ce)],2))),128))]),_:1})])]),_:1})}}}),Re=()=>{const U=new URL(location.href),a=Object.fromEntries(U.searchParams.entries()),i={access_token:a.access_token,expires_at:a.expires_at,account_id:a.account_id,nickname:a.nickname};return Object.values(i).every(n=>n)?i:null},Ae={getUser:Re},Ee={class:"layout"},Oe={key:0,class:"layout__works"},Te={class:"layout__works-inner"},Me=s("h1",null,"ТЕХНИЧЕСКИЕ РАБОТЫ",-1),Pe=s("p",null,"Проблемы с Lesta API",-1),Ve={target:"_blank",href:"https://t.me/+kpbNPjc8nyZlMmIy",class:"layout__works-link link"},Le=s("span",null,"Telegram-чат",-1),ot=D({__name:"default",setup(U){const a=x(!0),i=ee(),n=te(),h=pe(),f=ue(),o=de(),c=x(null),d=x(null);j(),z(),se(()=>i.fullPath,async(e,t)=>{e!==t&&(await F(),o.toggleMainSearch(!1))}),oe(()=>{var e,t;o.mainSearchOpened?(e=c.value)==null||e.doOpen():(t=c.value)==null||t.doClose()}),M(()=>{h.init();const e=p.storage.getUser();e&&f.setUser({accountId:Number(e.account_id),name:e.nickname})});function m(){S.auth.logout(),f.resetUser(),p.storage.removeUser(),location.assign("/")}N.request.onError=({error:e})=>{(e==null?void 0:e.message)==="INVALID_ACCESS_TOKEN"&&m()};let _=!1;async function v(){if(_)return;const e=p.storage.getUser();if(!e||Number.isNaN(+e.expires_at))return;const t=+e.expires_at*1e3,w=Date.now();if(!(t<=w)&&!(t-w>ne)){_=!0;try{const b=w+ae*13,{data:$}=await N.auth.prolongate({expires_at:Math.round(b/1e3),access_token:e.access_token});p.storage.setUser({...e,access_token:$.access_token,expires_at:String($.expires_at)}),S.auth.prolongate({id:e.account_id,expiresAt:new Date(b).toISOString(),token:$.access_token}).catch(R=>{B(R,{title:"Продление сессии авторизации"})})}catch(b){B(b,{title:"Продление сессии авторизации"})}_=!1}}N.request.beforeRequest=async e=>{e.method==="get"&&(e.params=e.params??{},e.params.access_token=p.storage.getAccessToken(),e.params.application_id=P().public.appId),e.url.includes("prolongate")||await v()};async function I(e){try{await S.auth.login({id:e.account_id,token:e.access_token,expiresAt:new Date(+e.expires_at*1e3).toISOString()}),await S.user.set({id:e.account_id,name:e.nickname})}catch(t){console.error(t),B(t,{title:"Авторизация"}),await N.auth.logout()}}function j(){const e=Ae.getUser();e&&(p.storage.setUser(e),n.replace("/"),I(e))}async function F(){const e=p.storage.getUser();if(e)try{await S.user.action({id:e.account_id})}catch(t){B(t,{title:"Действие пользователя",message:"[SELF API] "+(t instanceof Error?t.message:"Неизвестная ошибка")})}}async function z(){const e=await p.indexedDB.getInstance();e.onBlocked=()=>{var t;return(t=d.value)==null?void 0:t.open()}}return(e,t)=>{const w=E,b=K,$=ke,R=Se,G=_e,H=L,W=Ie;return l(),y("div",Ee,[k(a)?(l(),y("div",Oe,[s("div",Te,[Me,Pe,s("a",Ve,[r(w,{name:"telegram",style:{margin:"6px"}}),Le])])])):(l(),y(V,{key:1},[r(b),r($),r(R,{ref_key:"updateDBRef",ref:d},null,512),k(h).isTablet?(l(),C(H,{key:0,ref_key:"searchDialogRef",ref:c,title:"Поиск аккаунтов и кланов",width:"480px",position:"top",onClose:t[0]||(t[0]=je=>k(o).toggleMainSearch(!1))},{default:u(()=>[r(G,{style:{height:"270px"}})]),_:1},512)):O("",!0),r(W)],64))])}}});export{ot as default};
