import{_ as dt}from"./uZwePpIY.js";import{d as X,z as Z,A as mt,r as W,k as O,l as nt,B as ft,C as st,o as S,m as C,n as u,h as l,f as w,F as at,D as _t,E as pt,v as f,g as gt,G as J,q as N,s as x,u as ht,b as yt,a as vt,H as bt,c as tt,t as d,w as i,y as At,e as kt,_ as St}from"./DEnf58KD.js";import{_ as wt}from"./BUTcSoIg.js";import{_ as $t}from"./CW4r_PKK.js";import{_ as It}from"./CUKP7nec.js";import{_ as Rt}from"./CfjgP0ko.js";import{_ as ot}from"./Co0YW0xm.js";import{_ as Ct}from"./Co3dV3yV.js";import{d as Et}from"./D2AYo3hX.js";import{_ as Lt}from"./BfqZGrhM.js";import{d as Bt}from"./CKeGCx3Z.js";import{n as et}from"./BxBPJGBn.js";import{f as q}from"./YHuVnumQ.js";import{s as P}from"./BLrdWoSV.js";import"./DD4asW33.js";import"./B4FMxlHh.js";const Pt={class:"ui-search__inner"},xt={class:"ui-search__input"},Dt={key:0,class:"ui-search__dropdown"},Tt=["onKeydown","onClick"],Ot=X({__name:"UiSearch",props:Z({items:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1},placeholder:{type:String,default:void 0}},{modelValue:{required:!0,default:""},modelModifiers:{}}),emits:Z(["reset","input","select"],["update:modelValue"]),setup(L,{emit:B}){const t=mt(L,"modelValue"),$=L,E=W(),_=W(null),a=O({isOpen:!1,btnList:[],focusedElemIndex:-1});nt(()=>{window.addEventListener("click",o)}),ft(()=>{window.removeEventListener("click",o)});const I=B;st(()=>$.items,()=>{a.isOpen=$.items.length>0,v()});function h(){I("reset"),a.focusedElemIndex=-1,a.isOpen=!1}function o(c){var r;(r=E.value)!=null&&r.contains(c.target)||(a.isOpen=!1)}function y(c){I("select",c),a.isOpen=!1,setTimeout(()=>{var r;return(r=_.value)==null?void 0:r.focus},300)}function v(){var c;(c=E.value)==null||c.querySelectorAll(".ui-search__item-btn").forEach(r=>{a.btnList.push(r)})}function m(c){var R,D,b,T,U,j;const r=c.target;$.loading||(c.key==="Escape"&&(h(),a.focusedElemIndex=-1,(R=_.value)==null||R.focus()),r.tagName==="INPUT"&&(a.focusedElemIndex=-1),c.key==="ArrowUp"&&(c.preventDefault(),(D=a.btnList)!=null&&D.length&&a.focusedElemIndex>0?(b=a.btnList[--a.focusedElemIndex])==null||b.focus():(T=_.value)==null||T.focus()),c.key==="ArrowDown"&&(c.preventDefault(),(U=a.btnList)!=null&&U.length&&a.focusedElemIndex<a.btnList.length-1&&((j=a.btnList[++a.focusedElemIndex])==null||j.focus())))}return(c,r)=>{const R=Ct,D=ot;return S(),C("div",{ref_key:"rootRef",ref:E,class:"ui-search"},[u("div",Pt,[u("div",xt,[l(R,{ref_key:"inputRef",ref:_,modelValue:t.value,"onUpdate:modelValue":r[0]||(r[0]=b=>t.value=b),modelModifiers:{trim:!0},placeholder:L.placeholder,type:"search",onKeydown:m},null,8,["modelValue","placeholder"])]),w(a).isOpen?(S(),C("div",Dt,[u("ul",{class:"ui-search__list",onKeydown:m},[(S(!0),C(at,null,_t(L.items,b=>(S(),C("li",{key:String(b.value),class:"ui-search__item"},[u("button",{class:"ui-search__item-btn",onKeydown:pt(T=>y(b),["enter"]),onClick:T=>y(b)},f(b.label),41,Tt)]))),128))],32),l(D,{loading:L.loading},null,8,["loading"])])):gt("",!0)])],512)}}}),Vt={class:"account-sessions-search"},qt=X({__name:"AccountSessionsSearch",emits:["select"],setup(L,{emit:B}){const t=O({items:[],loading:0,search:""}),$=B;async function E(h=""){t.loading++;try{const y=((await J.session.account.getList({query:h})).data||[]).map(v=>({label:v.raw.nickname,value:v.raw.account_id}));if(y.length){const v=await N.clan.getAccountInfo({extra:"clan",account_id:y.map(m=>m.value).join(",")}).catch(()=>({data:null}));v.data&&y.forEach(m=>{var r,R;const c=(R=(r=v.data[String(m.value)])==null?void 0:r.clan)==null?void 0:R.tag;m.label+=c?` [${c}]`:""})}t.items=y}catch(o){x(o,{title:"Поиск аккаунта"})}t.loading--}const _=Et(E,1e3,{leading:!0});st(()=>t.search,async()=>{if(t.search.length<=2){t.items=[];return}await _(t.search)});function a(h){t.items=[],t.search="",$("select",h)}function I(){t.search="",t.items=[]}return(h,o)=>{const y=Ot;return S(),C("div",Vt,[l(y,{modelValue:w(t).search,"onUpdate:modelValue":o[0]||(o[0]=v=>w(t).search=v),placeholder:"Введите ник игрока",items:w(t).items,loading:w(t).loading>0,onSelect:a,onReset:I},null,8,["modelValue","items","loading"])])}}}),Nt={class:"account-sessions"},Ut={class:"account-sessions__description content-area",style:{"max-width":"800px"}},jt={class:"account-sessions__filters"},Ft={class:"account-sessions__filters-item"},zt={class:"account-sessions__filters-item"},Kt={class:"account-sessions__table"},Mt={class:"account-sessions__sub"},Ht={class:"account-sessions__sub"},Qt={key:1},Gt={class:"account-sessions__win-rate--sub"},Wt={class:"account-sessions__sub"},Jt={key:1},Xt={class:"account-sessions__sub"},Yt={class:"account-sessions__sub"},pe=X({__name:"sessions",setup(L){ht({title:"Сессии / Аккаунты"});const B=W(null),t=O({loading:0,items:[],achievementsInfo:null,achievementsSessions:[],achievements:null,clanAccounts:null,accounts:[],accountsSessions:[]}),$=yt(),E=vt(),_=O({total:0,page:1,pageSize:100}),a={order:"desc",prop:"updateAt"},I=O(a),h=q.makeAccountSessionsFilters(),o=O(bt(h)),y=tt(()=>{const e=[{key:"nickname",label:"Ник",sortable:"custom"},{key:"clan",label:"Клан"},{key:"battles",label:"Боёв"},{key:"winRate",label:"Побед"},{key:"damagePerBattle",label:"Урон"},{key:"teamPoints",label:"КМД *"},{key:"updateAt",width:180,label:"Дата начала",sortable:"custom"},{key:"last_battle_time",width:180,label:"Последний бой"}];return o.ids.length&&e.push({key:"actions"}),e}),v=tt(()=>!Bt(o,h));nt(()=>{Object.assign(o,q.makeAccountSessionsFilters({...h,...E.query})),m()});async function m(){t.loading++,await r(o.ids);const e=t.accountsSessions.map(n=>n.id);e.length&&(await Promise.all([D(),R(e),b(e),T(e),U(e)]),c()),t.loading--}function c(){t.items=t.accountsSessions.map(({raw:e,updateAt:n,id:A})=>{var s,g,Y;const k=t.accounts.find(G=>G.account_id===A);if(!k)return null;const p={...e,statistics:P.diffFull(k.statistics,e.statistics),updateAt:new Date(n).valueOf()},V=p.statistics,M=P.accountAll(V.all),H=V.rating?P.accountRating(V.rating):null,Q=(g=(s=t.clanAccounts)==null?void 0:s[p.account_id])==null?void 0:g.clan,F=t.achievementsSessions.find(G=>G.id===p.account_id);let z=NaN;const K=(Y=t.achievements)==null?void 0:Y[p.account_id];return K&&F&&t.achievementsInfo&&(z=P.teamPoints(p.statistics,P.accountAchievementsDiff(K,F.raw,t.achievementsInfo))),{updateAt:p.updateAt,id:p.account_id,nickname:p.nickname,lastBattleTime:k.last_battle_time,teamPoints:z,currentStatistic:{all:P.accountAll(k.statistics.all),rating:k.statistics.rating?P.accountRating(k.statistics.rating):null},statistic:{all:M,rating:H},clan:Q??null}}).filter(et)}async function r(e){t.loading++;try{const{data:n,meta:A}=await J.session.account.getList({ids:e,pageSize:_.pageSize,page:_.page,sort:`${I.prop}:${I.order}`});_.total=(A==null?void 0:A.total)??0,t.accountsSessions=n}catch(n){x(n,{title:"Ошибка поучения сессий аккаунтов"})}t.loading--}async function R(e){t.loading++;try{const{data:n}=await J.session.accountAchievements.getList({ids:e,pageSize:_.pageSize});t.achievementsSessions=n}catch(n){x(n,{title:"Ошибка поучения сессий достижений"})}t.loading--}async function D(){if(!t.achievementsInfo){t.loading++;try{const{data:e}=await N.encyclopedia.getAchievements();t.achievementsInfo=e??null}catch(e){x(e,{title:"Ошибка поучения описания достижений"})}t.loading--}}async function b(e){t.loading++;try{const n=await N.account.getInfo({extra:"statistics.rating",account_id:e.join(",")});t.accounts=Object.values(n.data).filter(et)??null}catch(n){x(n,{title:"Ошибка поучения списка аккаунтов"})}t.loading--}async function T(e){t.loading++;try{const{data:n}=await N.account.getAchievements({account_id:e.join(",")});t.achievements=n??null}catch(n){x(n,{title:"Ошибка поучения списка достижений аккаунтов"})}t.loading--}async function U(e){t.loading++;try{const{data:n}=await N.clan.getAccountInfo({extra:"clan",account_id:e.join(",")});t.clanAccounts=n??null}catch(n){x(n,{title:"Ошибка поучения списка клановых аккаунтов"})}t.loading--}function j(e){I.order=e.order,I.prop=e.prop,m()}async function it({value:e}){var n;await((n=B.value)==null?void 0:n.doClose()),o.ids.includes(e)||(o.ids=[...o.ids,e]),await $.push({query:{...E.query,...q.toRouteQuery(o)}}),await m()}function ct(){var e;(e=B.value)==null||e.doOpen()}function lt(e){t.items=t.items.filter(n=>n.id!==e.id),o.ids=t.items.map(n=>n.id),$.push({query:q.toRouteQuery(o)}),m()}async function ut(){Object.assign(o,h),await $.push({query:q.toRouteQuery(o)}),m()}async function rt(e){Object.assign(_,e),await m()}return(e,n)=>{const A=dt,k=St,p=At,V=wt,M=$t,H=It,Q=Rt,F=ot,z=qt,K=Lt;return S(),C("div",Nt,[u("div",Ut,[u("p",null,[n[1]||(n[1]=d(' "Сессии" - статистика пользователей за определённый период. Активировать сбор статистики можно через ')),l(A,{to:{name:"widgets"}},{default:i(()=>n[0]||(n[0]=[d(" виджет сессии ")])),_:1}),n[2]||(n[2]=d(" . Данные хранятся на сервере ресурса. "))]),u("ul",null,[u("li",null,[n[4]||(n[4]=u("b",null,"Командная игра (КМД)",-1)),n[5]||(n[5]=d(" - сумма нескольких показателей, основной смысл - оценка игры взводом. Подробнее на ")),l(A,{to:{name:"widgets"}},{default:i(()=>n[3]||(n[3]=[d(" Странице Виджета ")])),_:1})])])]),n[8]||(n[8]=d(" Фильтры ")),u("div",jt,[u("div",Ft,[l(p,{onClick:ct},{after:i(()=>[l(k,{name:"add"})]),default:i(()=>[n[6]||(n[6]=d(" По игроку "))]),_:1})]),u("div",zt,[l(p,{disabled:!w(v),onClick:ut},{after:i(()=>[l(k,{name:"close"})]),default:i(()=>[n[7]||(n[7]=d(" Очистить "))]),_:1},8,["disabled"])])]),u("div",Kt,[l(Q,{"no-wrap":"","scroll-to-top":"","scroll-auto-disabling":"","default-sort":a,headers:w(y),data:w(t).items,height:"calc(100vh - 112px)",onSort:j},{nickname:i(({row:s})=>[l(A,{class:"account-sessions__nickname link",to:{name:"account-id",params:{id:s.id}}},{default:i(()=>[d(f(s.nickname),1)]),_:2},1032,["to"])]),battles:i(({row:s})=>{var g;return[d(f(e.$formatter.number.toInteger(s.statistic.all.battles))+" ",1),u("div",Mt,f(e.$formatter.number.toInteger((g=s.currentStatistic)==null?void 0:g.all.battles)||"---"),1)]}),teamPoints:i(({row:s})=>[Number.isNaN(s.teamPoints)?(S(),C("span",Qt," --- ")):(S(),C(at,{key:0},[d(f(e.$formatter.number.toInteger(s.teamPoints/s.statistic.all.battles)||0)+" ",1),u("span",Ht,f(e.$formatter.number.toInteger(s.teamPoints)||0),1)],64))]),winRate:i(({row:s})=>{var g;return[l(V,{"win-rate":s.statistic.all.winRate,class:"account-sessions__win-rate"},null,8,["win-rate"]),u("div",Gt,f(e.$formatter.number.toFloatPercent((g=s.currentStatistic)==null?void 0:g.all.winRate)||"---"),1)]}),rating:i(({row:s})=>[l(M,{rating:s.statistic.rating},null,8,["rating"])]),damagePerBattle:i(({row:s})=>{var g;return[d(f(e.$formatter.number.toInteger(s.statistic.all.damagePerBattle))+" ",1),u("div",Wt,f(e.$formatter.number.toInteger((g=s.currentStatistic)==null?void 0:g.all.damagePerBattle)||"---"),1)]}),clan:i(({row:s})=>[s.clan?(S(),kt(A,{key:0,title:s.clan.name,class:"account-sessions__clan link",to:{name:"clan-id",params:{id:s.clan.clan_id}}},{default:i(()=>[d(f(s.clan.tag),1)]),_:2},1032,["title","to"])):(S(),C("span",Jt,"---"))]),last_battle_time:i(({row:s})=>[d(f(e.$formatter.date.toRelativeTime(s.lastBattleTime*1e3))+" ",1),u("span",Xt,f(e.$formatter.date.toDateTime(s.lastBattleTime*1e3)),1)]),updateAt:i(({row:s})=>[d(f(e.$formatter.date.toRelativeTime(s.updateAt))+" ",1),u("span",Yt,f(e.$formatter.date.toDateTime(s.updateAt)),1)]),actions:i(({row:s})=>[l(p,{"is-text":"","is-square":"",onClick:g=>lt(s)},{default:i(()=>[l(k,{name:"delete"})]),_:2},1032,["onClick"])]),footer:i(()=>[l(H,{pagination:w(_),onChange:rt},null,8,["pagination"])]),_:1},8,["headers","data"]),l(F,{loading:w(t).loading>0},null,8,["loading"])]),l(K,{ref_key:"addAccountDialogRef",ref:B,width:"400px",position:"top",title:"Поиск игрока"},{default:i(()=>[l(z,{style:{height:"270px"},onSelect:it})]),_:1},512)])}}});export{pe as default};
