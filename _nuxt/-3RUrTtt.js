import{_ as q}from"./BYjQXuNZ.js";import{_ as H}from"./Bm14zLTW.js";import{_ as O}from"./25F-AMWF.js";import{d as U,u as G,j as D,k as M,c as W,l as m,m as b,h as p,w as s,f as v,n as F,s as R,p as S,o as c,e as g,q as T,t as f,_ as J,v as K}from"./CKv8GwDH.js";import{_ as Q}from"./DWhwL8Z4.js";import{_ as X}from"./CKJ7yeoF.js";import{_ as Y}from"./CFptAKa4.js";import{n as B}from"./BxBPJGBn.js";import{u as x}from"./CI5TTA92.js";import{s as C}from"./C4oTPxE3.js";import"./DD4asW33.js";import"./di2ZG6aq.js";import"./RPJY7rI9.js";const Z={class:"account-tracked"},tt={key:1},at={key:0},nt={key:1},et={key:1},ct={key:1},it={key:0},ot={key:1},st={key:1},Bt=U({__name:"tracked",setup(lt){G({title:"Отслеживаемые / Аккаунты"});const e=D({loading:0,items:[],accountsLocal:null}),d=D({total:0,page:1,pageSize:100}),I=[{key:"nickname",label:"Ник"},{key:"clan",label:"Клан"},{key:"battles",label:"Боёв"},{key:"winRate",label:"Побед"},{key:"damagePerBattle",label:"Урон"},{key:"rating",label:"Рейтинг"},{key:"lastBattleTime",width:160,label:"Последний бой",formatter:t=>typeof t=="number"?F.date.toRelativeTime(t*1e3):"---"},{key:"actions",width:60}];M(()=>{w()});const A=W(()=>{const t=d.page*d.pageSize,a=t-d.pageSize;return(e.accountsLocal??[]).filter(B).slice(a,t)});async function L(){e.loading++;try{const{$indexedDB:t}=R(),a=await t.accountsInfo.getAll();e.accountsLocal=(a??[]).map(l=>l.data).sort((l,o)=>o.last_battle_time-l.last_battle_time),d.total=(a==null?void 0:a.length)??0}catch(t){x(t,{title:"Ошибка поучения локального списка аккаунтов"})}e.loading--}async function P(t){e.loading++;try{const a=await S.account.getInfo({extra:"statistics.rating",account_id:t.join(",")});return Object.values(a.data).filter(B)}catch(a){return x(a,{title:"Ошибка поучения списка аккаунтов"}),[]}finally{e.loading--}}async function N(t){e.loading++;try{const{data:a}=await S.clan.getAccountInfo({extra:"clan",account_id:t.join(",")});return Object.values(a).filter(B)}catch(a){return x(a,{title:"Ошибка поучения списка клановых аккаунтов"}),[]}finally{e.loading--}}async function w(){var t;e.accountsLocal||await L(),(t=e.accountsLocal)!=null&&t.length&&await $()}function j(t,a){const l=A.value.map(o=>{const r=t.find(_=>_.account_id===o.account_id);if(!r)return{id:o.account_id,nickname:o.nickname,lastBattleTime:NaN,isDeleted:!0,statistic:null,clan:null};const u=r.statistics,k=C.accountAll(u.all),y=u.rating?C.accountRating(u.rating):null,{clan:h}=a.find(_=>(_==null?void 0:_.account_id)===r.account_id)??{};return{id:r.account_id,nickname:r.nickname,lastBattleTime:r.last_battle_time,statistic:{all:k,rating:y},clan:h??null}});e.items=l.sort((o,r)=>r.lastBattleTime-o.lastBattleTime)}async function $(){const t=A.value.map(o=>o.account_id);if(!t.length)return;const[a,l]=await Promise.all([P(t),N(t)]);j(a,l)}async function E(t){const{$indexedDB:a}=R();await Promise.all([a.accountsInfo.remove(t),a.accountsAchievements.remove(t),a.tanksStat.remove(t)])}async function z(t){await E(t),e.items.length<d.total?e.items=e.items.filter(a=>a.id!==t):await w()}async function V(){await $()}return(t,a)=>{const l=q,o=H,r=O,u=J,k=K,y=Q,h=X,_=Y;return c(),m("div",Z,[a[0]||(a[0]=b("div",{class:"account-tracked__description content-area",style:{"max-width":"800px"}},[b("p",null,"Список игроков, статистика которых отслеживается. Данные хранятся в браузере."),b("p",null," Отслеживание начинается с момента просмотра аккаунта на данном ресурсе. После удаления из списка - отслеживание прекращается. ")],-1)),p(h,{"no-wrap":"","scroll-to-top":"","scroll-auto-disabling":"",headers:I,data:v(e).items,height:"calc(100vh - 112px)"},{nickname:s(({row:n})=>[n.isDeleted?(c(),m("span",tt,f(n.nickname),1)):(c(),g(l,{key:0,class:"account-tracked__link link",to:{name:"account-id",params:{id:n.id}}},{default:s(()=>[T(f(n.nickname),1)]),_:2},1032,["to"]))]),battles:s(({row:n})=>{var i;return[n.isDeleted?(c(),m("span",nt,"---")):(c(),m("span",at,f((i=n.statistic)==null?void 0:i.all.battles),1))]}),winRate:s(({row:n})=>{var i;return[n.isDeleted?(c(),m("span",et,"---")):(c(),g(o,{key:0,"win-rate":(i=n.statistic)==null?void 0:i.all.winRate,class:"account-tracked__win-rate"},null,8,["win-rate"]))]}),rating:s(({row:n})=>{var i;return[n.isDeleted?(c(),m("span",ct,"---")):(c(),g(r,{key:0,rating:(i=n.statistic)==null?void 0:i.rating},null,8,["rating"]))]}),damagePerBattle:s(({row:n})=>{var i;return[n.isDeleted?(c(),m("span",ot,"---")):(c(),m("span",it,f((i=n.statistic)==null?void 0:i.all.damagePerBattle),1))]}),clan:s(({row:n})=>[n.clan?(c(),g(l,{key:0,title:n.clan.name,class:"account-tracked__link link",to:{name:"clan-id",params:{id:n.clan.clan_id}}},{default:s(()=>[T(f(n.clan.tag),1)]),_:2},1032,["title","to"])):(c(),m("span",st,"---"))]),actions:s(({row:n})=>[p(k,{title:"Удалить","is-text":"","is-square":"",onClick:i=>z(n.id)},{default:s(()=>[p(u,{name:"delete"})]),_:2},1032,["onClick"])]),footer:s(()=>[p(y,{pagination:v(d),onChange:V},null,8,["pagination"])]),_:1},8,["data"]),p(_,{loading:v(e).loading>0},null,8,["loading"])])}}});export{Bt as default};
