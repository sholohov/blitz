import{d as H,r as N,a as z,c as ft,M as vt,k as bt,l as D,e as F,H as L,x as W,m as wt,n as y,p as v,o as m,q as g,s as o,g as i,h as V,b2 as ht,j as r,w as l,F as I,C as P,I as yt,v as q,_ as kt,y as Ct,a7 as xt,a4 as j,t as h,G as k,u as At,b as St,f as Bt}from"./BytUdlbn.js";import{_ as Vt}from"./BwHplgHP.js";import{_ as It}from"./DlbbhUVy.js";import{_ as Pt}from"./u7V1ISAq.js";import{_ as qt}from"./CX4hQkTI.js";import{_ as $t}from"./T65hoJzy.js";import{f as $}from"./CtzQypMv.js";import{_ as Rt}from"./B0gmUi0a.js";import{_ as Ut}from"./fWUsAX9K.js";import{c as Mt}from"./B4FMxlHh.js";import"./1T5zVu7K.js";import"./DD4asW33.js";import"./BpX7lcxd.js";import"./DOZyoLp2.js";import"./D4jFUD0b.js";import"./BxBPJGBn.js";import"./B6Z-PVrD.js";import"./BgnVvIy8.js";import"./8hVWOGRC.js";import"./DT3k13SP.js";import"./DSr_Q9T0.js";import"./DlAUqK2U.js";import"./XFwUmNy4.js";import"./2PKvI08a.js";import"./DN5pBZVe.js";import"./CgXCKoo3.js";import"./DsOP9sTD.js";const Ot={class:"widget-account-stat-constructor"},Tt={class:"widget-account-stat-constructor__inner"},Gt={class:"widget-account-stat-constructor__description"},Nt={class:"content-area"},Dt={key:0,style:{color:"var(--color-red)"}},Ft={class:"widget-account-stat-constructor__params"},Lt={class:"widget-account-stat-constructor__param"},Wt={class:"widget-account-stat-constructor__param-options"},jt=["onClick"],Ht={key:0,class:"widget-account-stat-constructor__attributes-control"},zt={class:"widget-account-stat-constructor__param"},Et={class:"widget-account-stat-constructor__param-options"},Qt={class:"widget-account-stat-constructor__param"},Jt={class:"widget-account-stat-constructor__param-options"},Kt={class:"widget-account-stat-constructor__param"},Xt={class:"widget-account-stat-constructor__param-options"},Yt={class:"widget-account-stat-constructor__checkbox-group"},Zt={class:"widget-account-stat-constructor__param"},te={class:"widget-account-stat-constructor__param-options"},ee={class:"widget-account-stat-constructor__checkbox-group"},oe={class:"widget-account-stat-constructor__param"},se={class:"widget-account-stat-constructor__param-options"},ne={style:{margin:"0 0 0 10px"}},ae={key:0,class:"widget-account-stat-constructor__panel"},ie={class:"content-area"},ce={style:{"white-space":"nowrap"}},re={style:{display:"flex","justify-content":"flex-end"}},le=H({__name:"WidgetAccountSessionConstructor",setup(E){const b=N(null),C=z(),R=ft(),U=vt(),_=bt(),s=D({loading:0,account:null,achievementsInfo:null,accountAchievements:null,tanksAchievements:null,tanks:null,sessionUpdateAt:null}),x=[{value:null,label:"Обычный"},{value:"rating",label:"Рейтинговый"}],Q=F(()=>[{value:"default",label:"По умолчанию"},{value:"teamGamePoints",label:"Командная игра",disabled:n.battleMode==="rating"}]),J=["white","black"],K=["white","black","grey","green","orange","red","purple","blue"],M=F(()=>{const e=["battles","winRate","damagePerBattle","fragPerBattle","surviveRate","hitRate","spottedPerBattle","xpPerBattle","markOfMastery","medalBrothersInArms","medalCrucialContribution","teamGamePoints"],t=["battles","winRate","damagePerBattle","fragPerBattle","surviveRate","hitRate","spottedPerBattle","xpPerBattle"];return n.battleMode==="rating"?t:e}),A=$.makeAccountSessionWidgetFilters({battleMode:null,attributes:["battles","winRate","damagePerBattle"],style:"tile",textColor:"white",bgColor:"black",bgColorOpacity:.5}),n=D(L(A)),u=N(M.value.map(e=>({key:e,isVisible:!1,label:W.stat.accountProp(e)??e})));wt(async()=>{Object.assign(n,$.makeAccountSessionWidgetFilters({...L(A),...C.query})),p(),await nt(),S()});function O(){n.config==="default"&&(n.attributes=A.attributes),n.config==="teamGamePoints"&&(n.attributes=["battles","winRate","damagePerBattle","medalBrothersInArms","medalCrucialContribution","teamGamePoints"])}function S(){u.value=M.value.map(e=>{var d,f;const t=(d=s.achievementsInfo)==null?void 0:d[e],c=((f=n.attributes)==null?void 0:f.includes(e))??!1;return t?{key:e,isVisible:c,label:String(t.name).replace(/\([^)]+\)/gi,"")??e}:{key:e,isVisible:c,label:W.stat.accountProp(e)??e}}),B()}function p(){R.replace({query:$.toRouteQuery(n)}).catch(()=>null)}function X(e){n.textColor=e,p()}function Y(e){n.bgColor=e,p()}function B(){u.value.sort((e,t)=>!e.isVisible&&t.isVisible?1:e.isVisible&&!t.isVisible?-1:0)}function Z(e){const t=u.value.findIndex(c=>c.key===e.key);t!==-1&&(u.value[t].isVisible=!e.isVisible,n.attributes=u.value.filter(c=>c.isVisible).map(c=>c.key),n.config=null,B(),p())}function tt(e,t){const c=u.value.findIndex(f=>f.key===e.key);if(c===-1)return;const d=u.value.splice(c,1);u.value.splice(c-1,0,...d),B(),p()}function et(){O(),S(),p()}function ot(){n.battleMode==="rating"&&(n.config="default",O()),S(),p()}function st(){p()}async function nt(){s.loading++;try{const{data:e}=await y.encyclopedia.getAchievements();s.achievementsInfo=e??null}catch(e){v(e,{title:"Получение описания достижений"})}s.loading--}async function at(e){s.loading++;try{const{data:t}=await y.account.getInfo({account_id:e,extra:"statistics.rating"});s.account=(t==null?void 0:t[e])??null}catch(t){v(t,{title:"Получение данных игрока"})}s.loading--}async function it(e){s.loading++;try{const{data:t}=await y.account.getAchievements({account_id:e});s.accountAchievements=(t==null?void 0:t[e])??null}catch(t){v(t,{title:"Получение достижений игрока"})}s.loading--}async function ct(e){s.loading++;try{const{data:t}=await y.tanks.getAchievements({account_id:e});s.tanksAchievements=(t==null?void 0:t[e])??null}catch(t){v(t,{title:"Получение достижений техники игрока"})}s.loading--}async function rt(e){s.loading++;try{const{data:t}=await y.tanks.getStats({account_id:e});s.tanks=t?t[e]:null}catch(t){v(t,{title:"Получение статистики по технике игрока"})}s.loading--}async function T(){const e=_.accountId;if(e&&(await Promise.all([at(e),it(e),ct(e),rt(e)]),!(!s.account||!s.accountAchievements||!s.tanks||!s.tanksAchievements))){try{await Promise.all([k.session.account.set(e,s.account),k.session.accountAchievements.set(e,s.accountAchievements),k.session.tanks.set(e,s.tanks),k.session.tanksAchievements.set(e,s.tanksAchievements)]),U.add({type:"success",message:"Новая сессия успешно запущена"})}catch(t){v(t,{title:"Начало новой сессии"})}s.account=null,s.accountAchievements=null,s.tanks=null,s.tanksAchievements=null}}async function lt(){var e;await((e=b.value)==null?void 0:e.doClose()),await T()}async function ut(e){try{const{data:t}=await k.session.account.getList({ids:[e]});return t[0]??null}catch(t){return v(t,{title:"Получение сессии игрока"}),null}}async function dt(){var c;const e=_.accountId;if(!e)return;const t=await ut(e);t?(s.sessionUpdateAt=t.updateAt,await((c=b.value)==null?void 0:c.doOpen())):await T()}return(e,t)=>{const c=Ct,d=kt,f=Vt,G=It,mt=Pt,_t=qt,pt=$t;return m(),g("div",Ot,[o("div",Tt,[o("div",Gt,[o("div",Nt,[i(_).accountId?V("",!0):(m(),g("p",Dt," Создать виджет могут только авторизованные пользователи. ")),t[4]||(t[4]=o("p",null," Виджет для слежения за изменениями статистики вашего аккаунта. Используется в инструментах для стрима наподобие OBS Studio. Обновление статистики происходит 1 раз в 30 секунд. Сессия независима от аналогичной на странице аккаунта, по этому можно поделиться ссылкой. Выберите количество атрибутов и измените ширину окна браузера и плитки автоматически перестроятся на следующую линию. ",-1))]),t[5]||(t[5]=ht('<div class="content-area"><h4>&quot;Командная игра&quot;</h4><p><i>Конфигурация =&gt; Командная игра</i></p><p> В игре участвует 2 и более взвода. Всем Участникам следует запустить сессию в одно время. Играется серия из определённого кол-ва боёв. После окончания сессии очки взвода суммируются. Победил взвод набравший больше очков. Счёт отображает атрибут - &quot;Командная игра&quot; </p><blockquote>Важно! Сессия не должна прерываться боями в &quot;Обычном режиме&quot;.</blockquote><table><tbody style="width:360px;"><tr style="text-align:left;"><th>Действие</th><th>Очки</th></tr><tr><td>Единица урона</td><td>+1</td></tr><tr><td>Победа</td><td>+500</td></tr><tr><td>Медаль &quot;Братья по оружию&quot;</td><td>+750</td></tr><tr><td>Медаль &quot;Решающий вклад&quot;</td><td>+1750</td></tr></tbody></table></div>',1))]),o("div",Ft,[o("div",Lt,[t[6]||(t[6]=o("div",{class:"widget-account-stat-constructor__param-title"}," Атрибуты ",-1)),o("div",Wt,[r(xt,{tag:"div",class:"widget-account-stat-constructor__attributes",name:"widget-account-stat-constructor__attributes-"},{default:l(()=>[(m(!0),g(I,null,P(i(u),(a,w)=>(m(),g("div",{key:a.key,class:yt(["widget-account-stat-constructor__attributes-item",[a.isVisible?"widget-account-stat-constructor__attributes-item--is-visible":""]])},[o("button",{class:"widget-account-stat-constructor__attributes-label",onClick:gt=>Z(a)},q(a.label),9,jt),a.isVisible?(m(),g("span",Ht,[r(d,{"is-text":"","is-square":"",disabled:w===0,class:"widget-account-stat-constructor__attributes-btn",onClick:gt=>tt(a,!0)},{default:l(()=>[r(c,{name:"swipe-up"})]),_:2},1032,["disabled","onClick"])])):V("",!0)],2))),128))]),_:1})])]),o("div",zt,[t[7]||(t[7]=o("div",{class:"widget-account-stat-constructor__param-title"}," Конфигурация ",-1)),o("div",Et,[r(f,{modelValue:i(n).config,"onUpdate:modelValue":t[0]||(t[0]=a=>i(n).config=a),width:"200px",options:i(Q),onChange:et},null,8,["modelValue","options"])])]),o("div",Qt,[t[8]||(t[8]=o("div",{class:"widget-account-stat-constructor__param-title"}," Режим боя ",-1)),o("div",Jt,[r(f,{modelValue:i(n).battleMode,"onUpdate:modelValue":t[1]||(t[1]=a=>i(n).battleMode=a),width:"200px",options:x,onChange:ot},null,8,["modelValue"])])]),o("div",Kt,[t[9]||(t[9]=o("div",{class:"widget-account-stat-constructor__param-title"}," Цвет текста ",-1)),o("div",Xt,[o("div",Yt,[(m(),g(I,null,P(J,a=>r(G,{key:a,"model-value":i(n).textColor===a,class:"widget-account-stat-constructor__checkbox",onChange:w=>X(a)},{default:l(()=>[o("span",{style:j({color:`var(--color-${a})`}),class:"widget-account-stat-constructor__color-pick"},null,4)]),_:2},1032,["model-value","onChange"])),64))])])]),o("div",Zt,[t[10]||(t[10]=o("div",{class:"widget-account-stat-constructor__param-title"}," Цвет фона ",-1)),o("div",te,[o("div",ee,[(m(),g(I,null,P(K,a=>r(G,{key:a,"model-value":i(n).bgColor===a,class:"widget-account-stat-constructor__checkbox",title:i(n).textColor,onChange:w=>Y(a)},{default:l(()=>[o("span",{style:j({color:`var(--color-${a})`}),class:"widget-account-stat-constructor__color-pick"},null,4)]),_:2},1032,["model-value","title","onChange"])),64))])])]),o("div",oe,[t[11]||(t[11]=o("div",{class:"widget-account-stat-constructor__param-title"}," Прозрачность фона ",-1)),o("div",se,[r(mt,{modelValue:i(n).bgColorOpacity,"onUpdate:modelValue":t[2]||(t[2]=a=>i(n).bgColorOpacity=a),width:"200px",min:0,max:1,step:.1,onInput:st},null,8,["modelValue"]),o("span",ne,q((i(n).bgColorOpacity||0)*100)+"% ",1)])])]),i(_).accountId?(m(),g("div",ae,[r(d,{disabled:!i(_).accountId,class:"widget-account-stat-constructor__btn",onClick:dt},{default:l(()=>t[12]||(t[12]=[h(" Начать сессию ")])),_:1},8,["disabled"]),r(_t,{class:"widget-account-stat-constructor__btn link",to:{name:"widgets-account-session",query:{...i(C).query,accountId:String(i(_).accountId)}},target:"_blank"},{default:l(()=>t[13]||(t[13]=[h(" Перейти к виджету ")])),_:1},8,["to"])])):V("",!0)]),r(pt,{ref_key:"confirmDialogRef",ref:b,width:"400px",title:"Запуск новой сессии"},{footer:l(()=>[o("div",re,[r(d,{style:{margin:"0 4px 0 0"},onClick:t[3]||(t[3]=a=>{var w;return(w=i(b))==null?void 0:w.doClose()})},{default:l(()=>t[17]||(t[17]=[h(" Отмена ")])),_:1}),r(d,{class:"widget-account-stat-constructor__btn",onClick:lt},{default:l(()=>t[18]||(t[18]=[h(" Так точно! ")])),_:1})])]),default:l(()=>[o("div",ie,[o("p",null,[t[14]||(t[14]=h(" Текущая сессия от ")),o("span",ce,q(e.$formatter.date.toDateTime(i(s).sessionUpdateAt??0)),1),t[15]||(t[15]=h(". "))]),t[16]||(t[16]=o("p",null,"Начать новую?",-1))])]),_:1},512)])}}}),Te=H({__name:"index",setup(E){const{$formatter:b}=At(),C=z();return St({title:()=>b.route.getTitle(Mt.toString(C.name)??"")}),(R,U)=>{const _=le,s=Rt,x=Ut;return m(),Bt(x,{class:"main-widgets"},{default:l(()=>[r(s,{title:"Статистика аккаунта",identity:"account-stat"},{default:l(()=>[r(_)]),_:1})]),_:1})}}});export{Te as default};
