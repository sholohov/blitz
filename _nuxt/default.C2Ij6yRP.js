import{_ as F}from"./page.I4P4VUXF.js";import{h as S,_ as D,a as N,u as L}from"./disableScroll.C0aRP9sA.js";import{_ as P,a as z}from"./ContentBox.vue.C-VSBEfk.js";import{n as x,B as I,r as b,s as H,o as d,v as C,w as r,x as y,c as v,b as a,a as s,d as g,t as $,z as w,a4 as j,a5 as q,T as G,F as J,H as K,J as W,u as Q,h as X,f as Y}from"./entry.C7rsCkde.js";import{s as h,o as Z,d as ee,a as U}from"./request.2vtDDBdm.js";import{_ as R}from"./CDialog.vue.DWhS8OEK.js";import{_ as te}from"./client-only.DbbL8paw.js";import{a as k}from"./index.CiYw46hj.js";import{u as oe}from"./user.DLlwbhvI.js";import{u as ne}from"./index.EUvklMki.js";import{u as se}from"./index.DkVO-Tjf.js";import"./CInput.vue.zZzbFdHH.js";import"./notEmpty.BxBPJGBn.js";import"./debounce.C9J8JV9z.js";const ae={key:0,class:"update-message"},ie={class:"update-message__title"},ce=s("div",{class:"update-message__body"}," Что бы изменения вступили в силу, необходимо обновить страницу. ",-1),re={class:"update-message__control"},le=x({__name:"UpdateMessage",setup(B){I(()=>{_()});const l=b(!1),i=b(null),n=q(),p=H(()=>{const f=n.public.clientVersion;return!i.value||!f||l.value?!1:i.value!==f});function _(){const f=h.firebase.db();Z(ee(f,"app","info"),m=>{const u=m.data();i.value=(u==null?void 0:u.version)??null},m=>{S(m,{title:"Получение данных версии из Firebase"})})}function o(){location.reload()}function c(){l.value=!0}return(f,m)=>{const u=D,e=N,t=P;return d(),C(j,{name:"update-message-"},{default:r(()=>[y(p)?(d(),v("div",ae,[a(t,{class:"update-message__inner"},{default:r(()=>[s("div",ie,[a(u,{class:"update-message__icon",name:"new-releases"}),g(" Обновление v"+$(y(i)),1)]),ce,s("div",re,[a(e,{class:"update-message__btn",onClick:o},{default:r(()=>[g(" Обновить ")]),_:1}),a(e,{class:"update-message__btn",onClick:c},{default:r(()=>[g(" Скрыть ")]),_:1})])]),_:1})])):w("",!0)]),_:1})}}}),_e={class:"update-db-dialog__header"},ue=s("b",null,"База данных обновлена",-1),de=s("br",null,null,-1),pe=s("br",null,null,-1),fe=s("br",null,null,-1),me=s("br",null,null,-1),ge={style:{display:"flex","justify-content":"flex-end"}},he=x({__name:"UpdateDBDialog",emits:["confirm"],setup(B,{expose:l,emit:i}){const n=b(null),p=i;function _(){var c;(c=n.value)==null||c.doClose(),p("confirm")}function o(){var c;(c=n.value)==null||c.doOpen()}return l({open:o}),(c,f)=>{const m=D,u=N,e=R;return d(),C(e,{ref_key:"dialogRef",ref:n,class:"update-db-dialog","modal-enabled":"",width:"480px"},{title:r(()=>[s("div",_e,[a(m,{class:"update-db-dialog__icon",name:"database-alert"}),ue])]),footer:r(()=>[s("div",ge,[a(u,{onClick:_},{default:r(()=>[g(" Так точно ")]),_:1})])]),default:r(()=>[g(" Для продолжения использования необходимо: "),de,g(" 1. Закрыть все вкладки ресурса, кроме активной."),pe,g(" 2. Обновить текущую страницу."),fe,g(" 3. Готово."),me]),_:1},512)}}}),ye={class:"c-notification"},ve={key:0,class:"c-notification__item-title"},be={class:"c-notification__item-body"},ke=["onClick"],xe=x({__name:"CNotification",props:{appendToBody:Boolean},setup(B){const l=L(),i=n=>{if(n.title)return n.title;switch(n.type){case"success":return"Успешно";case"error":return"Ошибка";case"info":return"Информация";case"warning":return"Внимание";default:return n.title}};return(n,p)=>{const _=te;return d(),C(_,null,{default:r(()=>[s("div",ye,[a(G,{tag:"ul",class:"c-notification__list",name:"c-notification__item-"},{default:r(()=>[(d(!0),v(J,null,K(y(l).items,o=>(d(),v("li",{key:o.id,class:W(["c-notification__item",[o.type?"c-notification__item--"+o.type:""]])},[o.title||o.type?(d(),v("div",ve,$(i(o)),1)):w("",!0),s("div",be,$(o.message),1),s("button",{class:"c-notification__item-close",onClick:c=>y(l).remove(o)},null,8,ke)],2))),128))]),_:1})])]),_:1})}}}),Ce={class:"layout"},Fe=x({__name:"default",setup(B){const l=Q(),i=se(),n=oe(),p=ne(),_=b(null),o=b(null);f(),u(),X(()=>l.fullPath,async(e,t)=>{e!==t&&(await m(),p.toggleMainSearch(!1))}),Y(()=>{var e,t;p.mainSearchOpened?(e=_.value)==null||e.doOpen():(t=_.value)==null||t.doClose()}),I(()=>{const e=h.storage.getUser();e&&n.setUser({accountId:Number(e.account_id),name:e.nickname}),i.init()}),U.request.onError=({error:e})=>{(e==null?void 0:e.message)==="INVALID_ACCESS_TOKEN"&&(k.auth.logout(),n.resetUser(),h.storage.removeUser(),location.assign("/"))};async function c(e){try{await k.auth.login({id:e.account_id,token:e.access_token,expiresAt:new Date(+e.expires_at*1e3).toISOString()}),await k.user.set({id:e.account_id,name:e.nickname})}catch(t){console.error(t),S(t,{title:"Авторизация"}),await U.auth.logout()}}function f(){const e=h.url.getUser();e&&(h.storage.setUser(e),history.replaceState(null,document.title,location.pathname),c(e))}async function m(){const e=h.storage.getUser();if(e)try{await k.user.action({id:e.account_id})}catch(t){S(t,{title:"Действие пользователя",message:"[SELF API] "+(t instanceof Error?t.message:"Неизвестная ошибка")})}}async function u(){const e=await h.indexedDB.getInstance();e.onBlocked=()=>{var t;return(t=o.value)==null?void 0:t.open()}}return(e,t)=>{const E=F,M=le,T=he,V=z,O=R,A=xe;return d(),v("div",Ce,[a(E),a(M),a(T,{ref_key:"updateDBRef",ref:o},null,512),y(i).isTablet?(d(),C(O,{key:0,ref_key:"searchDialogRef",ref:_,title:"Поиск аккаунтов и кланов",width:"480px",position:"top",onClose:t[0]||(t[0]=Be=>y(p).toggleMainSearch(!1))},{default:r(()=>[a(V,{style:{height:"270px"}})]),_:1},512)):w("",!0),a(A)])}}});export{Fe as default};
