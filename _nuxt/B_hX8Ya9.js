import{_ as P}from"./BMjfXaaq.js";import{_ as W,a as w}from"./BHA4Nd6Z.js";import{f as j,h as G,r as c,i as b,q as O,y as z,M as H,o as r,c as u,a as I,b as L,k,l as J,w as Q,F as K,A as N,t as R,B as X,m as Y,W as Z,P as ee}from"./Dfk_Fzw6.js";import{n as te}from"./BxBPJGBn.js";import{d as ae}from"./DQzVWw1H.js";import{h as A}from"./BQaFixBN.js";const ne={class:"main-search__inner"},oe={class:"main-search__input"},se={key:0,class:"main-search__dropdown"},le={key:0,class:"main-search__item-title"},ce=["onKeydown","onClick","textContent"],he=j({__name:"MainSearch",props:{context:{type:String,default:"account"}},setup(ie){const S=G(),x=c(null),h=c(null),o=c(""),_=c([]),p=c([]),y=c([]),f=c([]),i=c(0),v=c(-1),T=b(()=>[_.value,p.value,y.value]),V=b(()=>[_.value,p.value,y.value].some(e=>e.length>0));O(()=>{window.addEventListener("click",C)}),z(()=>{window.removeEventListener("click",C)});function g(){_.value=[],p.value=[],y.value=[]}function C(e){var t;(t=x.value)!=null&&t.contains(e.target)||(g(),o.value="")}async function E(e){var t;g(),await S.push({name:e.context+"-id",params:{id:String(e.id)}}),(t=h.value)==null||t.focus()}function B(){var t;const e=(t=x.value)==null?void 0:t.querySelectorAll(".main-search__item-btn");return e?[...e]:[]}async function D(e){i.value++;try{const n=((await w.account.getList({search:e,limit:5})).data||[]).map(a=>({name:a.nickname,id:a.account_id,context:"account"}));if(n.length){const a=await w.clan.getAccountInfo({extra:"clan",account_id:n.map(l=>l.id).join(",")});a.data&&n.forEach(l=>{var s,m;const d=(m=(s=a.data[l.id])==null?void 0:s.clan)==null?void 0:m.tag;l.name+=d?` [${d}]`:""}),_.value=[{id:1,name:"Аккаунты",context:"title"},...n]}}catch(t){A(t,{title:"Поиск аккаунта"})}i.value--}async function U(e){i.value++;try{const{data:t}=await w.clan.getList({search:e,limit:5}),n=(t.filter(te)??[]).map(a=>({name:`[${a.tag}] ${a.name}`,id:a.clan_id,context:"clan"}));n.length&&(p.value=[{id:2,name:"Кланы",context:"title"},...n])}catch(t){A(t,{title:"Поиск клана"})}i.value--}async function M(e){i.value++;try{const n=((await w.tournaments.getList({search:e,limit:5})).data||[]).map(a=>({name:a.title,id:a.tournament_id,context:"tournaments"}));n.length&&(y.value=[{id:3,name:"Турниры",context:"title"},...n])}catch(t){A(t,{title:"Поиск турнира"})}i.value--}async function q(){var e,t;((e=o.value)==null?void 0:e.length)>=3&&/[^а-яё]+/gi.test(o.value)&&await D(o.value.trim()),((t=o.value)==null?void 0:t.length)>=2&&(await U(o.value.trim()),await M(o.value.trim())),await ee(),f.value=B()}const F=ae(q,1e3,{leading:!0});H(async()=>{o.value=o.value.replace(/\/\d+$/,"").trim(),o.value.length<2&&g(),await F()});function $(e){var n,a,l,d,s,m;const t=e.target;i.value>0||(e.key==="Escape"&&(g(),o.value="",v.value=-1,(n=h.value)==null||n.focus()),t.tagName==="INPUT"&&(v.value=-1),e.key==="ArrowUp"&&(e.preventDefault(),(a=f.value)!=null&&a.length&&v.value>0?(l=f.value[--v.value])==null||l.focus():(d=h.value)==null||d.focus()),e.key==="ArrowDown"&&(e.preventDefault(),(s=f.value)!=null&&s.length&&v.value<f.value.length-1&&((m=f.value[++v.value])==null||m.focus())))}return(e,t)=>{const n=P,a=W;return r(),u("div",{ref_key:"rootRef",ref:x,class:"main-search"},[I("div",ne,[I("div",oe,[L(n,{ref_key:"inputRef",ref:h,modelValue:k(o),"onUpdate:modelValue":t[0]||(t[0]=l=>J(o)?o.value=l:null),placeholder:"Поиск игрока, клана или турнира",type:"search",onKeydown:$},null,8,["modelValue"])]),L(Z,null,{default:Q(()=>[k(V)?(r(),u("div",se,[(r(!0),u(K,null,N(k(T),(l,d)=>(r(),u("ul",{key:d,class:"main-search__list",onKeydown:$},[(r(!0),u(K,null,N(l,s=>(r(),u("li",{key:s.context+s.id,class:"main-search__item"},[s.context==="title"?(r(),u("div",le,R(s.name),1)):(r(),u("button",{key:1,class:"main-search__item-btn",onKeydown:X(m=>E(s),["enter"]),onClick:m=>E(s),textContent:R(s.name)},null,40,ce))]))),128))],32))),128)),L(a,{loading:k(i)>0},null,8,["loading"])])):Y("",!0)]),_:1})])],512)}}});export{he as _};
