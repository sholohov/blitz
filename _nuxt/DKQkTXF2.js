import{_ as G}from"./BveeJNLj.js";import{h as S,_ as I,u as H}from"./DtA1LByL.js";import{_ as M}from"./DGLDZ4cR.js";import{_ as K}from"./BKiIIqfs.js";import{f as N,q as T,r as $,i as W,o as f,j as C,w as _,k as v,c as B,b as r,a as i,d as g,t as O,m as A,X,a0 as P,T as Y,F as J,A as Q,C as Z,g as q,h as ee,z as te,N as oe,af as se,O as ne}from"./ByGHtsLc.js";import{s as p,o as ae,d as ie,a as D}from"./DRW9HJMp.js";import{_ as V}from"./BQPDEBlD.js";import{_ as ce}from"./g4g0RxE0.js";import{_ as re}from"./D-G4pc_H.js";import{a as w}from"./wDhpCTVo.js";import{u as _e}from"./DFAQjZIE.js";import{u as le}from"./DyNKK-9z.js";import{u as ue}from"./CMJjbvSz.js";import"./CUl2OyUw.js";import"./BxBPJGBn.js";import"./C4sXLknC.js";const de={key:0,class:"update-message"},pe={class:"update-message__title"},fe=i("div",{class:"update-message__body"}," Что бы изменения вступили в силу, необходимо обновить страницу. ",-1),me={class:"update-message__control"},ge=N({__name:"UpdateMessage",setup(x){T(()=>{u()});const n=$(!1),a=$(null),o=P(),h=W(()=>{const m=o.public.clientVersion;return!a.value||!m||n.value?!1:a.value!==m});function u(){const m=p.firebase.db();ae(ie(m,"app","info"),l=>{const d=l.data();a.value=(d==null?void 0:d.version)??null},l=>{S(l,{title:"Получение данных версии из Firebase"})})}function s(){location.reload()}function c(){n.value=!0}return(m,l)=>{const d=I,k=M,R=K;return f(),C(X,{name:"update-message-"},{default:_(()=>[v(h)?(f(),B("div",de,[r(R,{class:"update-message__inner"},{default:_(()=>[i("div",pe,[r(d,{class:"update-message__icon",name:"new-releases"}),g(" Обновление v"+O(v(a)),1)]),fe,i("div",me,[r(k,{class:"update-message__btn",onClick:s},{default:_(()=>[g(" Обновить ")]),_:1}),r(k,{class:"update-message__btn",onClick:c},{default:_(()=>[g(" Скрыть ")]),_:1})])]),_:1})])):A("",!0)]),_:1})}}}),he={class:"update-db-dialog__header"},ke=i("b",null,"База данных обновлена",-1),ye=i("br",null,null,-1),ve=i("br",null,null,-1),xe=i("br",null,null,-1),be=i("br",null,null,-1),Ue={style:{display:"flex","justify-content":"flex-end"}},we=N({__name:"UpdateDBDialog",emits:["confirm"],setup(x,{expose:n,emit:a}){const o=$(null),h=a;function u(){var c;(c=o.value)==null||c.doClose(),h("confirm")}function s(){var c;(c=o.value)==null||c.doOpen()}return n({open:s}),(c,m)=>{const l=I,d=M,k=V;return f(),C(k,{ref_key:"dialogRef",ref:o,class:"update-db-dialog","modal-enabled":"",width:"480px"},{title:_(()=>[i("div",he,[r(l,{class:"update-db-dialog__icon",name:"database-alert"}),ke])]),footer:_(()=>[i("div",Ue,[r(d,{onClick:u},{default:_(()=>[g(" Так точно ")]),_:1})])]),default:_(()=>[g(" Для продолжения использования необходимо: "),ye,g(" 1. Закрыть все вкладки ресурса, кроме активной."),ve,g(" 2. Обновить текущую страницу."),xe,g(" 3. Готово."),be]),_:1},512)}}}),Se={class:"ui-notification"},Be={key:0,class:"ui-notification__item-title"},$e={class:"ui-notification__item-body"},De=["onClick"],Ne=N({__name:"UiNotification",props:{appendToBody:{type:Boolean,default:!1}},setup(x){const n=H(),a=o=>{if(o.title)return o.title;switch(o.type){case"success":return"Успешно";case"error":return"Ошибка";case"info":return"Информация";case"warning":return"Внимание";default:return o.title}};return(o,h)=>{const u=re;return f(),C(u,null,{default:_(()=>[i("div",Se,[r(Y,{tag:"ul",class:"ui-notification__list",name:"ui-notification__item-"},{default:_(()=>[(f(!0),B(J,null,Q(v(n).items,s=>(f(),B("li",{key:s.id,class:Z(["ui-notification__item",[s.type?"ui-notification__item--"+s.type:""]])},[s.title||s.type?(f(),B("div",Be,O(a(s)),1)):A("",!0),i("div",$e,O(s.message),1),i("button",{class:"ui-notification__item-close",onClick:c=>v(n).remove(s)},null,8,De)],2))),128))]),_:1})])]),_:1})}}}),Ce=()=>{const x=new URL(location.href),n=Object.fromEntries(x.searchParams.entries()),a={access_token:n.access_token,expires_at:n.expires_at,account_id:n.account_id,nickname:n.nickname};return Object.values(a).every(o=>o)?a:null},Re={getUser:Ce},Ee={class:"layout"},Je=N({__name:"default",setup(x){const n=q(),a=ee(),o=ue(),h=_e(),u=le(),s=$(null),c=$(null);R(),L(),te(()=>n.fullPath,async(e,t)=>{e!==t&&(await F(),u.toggleMainSearch(!1))}),oe(()=>{var e,t;u.mainSearchOpened?(e=s.value)==null||e.doOpen():(t=s.value)==null||t.doClose()}),T(()=>{o.init();const e=p.storage.getUser();e&&h.setUser({accountId:Number(e.account_id),name:e.nickname})});function m(){w.auth.logout(),h.resetUser(),p.storage.removeUser(),location.assign("/")}D.request.onError=({error:e})=>{(e==null?void 0:e.message)==="INVALID_ACCESS_TOKEN"&&m()};let l=!1;async function d(){if(l)return;const e=p.storage.getUser();if(!e||Number.isNaN(+e.expires_at))return;const t=+e.expires_at*1e3,b=Date.now();if(!(t<=b)&&!(t-b>se)){l=!0;try{const y=b+ne*13,{data:U}=await D.auth.prolongate({expires_at:Math.round(y/1e3),access_token:e.access_token});p.storage.setUser({...e,access_token:U.access_token,expires_at:String(U.expires_at)}),w.auth.prolongate({id:e.account_id,expiresAt:new Date(y).toISOString(),token:U.access_token}).catch(E=>{S(E,{title:"Продление сессии авторизации"})})}catch(y){S(y,{title:"Продление сессии авторизации"})}l=!1}}D.request.beforeRequest=async e=>{e.method==="get"&&(e.params=e.params??{},e.params.access_token=p.storage.getAccessToken(),e.params.application_id=P().public.appId),e.url.includes("prolongate")||await d()};async function k(e){try{await w.auth.login({id:e.account_id,token:e.access_token,expiresAt:new Date(+e.expires_at*1e3).toISOString()}),await w.user.set({id:e.account_id,name:e.nickname})}catch(t){console.error(t),S(t,{title:"Авторизация"}),await D.auth.logout()}}function R(){const e=Re.getUser();e&&(p.storage.setUser(e),a.replace("/"),k(e))}async function F(){const e=p.storage.getUser();if(e)try{await w.user.action({id:e.account_id})}catch(t){S(t,{title:"Действие пользователя",message:"[SELF API] "+(t instanceof Error?t.message:"Неизвестная ошибка")})}}async function L(){const e=await p.indexedDB.getInstance();e.onBlocked=()=>{var t;return(t=c.value)==null?void 0:t.open()}}return(e,t)=>{const b=G,y=ge,U=we,E=ce,j=V,z=Ne;return f(),B("div",Ee,[r(b),r(y),r(U,{ref_key:"updateDBRef",ref:c},null,512),v(o).isTablet?(f(),C(j,{key:0,ref_key:"searchDialogRef",ref:s,title:"Поиск аккаунтов и кланов",width:"480px",position:"top",onClose:t[0]||(t[0]=Oe=>v(u).toggleMainSearch(!1))},{default:_(()=>[r(E,{style:{height:"270px"}})]),_:1},512)):A("",!0),r(z)])}}});export{Je as default};
