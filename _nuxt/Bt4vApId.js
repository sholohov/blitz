import{_ as q}from"./uZwePpIY.js";import{_ as H}from"./BUTcSoIg.js";import{_ as O}from"./CW4r_PKK.js";import{d as U,u as G,k as D,l as M,c as W,m as _,n as b,h as p,w as o,f as v,p as F,x as R,s as x,q as S,o as c,e as g,t as T,v as f,_ as J,y as K}from"./DEnf58KD.js";import{_ as Q}from"./CUKP7nec.js";import{_ as X}from"./CfjgP0ko.js";import{_ as Y}from"./Co0YW0xm.js";import{n as B}from"./BxBPJGBn.js";import{s as C}from"./BLrdWoSV.js";import"./DD4asW33.js";const Z={class:"account-tracked"},tt={key:1},at={key:0},nt={key:1},et={key:1},ct={key:1},it={key:0},st={key:1},ot={key:1},ht=U({__name:"tracked",setup(lt){G({title:"Отслеживаемые / Аккаунты"});const e=D({loading:0,items:[],accountsLocal:null}),m=D({total:0,page:1,pageSize:100}),I=[{key:"nickname",label:"Ник"},{key:"clan",label:"Клан"},{key:"battles",label:"Боёв"},{key:"winRate",label:"Побед"},{key:"damagePerBattle",label:"Урон"},{key:"rating",label:"Рейтинг"},{key:"lastBattleTime",width:160,label:"Последний бой",formatter:t=>typeof t=="number"?F.date.toRelativeTime(t*1e3):"---"},{key:"actions",width:60}];M(()=>{w()});const A=W(()=>{const t=m.page*m.pageSize,a=t-m.pageSize;return(e.accountsLocal??[]).filter(B).slice(a,t)});async function L(){e.loading++;try{const{$indexedDB:t}=R(),a=await t.accountsInfo.getAll();e.accountsLocal=(a??[]).map(l=>l.data).sort((l,s)=>s.last_battle_time-l.last_battle_time),m.total=(a==null?void 0:a.length)??0}catch(t){x(t,{title:"Ошибка поучения локального списка аккаунтов"})}e.loading--}async function P(t){e.loading++;try{const a=await S.account.getInfo({extra:"statistics.rating",account_id:t.join(",")});return Object.values(a.data).filter(B)}catch(a){return x(a,{title:"Ошибка поучения списка аккаунтов"}),[]}finally{e.loading--}}async function N(t){e.loading++;try{const{data:a}=await S.clan.getAccountInfo({extra:"clan",account_id:t.join(",")});return Object.values(a).filter(B)}catch(a){return x(a,{title:"Ошибка поучения списка клановых аккаунтов"}),[]}finally{e.loading--}}async function w(){var t;e.accountsLocal||await L(),(t=e.accountsLocal)!=null&&t.length&&await $()}function j(t,a){const l=A.value.map(s=>{const r=t.find(d=>d.account_id===s.account_id);if(!r)return{id:s.account_id,nickname:s.nickname,lastBattleTime:NaN,isDeleted:!0,statistic:null,clan:null};const u=r.statistics,k=C.accountAll(u.all),y=u.rating?C.accountRating(u.rating):null,{clan:h}=a.find(d=>(d==null?void 0:d.account_id)===r.account_id)??{};return{id:r.account_id,nickname:r.nickname,lastBattleTime:r.last_battle_time,statistic:{all:k,rating:y},clan:h??null}});e.items=l.sort((s,r)=>r.lastBattleTime-s.lastBattleTime)}async function $(){const t=A.value.map(s=>s.account_id);if(!t.length)return;const[a,l]=await Promise.all([P(t),N(t)]);j(a,l)}async function E(t){const{$indexedDB:a}=R();await Promise.all([a.accountsInfo.remove(t),a.accountsAchievements.remove(t),a.tanksStat.remove(t)])}async function z(t){await E(t),e.items.length<m.total?e.items=e.items.filter(a=>a.id!==t):await w()}async function V(){await $()}return(t,a)=>{const l=q,s=H,r=O,u=J,k=K,y=Q,h=X,d=Y;return c(),_("div",Z,[a[0]||(a[0]=b("div",{class:"account-tracked__description content-area",style:{"max-width":"800px"}},[b("p",null,"Список игроков, статистика которых отслеживается. Данные хранятся в браузере."),b("p",null," Отслеживание начинается с момента просмотра аккаунта на данном ресурсе. После удаления из списка - отслеживание прекращается. ")],-1)),p(h,{"no-wrap":"","scroll-to-top":"","scroll-auto-disabling":"",headers:I,data:v(e).items,height:"calc(100vh - 112px)"},{nickname:o(({row:n})=>[n.isDeleted?(c(),_("span",tt,f(n.nickname),1)):(c(),g(l,{key:0,class:"account-tracked__link link",to:{name:"account-id",params:{id:n.id}}},{default:o(()=>[T(f(n.nickname),1)]),_:2},1032,["to"]))]),battles:o(({row:n})=>{var i;return[n.isDeleted?(c(),_("span",nt,"---")):(c(),_("span",at,f((i=n.statistic)==null?void 0:i.all.battles),1))]}),winRate:o(({row:n})=>{var i;return[n.isDeleted?(c(),_("span",et,"---")):(c(),g(s,{key:0,"win-rate":(i=n.statistic)==null?void 0:i.all.winRate,class:"account-tracked__win-rate"},null,8,["win-rate"]))]}),rating:o(({row:n})=>{var i;return[n.isDeleted?(c(),_("span",ct,"---")):(c(),g(r,{key:0,rating:(i=n.statistic)==null?void 0:i.rating},null,8,["rating"]))]}),damagePerBattle:o(({row:n})=>{var i;return[n.isDeleted?(c(),_("span",st,"---")):(c(),_("span",it,f((i=n.statistic)==null?void 0:i.all.damagePerBattle),1))]}),clan:o(({row:n})=>[n.clan?(c(),g(l,{key:0,title:n.clan.name,class:"account-tracked__link link",to:{name:"clan-id",params:{id:n.clan.clan_id}}},{default:o(()=>[T(f(n.clan.tag),1)]),_:2},1032,["title","to"])):(c(),_("span",ot,"---"))]),actions:o(({row:n})=>[p(k,{title:"Удалить","is-text":"","is-square":"",onClick:i=>z(n.id)},{default:o(()=>[p(u,{name:"delete"})]),_:2},1032,["onClick"])]),footer:o(()=>[p(y,{pagination:v(m),onChange:V},null,8,["pagination"])]),_:1},8,["data"]),p(d,{loading:v(e).loading>0},null,8,["loading"])])}}});export{ht as default};
