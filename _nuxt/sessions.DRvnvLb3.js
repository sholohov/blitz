import{_ as ft}from"./nuxt-link.CEOfUkt0.js";import{u as et,a as _t,_ as pt}from"./disableScroll.BUC5HZdp.js";import{_ as gt}from"./WinRate.vue.DiFcwfq2.js";import{_ as ht}from"./RatingIcon.vue.EjjZvg7-.js";import{_ as yt}from"./TablePagination.vue.bq_TiTlK.js";import{_ as vt}from"./CTable.vue.Cu8sf2MZ.js";import{_ as bt}from"./CInput.vue.Bb_H1cLp.js";import{_ as nt}from"./ContentLoader.vue.kCcbdDCf.js";import{f as J,v as Y,x as kt,r as G,n as T,q as st,y as St,z as at,o as I,c as L,a as u,b as r,k as C,F as ot,A as At,B as wt,t as _,m as $t,h as It,g as Ct,i as Z,d as f,w as l,j as Et}from"./entry.FvyONZHj.js";import{d as Rt}from"./debounce.DGlJ09yO.js";import{a as N}from"./request.CuV_NRrd.js";import{a as H}from"./index.Dsl6k6x1.js";import{_ as Lt}from"./CDialog.vue.BpKdiBXO.js";import{n as tt}from"./notEmpty.BxBPJGBn.js";import{f as V}from"./index.DVAFURtC.js";import{s as P}from"./index.CPrYhzBm.js";const Bt={class:"c-search__inner"},Ot={class:"c-search__input"},Pt={key:0,class:"c-search__dropdown"},xt=["onKeydown","onClick"],Tt=J({__name:"CSearch",props:Y({items:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1},placeholder:{type:String,default:void 0}},{modelValue:{required:!0,default:""},modelModifiers:{}}),emits:Y(["reset","input","select"],["update:modelValue"]),setup(p,{emit:d}){const e=kt(p,"modelValue"),a=p,g=G(),h=G(null),o=T({isOpen:!1,btnList:[],focusedElemIndex:-1});st(()=>{window.addEventListener("click",y)}),St(()=>{window.removeEventListener("click",y)});const O=d;at(()=>a.items,()=>{o.isOpen=a.items.length>0,A()});function B(){O("reset"),o.focusedElemIndex=-1,o.isOpen=!1}function y(i){var m;(m=g.value)!=null&&m.contains(i.target)||(o.isOpen=!1)}function c(i){O("select",i),o.isOpen=!1,setTimeout(()=>{var m;return(m=h.value)==null?void 0:m.focus},300)}function A(){var i;(i=g.value)==null||i.querySelectorAll(".c-search__item-btn").forEach(m=>{o.btnList.push(m)})}function v(i){var E,R,S,x,q,D;const m=i.target;a.loading||(i.key==="Escape"&&(B(),o.focusedElemIndex=-1,(E=h.value)==null||E.focus()),m.tagName==="INPUT"&&(o.focusedElemIndex=-1),i.key==="ArrowUp"&&(i.preventDefault(),(R=o.btnList)!=null&&R.length&&o.focusedElemIndex>0?(S=o.btnList[--o.focusedElemIndex])==null||S.focus():(x=h.value)==null||x.focus()),i.key==="ArrowDown"&&(i.preventDefault(),(q=o.btnList)!=null&&q.length&&o.focusedElemIndex<o.btnList.length-1&&((D=o.btnList[++o.focusedElemIndex])==null||D.focus())))}return(i,m)=>{const E=bt,R=nt;return I(),L("div",{ref_key:"rootRef",ref:g,class:"c-search"},[u("div",Bt,[u("div",Ot,[r(E,{ref_key:"inputRef",ref:h,modelValue:e.value,"onUpdate:modelValue":m[0]||(m[0]=S=>e.value=S),modelModifiers:{trim:!0},placeholder:p.placeholder,type:"search",onKeydown:v},null,8,["modelValue","placeholder"])]),C(o).isOpen?(I(),L("div",Pt,[u("ul",{class:"c-search__list",onKeydown:v},[(I(!0),L(ot,null,At(p.items,S=>(I(),L("li",{key:String(S.value),class:"c-search__item"},[u("button",{class:"c-search__item-btn",onKeydown:wt(x=>c(S),["enter"]),onClick:x=>c(S)},_(S.label),41,xt)]))),128))],32),r(R,{loading:p.loading},null,8,["loading"])])):$t("",!0)])],512)}}}),jt={class:"account-sessions-search"},Vt=J({__name:"AccountSessionsSearch",emits:["select"],setup(p,{emit:d}){const e=et(),a=T({items:[],loading:0,search:""}),g=d;async function h(y=""){a.loading++;try{const A=((await H.session.account.getList({query:y})).data||[]).map(v=>({label:v.raw.nickname,value:v.raw.account_id}));if(A.length){const v=await N.clan.getAccountInfo({extra:"clan",account_id:A.map(i=>i.value).join(",")});v.data&&A.forEach(i=>{var E,R;const m=(R=(E=v.data[String(i.value)])==null?void 0:E.clan)==null?void 0:R.tag;i.label+=m?` [${m}]`:""})}a.items=A}catch(c){e.add({type:"error",message:c instanceof Error?c.message:"Поиск аккаунта"}),console.error(c)}a.loading--}const o=Rt(h,1e3,{leading:!0});at(()=>a.search,async()=>{if(a.search.length<=2){a.items=[];return}await o(a.search)});function O(y){a.items=[],a.search="",g("select",y)}function B(){a.search="",a.items=[]}return(y,c)=>{const A=Tt;return I(),L("div",jt,[r(A,{modelValue:C(a).search,"onUpdate:modelValue":c[0]||(c[0]=v=>C(a).search=v),placeholder:"Введите ник игрока",items:C(a).items,loading:C(a).loading>0,onSelect:O,onReset:B},null,8,["modelValue","items","loading"])])}}}),it=(p,d)=>{if(p===d)return!0;if(p===null||d===null||typeof p!="object"||typeof d!="object")return!1;const e=Object.keys(p),a=Object.keys(d);if(e.length!==a.length)return!1;for(let g=0;g<e.length;g+=1){const h=e[g];if(!a.includes(h)||!it(p[h],d[h]))return!1}return!0},Nt={class:"account-sessions"},qt={class:"account-sessions__description content-area",style:{"max-width":"800px"}},Dt=u("b",null,"Командная игра (КМД)",-1),Ft={class:"account-sessions__filters"},Kt={class:"account-sessions__filters-item"},zt={class:"account-sessions__filters-item"},Mt={class:"account-sessions__sub"},Ut={class:"account-sessions__sub"},Qt={key:1},Wt={class:"account-sessions__win-rate--sub"},Gt={class:"account-sessions__sub"},Ht={key:1},Jt={class:"account-sessions__sub"},Xt={class:"account-sessions__sub"},_e=J({__name:"sessions",setup(p){const d=G(null),e=T({loading:0,items:[],achievementsInfo:null,achievementsSessions:[],achievements:null,clanAccounts:null,accounts:[],accountsSessions:[]}),a=et(),g=It(),h=Ct(),o=T({total:0,page:1,pageSize:100}),O={order:"desc",prop:"updateAt"},B=T(O),y=V.makeAccountSessionsFilters(),c=T(y),A=Z(()=>{const t=[{key:"nickname",label:"Ник",sortable:"custom"},{key:"clan",label:"Клан"},{key:"battles",label:"Боёв"},{key:"winRate",label:"Побед"},{key:"damagePerBattle",label:"Урон"},{key:"teamPoints",label:"КМД *"},{key:"updateAt",width:180,label:"Дата начала",sortable:"custom"},{key:"last_battle_time",width:180,label:"Последний бой"}];return c.ids.length&&t.push({key:"actions"}),t}),v=Z(()=>!it(c,y));st(()=>{Object.assign(c,V.makeAccountSessionsFilters({...y,...h.query})),i()});async function i(){e.loading++,await E(c.ids);const t=e.accountsSessions.map(n=>n.id);t.length&&(await Promise.all([S(),R(t),x(t),q(t),D(t)]),m()),e.loading--}function m(){e.items=e.accountsSessions.map(({raw:t,updateAt:n,id:w})=>{var s,k,X;const $=e.accounts.find(W=>W.account_id===w);if(!$)return null;const b={...t,statistics:P.diffFull($.statistics,t.statistics),updateAt:new Date(n).valueOf()},j=b.statistics,M=P.accountAll(j.all),U=j.rating?P.accountRating(j.rating):null,Q=(k=(s=e.clanAccounts)==null?void 0:s[b.account_id])==null?void 0:k.clan,F=e.achievementsSessions.find(W=>W.id===b.account_id);let K=NaN;const z=(X=e.achievements)==null?void 0:X[b.account_id];return z&&F&&e.achievementsInfo&&(K=P.teamPoints(b.statistics,P.achievementsDiff(z,F.raw,e.achievementsInfo))),{updateAt:b.updateAt,id:b.account_id,nickname:b.nickname,lastBattleTime:$.last_battle_time,teamPoints:K,currentStatistic:{all:P.accountAll($.statistics.all),rating:$.statistics.rating?P.accountRating($.statistics.rating):null},statistic:{all:M,rating:U},clan:Q??null}}).filter(tt)}async function E(t){e.loading++;try{const{data:n,meta:w}=await H.session.account.getList({ids:t,pageSize:o.pageSize,page:o.page,sort:`${B.prop}:${B.order}`});o.total=(w==null?void 0:w.total)??0,e.accountsSessions=n}catch(n){console.error(n),a.add({type:"error",title:"Ошибка поучения сессий аккаунтов",message:n instanceof Error?n.message:"Неизвестная ошибка"})}e.loading--}async function R(t){e.loading++;try{const{data:n}=await H.session.accountAchievements.getList({ids:t,pageSize:o.pageSize});e.achievementsSessions=n}catch(n){console.error(n),a.add({type:"error",title:"Ошибка поучения сессий достижений",message:n instanceof Error?n.message:"Неизвестная ошибка"})}e.loading--}async function S(){if(!e.achievementsInfo){e.loading++;try{const{data:t}=await N.encyclopedia.getAchievements();e.achievementsInfo=t??null}catch(t){console.error(t),a.add({type:"error",title:"Ошибка поучения описания достижений",message:t instanceof Error?t.message:"Неизвестная ошибка"})}e.loading--}}async function x(t){e.loading++;try{const n=await N.account.getInfo({extra:"statistics.rating",account_id:t.join(",")});e.accounts=Object.values(n.data).filter(tt)??null}catch(n){a.add({type:"error",title:"Ошибка поучения списка аккаунтов",message:n instanceof Error?n.message:"Неизвестная ошибка"}),console.error(n)}e.loading--}async function q(t){e.loading++;try{const{data:n}=await N.account.getAchievements({account_id:t.join(",")});e.achievements=n??null}catch(n){console.error(n),a.add({type:"error",title:"Ошибка поучения списка достижений аккаунтов",message:n instanceof Error?n.message:"Неизвестная ошибка"})}e.loading--}async function D(t){e.loading++;try{const{data:n}=await N.clan.getAccountInfo({extra:"clan",account_id:t.join(",")});e.clanAccounts=n??null}catch(n){a.add({type:"error",title:"Ошибка поучения списка клановых аккаунтов",message:n instanceof Error?n.message:"Неизвестная ошибка"}),console.error(n)}e.loading--}function ct(t){B.order=t.order,B.prop=t.prop,i()}async function lt({value:t}){await(d==null?void 0:d.value.doClose()),c.ids.includes(t)||(c.ids=[...c.ids,t]),await g.push({query:{...h.query,...V.toRouteQuery(c)}}),await i()}function rt(){d==null||d.value.doOpen()}function ut(t){e.items=e.items.filter(n=>n.id!==t.id),c.ids=e.items.map(n=>n.id),g.push({query:V.toRouteQuery(c)}),i()}async function dt(){Object.assign(c,y),await g.push({query:V.toRouteQuery(c)}),i()}async function mt(t){Object.assign(o,t),await i()}return(t,n)=>{const w=ft,$=pt,b=_t,j=gt,M=ht,U=yt,Q=vt,F=Vt,K=Lt,z=nt;return I(),L("div",Nt,[u("div",qt,[u("p",null,[f(' "Сессии" - статистика пользователей за определённый период. Активировать сбор статистики можно через '),r(w,{to:{name:"widgets"}},{default:l(()=>[f(" виджет сессии ")]),_:1}),f(" . Данные хранятся на сервере ресурса. ")]),u("ul",null,[u("li",null,[Dt,f(" - сумма нескольких показателей, основной смысл - оценка игры взводом. Подробнее на "),r(w,{to:{name:"widgets"}},{default:l(()=>[f(" Странице Виджета ")]),_:1})])])]),f(" Фильтры "),u("div",Ft,[u("div",Kt,[r(b,{onClick:rt},{after:l(()=>[r($,{name:"add"})]),default:l(()=>[f(" По игроку ")]),_:1})]),u("div",zt,[r(b,{disabled:!C(v),onClick:dt},{after:l(()=>[r($,{name:"close"})]),default:l(()=>[f(" Очистить ")]),_:1},8,["disabled"])])]),r(Q,{"no-wrap":"","scroll-to-top":"","scroll-auto-disabling":"","default-sort":O,headers:C(A),data:C(e).items,height:"calc(100vh - 112px)",onSort:ct},{nickname:l(({row:s})=>[r(w,{class:"account-sessions__nickname link",to:{name:"account-id",params:{id:s.id}}},{default:l(()=>[f(_(s.nickname),1)]),_:2},1032,["to"])]),battles:l(({row:s})=>{var k;return[f(_(t.$formatter.number.toInteger(s.statistic.all.battles))+" ",1),u("div",Mt,_(t.$formatter.number.toInteger((k=s.currentStatistic)==null?void 0:k.all.battles)||"---"),1)]}),teamPoints:l(({row:s})=>[Number.isNaN(s.teamPoints)?(I(),L("span",Qt," --- ")):(I(),L(ot,{key:0},[f(_(t.$formatter.number.toInteger(s.teamPoints/s.statistic.all.battles)||0)+" ",1),u("span",Ut,_(t.$formatter.number.toInteger(s.teamPoints)||0),1)],64))]),winRate:l(({row:s})=>{var k;return[r(j,{"model-value":s.statistic.all.winRate,class:"account-sessions__win-rate"},null,8,["model-value"]),u("div",Wt,_(t.$formatter.number.toFloatPercent((k=s.currentStatistic)==null?void 0:k.all.winRate)||"---"),1)]}),rating:l(({row:s})=>[r(M,{rating:s.statistic.rating},null,8,["rating"])]),damagePerBattle:l(({row:s})=>{var k;return[f(_(t.$formatter.number.toInteger(s.statistic.all.damagePerBattle))+" ",1),u("div",Gt,_(t.$formatter.number.toInteger((k=s.currentStatistic)==null?void 0:k.all.damagePerBattle)||"---"),1)]}),clan:l(({row:s})=>[s.clan?(I(),Et(w,{key:0,title:s.clan.name,class:"account-sessions__clan link",to:{name:"clan-id",params:{id:s.clan.clan_id}}},{default:l(()=>[f(_(s.clan.tag),1)]),_:2},1032,["title","to"])):(I(),L("span",Ht,"---"))]),last_battle_time:l(({row:s})=>[f(_(t.$formatter.date.toRelativeTime(s.lastBattleTime*1e3))+" ",1),u("span",Jt,_(t.$formatter.date.toDateTime(s.lastBattleTime*1e3)),1)]),updateAt:l(({row:s})=>[f(_(t.$formatter.date.toRelativeTime(s.updateAt))+" ",1),u("span",Xt,_(t.$formatter.date.toDateTime(s.updateAt)),1)]),actions:l(({row:s})=>[r(b,{"is-text":"","is-square":"",onClick:k=>ut(s)},{default:l(()=>[r($,{name:"delete"})]),_:2},1032,["onClick"])]),footer:l(()=>[r(U,{pagination:C(o),onChange:mt},null,8,["pagination"])]),_:1},8,["headers","data"]),r(K,{ref_key:"addAccountDialogRef",ref:d,width:"400px",position:"top",title:"Поиск игрока"},{default:l(()=>[r(F,{style:{height:"270px"},onSelect:lt})]),_:1},512),r(z,{loading:C(e).loading>0},null,8,["loading"])])}}});export{_e as default};
