import{_ as k}from"./6tf917RV.js";import{u as T,V as p,r as C,W as E,X as I,Y as M,B as N,C as O,Z as B,$ as x,g as m,a0 as V,a1 as H,a2 as U,d as W,a3 as z,a as $,b as j,l as q,e as A,m as K,M as L,n as F,p as G,I as X,a4 as Y,j as Z,i as J,G as Q,o as aa}from"./BzQ49_ll.js";import{c as P}from"./B4FMxlHh.js";import{u as ea}from"./BLT2yTlJ.js";import{s as ta}from"./D4Kpt4ri.js";import{s as D}from"./DhcCwqhx.js";import"./z8RK9n7K.js";import"./DD4asW33.js";const sa=s=>s==="defer"||s===!1;function na(...s){var u;const r=typeof s[s.length-1]=="string"?s.pop():void 0;typeof s[0]!="string"&&s.unshift(r);let[t,f,e={}]=s;if(typeof t!="string")throw new TypeError("[nuxt] [asyncData] key must be a string.");if(typeof f!="function")throw new TypeError("[nuxt] [asyncData] handler must be a function.");const a=T(),h=f,g=()=>p.value,b=()=>a.isHydrating?a.payload.data[t]:a.static.data[t];e.server=e.server??!0,e.default=e.default??g,e.getCachedData=e.getCachedData??b,e.lazy=e.lazy??!1,e.immediate=e.immediate??!0,e.deep=e.deep??p.deep,e.dedupe=e.dedupe??"cancel";const _=e.getCachedData(t,a),w=_!=null;if(!a._asyncData[t]||!e.immediate){(u=a.payload._errors)[t]??(u[t]=p.errorValue);const o=e.deep?C:E;a._asyncData[t]={data:o(w?_:e.default()),pending:C(!w),error:I(a.payload._errors,t),status:C("idle"),_default:e.default}}const n={...a._asyncData[t]};delete n._default,n.refresh=n.execute=(o={})=>{if(a._asyncDataPromises[t]){if(sa(o.dedupe??e.dedupe))return a._asyncDataPromises[t];a._asyncDataPromises[t].cancelled=!0}if(o._initial||a.isHydrating&&o._initial!==!1){const d=o._initial?_:e.getCachedData(t,a);if(d!=null)return Promise.resolve(d)}n.pending.value=!0,n.status.value="pending";const y=new Promise((d,c)=>{try{d(h(a))}catch(S){c(S)}}).then(async d=>{if(y.cancelled)return a._asyncDataPromises[t];let c=d;e.transform&&(c=await e.transform(d)),e.pick&&(c=ia(c,e.pick)),a.payload.data[t]=c,n.data.value=c,n.error.value=p.errorValue,n.status.value="success"}).catch(d=>{if(y.cancelled)return a._asyncDataPromises[t];n.error.value=x(d),n.data.value=m(e.default()),n.status.value="error"}).finally(()=>{y.cancelled||(n.pending.value=!1,delete a._asyncDataPromises[t])});return a._asyncDataPromises[t]=y,a._asyncDataPromises[t]},n.clear=()=>ra(a,t);const v=()=>n.refresh({_initial:!0}),i=e.server!==!1&&a.payload.serverRendered;{const o=V();if(o&&!o._nuxtOnBeforeMountCbs){o._nuxtOnBeforeMountCbs=[];const c=o._nuxtOnBeforeMountCbs;M(()=>{c.forEach(S=>{S()}),c.splice(0,c.length)}),N(()=>c.splice(0,c.length))}i&&a.isHydrating&&(n.error.value||_!=null)?(n.pending.value=!1,n.status.value=n.error.value?"error":"success"):o&&(a.payload.serverRendered&&a.isHydrating||e.lazy)&&e.immediate?o._nuxtOnBeforeMountCbs.push(v):e.immediate&&v();const y=H();if(e.watch){const c=O(e.watch,()=>n.refresh());y&&B(c)}const d=a.hook("app:data:refresh",async c=>{(!c||c.includes(t))&&await n.refresh()});y&&B(d)}const l=Promise.resolve(a._asyncDataPromises[t]).then(()=>n);return Object.assign(l,n),l}function ra(s,r){r in s.payload.data&&(s.payload.data[r]=void 0),r in s.payload._errors&&(s.payload._errors[r]=p.errorValue),s._asyncData[r]&&(s._asyncData[r].data.value=void 0,s._asyncData[r].error.value=p.errorValue,s._asyncData[r].pending.value=!1,s._asyncData[r].status.value="idle"),r in s._asyncDataPromises&&(s._asyncDataPromises[r]&&(s._asyncDataPromises[r].cancelled=!0),s._asyncDataPromises[r]=void 0)}function ia(s,r){const t={};for(const f of r)t[f]=s[f];return t}function oa(s){return U(()=>{var t;const r=(t=V())==null?void 0:t.appContext.app.$nuxt;return r?r.runWithContext(s):s()})}const ca={class:"hand-statistic-widget"},R=3e4,pa=W({__name:"widget",async setup(s){let r,t;z(i=>({"52be3914":m(b)}));const{$formatter:f}=T(),e=$();j({title:()=>f.route.getTitle(P.toString(e.name)??"")});const a=q({tanks:[],accountId:P.toNumber(e.query.accountId)??0,metricsOpacity:P.toNumber(e.query.opacity)??1,metricsWidth:P.toNumber(e.query.width)??0,hasAnimateStartClass:!1}),h=C([{key:"battles",label:f.stat.accountProp("battles"),value:0},{key:"winRate",label:f.stat.accountProp("winRate"),value:0},{key:"damagePerBattle",label:f.stat.accountProp("damagePerBattle"),value:0}]),g=ea(),b=A(()=>R+"ms");[r,t]=oa(async()=>na("get-tanks-vehicles",async()=>await g.getTanksVehicles().then(()=>!0))),await r,t();function _(){var l;let i={};a.tanks.forEach(u=>{i=D.sum(i,u.stat)}),(l=h.value)==null||l.forEach(u=>{u.key==="winRate"?u.value=D.winRate(i):u.key==="damagePerBattle"?u.value=D.damagePerBattle(i):u.value=i.battles??0})}function w(i){return{...i,battles:(i.losses||0)+(i.wins||0),winRate:D.winRate(i),damagePerBattle:D.damagePerBattle(i)}}function n(i){const l={...i.tank,stat:i.stat};return l.stat=w(l.stat),l.lastUpdateTime=i.lastUpdateTime,l}async function v(){a.hasAnimateStartClass=!1;const{data:i}=await Q.handStat.tanks.get(a.accountId);a.tanks=[],i.raw.forEach(l=>{var o;const u=(o=g.vehicles)==null?void 0:o[l.tankId];u&&a.tanks.push(n({tank:u,stat:l.stat,lastUpdateTime:l.lastBattleTime}))}),_(),a.hasAnimateStartClass=!0}return K(async()=>{if(!a.accountId)return L().add({type:"warning",message:"ID пользователя не определён"});await v(),ta(v,R)}),(i,l)=>{const u=k;return aa(),F("div",ca,[G("div",{class:X(["hand-statistic-widget__line",[m(a).hasAnimateStartClass?"hand-statistic-widget__line--animate":""]]),style:Y({width:m(a).metricsWidth?m(a).metricsWidth+"px":"auto"})},null,6),Z(u,{modelValue:m(h),"onUpdate:modelValue":l[0]||(l[0]=o=>J(h)?h.value=o:null),opacity:m(a).metricsOpacity,width:m(a).metricsWidth},null,8,["modelValue","opacity","width"])])}}});export{pa as default};
