import{_ as V}from"./nuxt-link.DCTOZAmW.js";import{_ as q}from"./WinRate.vue.BrT36txa.js";import{_ as W}from"./RatingIcon.vue.Pcf7PSx8.js";import{h as v,_ as H,a as M}from"./disableScroll.CgQQwGmz.js";import{_ as F}from"./TablePagination.vue.BYUKzAdv.js";import{_ as G}from"./CTable.vue.kkPfnMTH.js";import{s as g,a as R,_ as J}from"./request.BjF5k-df.js";import{f as K,u as Q,n as S,q as U,i as X,c as d,b as p,w as o,k as B,a as x,s as Y,o as c,j as k,d as T,t as f}from"./entry.DxBPLwvI.js";import{n as A}from"./notEmpty.BxBPJGBn.js";import{s as I}from"./index.g9WcmtCy.js";const Z={class:"account-tracked"},tt=x("div",{class:"account-tracked__description content-area",style:{"max-width":"800px"}},[x("p",null,"Список игроков, статистика которых отслеживается. Данные хранятся в браузере."),x("p",null," Отслеживание начинается с момента просмотра аккаунта на данном ресурсе. После удаления из списка - отслеживание прекращается. ")],-1),at={key:1},nt={key:0},et={key:1},ct={key:1},it={key:1},ot={key:0},st={key:1},lt={key:1},bt=K({__name:"tracked",setup(dt){Q({title:"Отслеживаемые / Аккаунты"});const e=S({loading:0,items:[],accountsLocal:null}),m=S({total:0,page:1,pageSize:100}),$=[{key:"nickname",label:"Ник"},{key:"clan",label:"Клан"},{key:"battles",label:"Боёв"},{key:"winRate",label:"Побед"},{key:"damagePerBattle",label:"Урон"},{key:"rating",label:"Рейтинг"},{key:"lastBattleTime",width:160,label:"Последний бой",formatter:t=>typeof t=="number"?Y.date.toRelativeTime(t*1e3):"---"},{key:"actions",width:60}];U(()=>{w()});const D=X(()=>{const t=m.page*m.pageSize,n=t-m.pageSize;return(e.accountsLocal??[]).filter(A).slice(n,t)});async function L(){e.loading++;try{const t=await g.indexedDB.accountsInfo.getAll();e.accountsLocal=(t??[]).map(n=>n.data).sort((n,r)=>r.last_battle_time-n.last_battle_time),m.total=(t==null?void 0:t.length)??0}catch(t){v(t,{title:"Ошибка поучения локального списка аккаунтов"})}e.loading--}async function P(t){e.loading++;try{const n=await R.account.getInfo({extra:"statistics.rating",account_id:t.join(",")});return Object.values(n.data).filter(A)}catch(n){return v(n,{title:"Ошибка поучения списка аккаунтов"}),[]}finally{e.loading--}}async function N(t){e.loading++;try{const{data:n}=await R.clan.getAccountInfo({extra:"clan",account_id:t.join(",")});return Object.values(n).filter(A)}catch(n){return v(n,{title:"Ошибка поучения списка клановых аккаунтов"}),[]}finally{e.loading--}}async function w(){var t;e.accountsLocal||await L(),(t=e.accountsLocal)!=null&&t.length&&await C()}function j(t,n){const r=D.value.map(l=>{const s=t.find(_=>_.account_id===l.account_id);if(!s)return{id:l.account_id,nickname:l.nickname,lastBattleTime:NaN,isDeleted:!0,statistic:null,clan:null};const u=s.statistics,y=I.accountAll(u.all),h=u.rating?I.accountRating(u.rating):null,{clan:b}=n.find(_=>(_==null?void 0:_.account_id)===s.account_id)??{};return{id:s.account_id,nickname:s.nickname,lastBattleTime:s.last_battle_time,statistic:{all:y,rating:h},clan:b??null}});e.items=r.sort((l,s)=>s.lastBattleTime-l.lastBattleTime)}async function C(){const t=D.value.map(l=>l.account_id);if(!t.length)return;const[n,r]=await Promise.all([P(t),N(t)]);j(n,r)}async function E(t){await Promise.all([g.indexedDB.accountsInfo.remove(t),g.indexedDB.accountsAchievements.remove(t),g.indexedDB.tanksStat.remove(t)])}async function z(t){await E(t),e.items.length<m.total?e.items=e.items.filter(n=>n.id!==t):await w()}async function O(){await C()}return(t,n)=>{const r=V,l=q,s=W,u=H,y=M,h=F,b=G,_=J;return c(),d("div",Z,[tt,p(b,{"no-wrap":"","scroll-to-top":"","scroll-auto-disabling":"",headers:$,data:B(e).items,height:"calc(100vh - 112px)"},{nickname:o(({row:a})=>[a.isDeleted?(c(),d("span",at,f(a.nickname),1)):(c(),k(r,{key:0,class:"account-tracked__link link",to:{name:"account-id",params:{id:a.id}}},{default:o(()=>[T(f(a.nickname),1)]),_:2},1032,["to"]))]),battles:o(({row:a})=>{var i;return[a.isDeleted?(c(),d("span",et,"---")):(c(),d("span",nt,f((i=a.statistic)==null?void 0:i.all.battles),1))]}),winRate:o(({row:a})=>{var i;return[a.isDeleted?(c(),d("span",ct,"---")):(c(),k(l,{key:0,"model-value":(i=a.statistic)==null?void 0:i.all.winRate,class:"account-tracked__win-rate"},null,8,["model-value"]))]}),rating:o(({row:a})=>{var i;return[a.isDeleted?(c(),d("span",it,"---")):(c(),k(s,{key:0,rating:(i=a.statistic)==null?void 0:i.rating},null,8,["rating"]))]}),damagePerBattle:o(({row:a})=>{var i;return[a.isDeleted?(c(),d("span",st,"---")):(c(),d("span",ot,f((i=a.statistic)==null?void 0:i.all.damagePerBattle),1))]}),clan:o(({row:a})=>[a.clan?(c(),k(r,{key:0,title:a.clan.name,class:"account-tracked__link link",to:{name:"clan-id",params:{id:a.clan.clan_id}}},{default:o(()=>[T(f(a.clan.tag),1)]),_:2},1032,["title","to"])):(c(),d("span",lt,"---"))]),actions:o(({row:a})=>[p(y,{title:"Удалить","is-text":"","is-square":"",onClick:i=>z(a.id)},{default:o(()=>[p(u,{name:"delete"})]),_:2},1032,["onClick"])]),footer:o(()=>[p(h,{pagination:B(m),onChange:O},null,8,["pagination"])]),_:1},8,["data"]),p(_,{loading:B(e).loading>0},null,8,["loading"])])}}});export{bt as default};
